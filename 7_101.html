<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#ffffff">
<title>我的珍藏 - 全屏透明版</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<style>
    :root {
        --active-color: #333; --bg-color: #f5f5f5; --card-bg: #fff;
        --text-main: #333; --text-sub: #999; 
        --nav-height: 50px; 
        
        /* 底部依然使用变量，但顶部栏现在强制透明，不再使用 --top-bar-bg */
        --bottom-bar-bg: #fff;
        --post-card-bg: #fff; 
        
        --safe-top: 15px; 
        --safe-bottom: env(safe-area-inset-bottom, 0px);
    }
    
    html, body { width: 100%; height: 100%; overflow: hidden; -webkit-text-size-adjust: 100%; }
    * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
    
    body { 
        font-size: 13.5px; 
        font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", "Helvetica Neue", Arial, sans-serif !important; 
        background-color: transparent; color: var(--text-main); 
        -webkit-user-select: none; user-select: none; line-height: 1.5; 
    }
    
    #global-bg-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -999; background-color: var(--bg-color); background-size: cover; background-position: center; pointer-events: none; }
    
    /* 视图系统 */
    .view-container { position: relative; width: 100%; height: 100%; overflow: hidden; }
    .view { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow-y: auto; overflow-x: hidden; background: transparent; display: none; padding-bottom: calc(60px + var(--safe-bottom)); opacity: 0; transition: opacity 0.2s ease; z-index: 10; }
    .view.active { display: block; opacity: 1; }
    
    #view-editor, #view-collection-create { background: #fff; padding-bottom: 0; z-index: 2000; display: none; flex-direction: column; height: 100%; }
    #view-editor.active, #view-collection-create.active { display: flex; opacity: 1; }
    #view-html-detail { background: #fff; padding: 0; margin: 0; z-index: 3000; display: none; width: 100%; height: 100%; overflow-y: auto; }
    #view-html-detail.active { display: block; }
    #view-collection-detail { background: transparent; padding-bottom: 0; z-index: 2000; }
    #view-html-home { background: transparent; padding-top: calc(40px + var(--safe-top)); }
    
    #view-detail { 
        background: var(--post-card-bg); background-size: cover; background-position: center; 
        background-repeat: no-repeat; background-attachment: scroll; 
        padding-bottom: 80px; z-index: 2000; transition: background-image 0.3s; width: 100%; 
    }

    /* 通用组件 */
    .icon { width: 22px; height: 22px; fill: none; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }
    .hidden-input { display: none; }
    .loading-mask { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index: 9999; display:none; flex-direction:column; justify-content:center; align-items:center; color:#333; font-weight:bold; }
    .loading-spinner { width: 36px; height: 36px; border: 3px solid #f3f3f3; border-top: 3px solid var(--active-color); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    #scroll-sentinel { height: 20px; width: 100%; opacity: 0; pointer-events: none; }
    
    .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 4000; display: none; align-items: center; justify-content: center; }
    .context-menu { background: #fff; width: 80%; border-radius: 12px; overflow: hidden; animation: popUp 0.2s ease-out; max-height: 80vh; overflow-y: auto; }
    .menu-item { padding: 14px; text-align: center; border-bottom: 1px solid #eee; font-size: 14px; color: #333; display: flex; justify-content: center; align-items: center; position: relative; }
    .menu-item.danger { color: #ff4d4f; }
    .menu-item.active { color: var(--active-color); font-weight: bold; background: #f7f7f7; }
    .menu-section-title { background: #f9f9f9; color: #999; font-size: 11px; padding: 8px 15px; font-weight: bold; text-align: left; border-bottom: 1px solid #eee; }
    @keyframes popUp { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

    .image-viewer-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 5000; display: none; flex-direction: column; justify-content: center; align-items: center; animation: fadeIn 0.2s ease; }
    .iv-img-wrapper { width: 100%; height: 80%; display: flex; justify-content: center; align-items: center; }
    .iv-img-wrapper img { max-width: 100%; max-height: 100%; object-fit: contain; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
    .iv-controls { position: absolute; bottom: calc(40px + var(--safe-bottom)); display: flex; gap: 20px; }
    .iv-btn { background: rgba(255,255,255,0.2); color: #fff; padding: 8px 20px; border-radius: 30px; border: 1px solid rgba(255,255,255,0.3); backdrop-filter: blur(10px); cursor: pointer; font-size: 13px; font-weight: bold; display: flex; align-items: center; gap: 5px; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* 底部导航 (应用底部背景) */
    .bottom-bar { 
        position: fixed; bottom: 0; left: 0; width: 100%; 
        height: calc(var(--nav-height) + var(--safe-bottom)); 
        padding-bottom: var(--safe-bottom); 
        background: var(--bottom-bar-bg); 
        background-size: cover; background-position: center; 
        backdrop-filter: blur(10px); 
        border-top: 1px solid rgba(0,0,0,0.05); 
        display: flex; justify-content: space-around; align-items: center; 
        z-index: 1000; transition: transform 0.3s ease; 
    }
    .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; color: #999; width: 20%; height: 100%; cursor: pointer; }
    .nav-item.active { color: var(--text-main); }
    .custom-nav-icon { width: 24px; height: 24px; border-radius: 6px; object-fit: cover; margin-bottom: 2px; }
    .nav-icon-plus { background: transparent; color: var(--text-main); width: 36px; height: 100%; display: flex; align-items: center; justify-content: center; box-shadow: none; border-radius: 0; }
    .nav-icon-plus svg { width: 28px; height: 28px; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; fill: none; }

    .batch-bar { position: fixed; bottom: 0; left: 0; width: 100%; height: calc(50px + var(--safe-bottom)); padding-bottom: var(--safe-bottom); background: #fff; display: none; justify-content: space-around; align-items: center; z-index: 2100; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); border-top: 1px solid #eee; }
    body.batch-mode .batch-bar { display: flex; animation: slideUp 0.3s ease; }
    body.batch-mode .bottom-bar { display: none; }
    body.batch-mode .post-card { transform: scale(0.95); opacity: 0.8; cursor: pointer; transition: all 0.2s; }
    body.batch-mode .post-card.selected { transform: scale(1); opacity: 1; box-shadow: 0 0 0 3px var(--active-color); }
    body.batch-mode .post-card.selected::after { content: '✓'; position: absolute; top: 10px; right: 10px; background: var(--active-color); color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight:bold; z-index: 5; }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

    /* Home Header (全透明修改) */
    .home-header { 
        position: sticky; top: 0; z-index: 50; 
        background: transparent;  /* 强制透明 */
        backdrop-filter: none;    /* 去掉磨砂 */
        box-shadow: none;         /* 去掉阴影 */
        padding: calc(8px + var(--safe-top)) 15px 8px 15px; 
        display: flex; justify-content: space-between; align-items: center; 
    }
    /* 搜索框保留微弱背景，防止看不见 */
    .search-box { 
        background: rgba(255,255,255, 0.3); 
        border-radius: 18px; padding: 5px 12px; display: flex; align-items: center; flex: 1; margin-right: 10px; 
        backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.2); 
    }
    .search-box input { border: none; background: transparent; font-size: 13px; width: 100%; color: #333; }
    
    .posts-container { padding: 12px; transition: all 0.3s ease; min-height: 300px; display: block; }

    /* 瀑布流双列布局系统 */
    .waterfall-container { display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; }
    .waterfall-col { flex: 1; width: 48%; display: flex; flex-direction: column; gap: 10px; }

    /* 卡片 */
    .post-card { 
        background: var(--post-card-bg); 
        background-size: cover; background-position: center; background-repeat: no-repeat; background-attachment: scroll !important; 
        border-radius: 10px; overflow: hidden; box-shadow: 0 1px 2px rgba(0,0,0,0.05); 
        position: relative; transition: transform 0.1s; 
        content-visibility: auto; contain-intrinsic-size: 300px; width: 100%; 
    }
    .post-card:active { transform: scale(0.98); }
    .post-header { display: flex; align-items: center; justify-content: space-between; padding: 10px 12px 6px; }
    .post-date { display: flex; align-items: baseline; gap: 4px; }
    .date-day { font-size: 20px; font-weight: 600; color: #333; line-height: 1; }
    .date-info { font-size: 11px; color: #999; }
    .post-content-wrap { padding: 8px 12px 12px; }
    .post-title { font-size: 15px; font-weight: 600; color: #333; line-height: 1.4; margin-bottom: 6px; }
    .post-text { font-size: 13px; color: #555; line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;}
    .pin-mark { position: absolute; top: 8px; right: 10px; width: 16px; height: 16px; display: none; z-index: 5; color: #666; }
    .pin-mark svg { width: 100%; height: 100%; fill: none; stroke: currentColor; stroke-width: 3; stroke-linecap: round; stroke-linejoin: round; }
    .is-top .pin-mark { display: block; }
    
    /* 模式区分 */
    .posts-container.mode-list .post-card { margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.03); }
    .posts-container.mode-list .post-img-grid { display: grid; gap: 4px; padding: 0 12px; }
    .posts-container.mode-list .post-img-item { width: 100%; aspect-ratio: 4/3; overflow: hidden; border-radius: 4px; position: relative; }
    .posts-container.mode-list .post-img-item img { width: 100%; height: 100%; object-fit: cover; display: block; }
    
    /* Grid 模式下图片 1:1 强制 */
    .post-img-grid img { width: 100%; height: auto; display: block; aspect-ratio: 1/1; object-fit: cover; }

    .img-count-badge { position: absolute; bottom: 5px; right: 5px; background: rgba(0,0,0,0.6); color: #fff; font-size: 10px; padding: 2px 6px; border-radius: 10px; display: flex; align-items: center; gap: 3px; pointer-events: none; }
    
    .timeline-wrapper { display: none; padding: 0 14px; }
    .month-section { margin-bottom: 20px; content-visibility: auto; contain-intrinsic-size: 500px; }
    .month-header { display: flex; justify-content: space-between; align-items: baseline; padding: 10px 0 10px; border-bottom: 1px dashed #eee; margin-bottom: 10px; }
    .month-left { display: flex; align-items: baseline; gap: 5px; }
    .month-num { font-size: 22px; font-weight: bold; color: #333; }
    .year-num { font-size: 13px; color: #999; }
    .post-count-badge { background: #f0f0f0; color: #999; font-size: 10px; padding: 2px 8px; border-radius: 10px; }
    .grid-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 3px; }
    .grid-item { aspect-ratio: 1 / 1; background: #f7f7f7; border-radius: 4px; overflow: hidden; position: relative; cursor: pointer; }
    .grid-item img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s; }
    .grid-item:active img { transform: scale(0.95); }
    .text-card { width: 100%; height: 100%; background: #fff; padding: 8px; display: flex; align-items: flex-start; border: 1px solid #f0f0f0; border-radius: 4px; }
    .text-content-sm { font-size: 11px; line-height: 1.4; color: #666; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 6; -webkit-box-orient: vertical; width: 100%; word-break: break-all; }

    .editor-header { display: flex; justify-content: space-between; align-items: center; padding: calc(8px + var(--safe-top)) 15px 8px 15px; height: calc(46px + var(--safe-top)); background: #fff; flex-shrink: 0; }
    .editor-content { padding: 15px; overflow-y: auto; flex: 1; position: relative;}
    .editor-gallery { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px; }
    .editor-img-item { width: 90px; height: 90px; position: relative; border-radius: 8px; overflow: hidden; }
    .editor-img-item img { width: 100%; height: 100%; object-fit: cover; }
    .editor-img-remove { position: absolute; top: 4px; right: 4px; background: rgba(0,0,0,0.5); color: #fff; width: 18px; height: 18px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 12px; cursor: pointer; }
    .image-upload-area { width: 90px; height: 90px; background: #f7f7f7; border-radius: 8px; border: 1px dashed #e0e0e0; display: flex; flex-direction: column; justify-content: center; align-items: center; color: #ccc; cursor: pointer; }
    .col-create-cover { width: 100px; height: 100px; background: #f7f7f7; border-radius: 10px; margin: 25px auto; display: flex; justify-content: center; align-items: center; cursor: pointer; border: 1px dashed #ccc; overflow: hidden; }
    .col-create-cover img { width: 100%; height: 100%; object-fit: cover; display: none; }
    .editor-input-group { position: relative; }
    .editor-input-group input { width: 100%; border: none; font-size: 16px; padding: 10px 0; border-bottom: 1px solid #eee; margin-bottom: 15px; }
    .editor-input-group textarea {width: 100%; min-height: 300px; border: none; resize: none; font-size: 14px; line-height: 1.6; color: #555; font-family: inherit; }
    .editor-tools-bottom { padding: 10px 15px; padding-bottom: calc(10px + var(--safe-bottom)); border-top: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background: #fff; flex-shrink: 0; }
    .et-left { display: flex; gap: 15px; align-items: center; }
    .col-pill-btn { display: flex; align-items: center; gap: 5px; background: #f2f2f2; color: #666; padding: 6px 12px; border-radius: 18px; font-size: 12px; font-weight: 500; cursor: pointer; transition: all 0.2s; }
    .col-pill-btn.active { background: #333; color: #fff; }
    .col-pill-remove { display: none; width: 14px; height: 14px; background: rgba(255,255,255,0.3); border-radius: 50%; align-items: center; justify-content: center; font-size: 10px; color: #fff; }
    .col-pill-btn.active .col-pill-remove { display: flex; }
    .bg-tool-btn { width: 32px; height: 32px; border-radius: 50%; display: flex; justify-content: center; align-items: center; background: #fff; color: #666; cursor: pointer; }
    .bg-tool-btn.has-bg { background: #333; color: #fff; }
    .word-count-tip { position: fixed; right: 20px; bottom: 80px; font-size: 12px; color: #ccc; pointer-events: none; transition: opacity 0.3s; opacity: 0; }
    .word-count-tip.show { opacity: 1; }

    /* 详情页头部 (全透明修改) */
    .detail-nav { 
        display: flex; align-items: center; justify-content: space-between; 
        padding: calc(10px + var(--safe-top)) 15px 10px 15px; 
        position: sticky; top: 0; 
        background: transparent;   /* 强制透明 */
        backdrop-filter: none;     /* 去掉磨砂 */
        z-index: 50; 
    }
    .d-user-info { display: flex; align-items: center; }
    .d-avatar { width: 30px; height: 30px; border-radius: 50%; margin-right: 8px; background: #eee; }
    .detail-body { padding-bottom: 70px; background: transparent; }
    .d-slider-container { position: relative; width: 100%; overflow: hidden; background: #000; }
    .d-slider { display: flex; overflow-x: auto; scroll-snap-type: x mandatory; -webkit-overflow-scrolling: touch; scrollbar-width: none; scroll-behavior: smooth; }
    .d-slider::-webkit-scrollbar { display: none; }
    .d-slider-item { flex: 0 0 100%; width: 100%; scroll-snap-align: center; scroll-snap-stop: always; display: flex; justify-content: center; align-items: center; background: #000; min-height: 250px; }
    .d-slider-item img { max-width: 100%; max-height: 80vh; object-fit: contain; display: block; }
    .d-slider-indicator { position: absolute; top: 15px; right: 15px; background: rgba(0,0,0,0.5); color: #fff; padding: 3px 8px; border-radius: 10px; font-size: 11px; font-weight: bold; pointer-events: none; }
    .d-content { padding: 10px 20px; font-size: 15px; line-height: 1.8; color: #333; white-space: pre-wrap; }
    .d-content.text-mode { font-size: 16px; line-height: 1.8; letter-spacing: 0.5px; text-align: left; padding: 15px; }
    .d-meta { padding: 8px 20px; font-size: 11px; color: #bbb; display: flex; justify-content: space-between; margin-bottom: 15px; }
    .divider { height: 1px; background: #f0f0f0; margin: 0 20px; }
    .comments-section { padding: 15px; background: transparent; }
    .comment-item { display: flex; margin-bottom: 20px; }
    .c-avatar { width: 32px; height: 32px; border-radius: 50%; margin-right: 10px; background: #f0f0f0; }
    .c-right { flex: 1; }
    .c-top { display: flex; justify-content: space-between; margin-bottom: 3px; font-size: 12px; color: #999; }
    .c-text { font-size: 13.5px; line-height: 1.5; color: #333; }
    .c-date { font-size: 11px; color: #ccc; margin-top: 4px; }
    
    /* 评论输入栏 (应用底部背景) */
    .input-bar { 
        position: fixed; bottom: 0; left: 0; width: 100%; 
        background: var(--bottom-bar-bg); 
        background-size: cover; background-position: center;
        backdrop-filter: blur(10px);
        box-shadow: 0 -1px 3px rgba(0,0,0,0.05); 
        padding: 6px 15px; padding-bottom: calc(6px + var(--safe-bottom)); 
        display: flex; align-items: center; z-index: 3002; 
    }
    .input-bar input { flex: 1; background: rgba(255,255,255,0.7); backdrop-filter: blur(5px); border-radius: 18px; padding: 8px 15px; border: 1px solid rgba(0,0,0,0.1); font-size: 13px; margin-right: 10px; }
    .send-btn { color: #333; font-weight: bold; padding: 5px 10px; cursor: pointer; font-size: 13px; }
    .static-input-bar { margin: 0; background: transparent; padding: 10px 20px; display: flex; align-items: center; }
    .static-input-bar input { flex: 1; background: rgba(255,255,255,0.8); border-radius: 20px; padding: 10px 15px; border: 1px solid rgba(0,0,0,0.1); font-size: 13px; margin-right: 10px; backdrop-filter: blur(5px); }
    
    /* 阅读工具栏 (应用底部背景) */
    .reading-toolbar-bottom { 
        position: fixed; bottom: 0; left: 0; width: 100%; height: calc(50px + var(--safe-bottom)); 
        padding-bottom: var(--safe-bottom); 
        background: var(--bottom-bar-bg); 
        background-size: cover; background-position: center;
        backdrop-filter: blur(10px); 
        border-top: 1px solid #eee; display: none; justify-content: space-between; align-items: center; padding-left: 10px; padding-right: 10px; z-index: 3005; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); 
    }
    .rt-btn { flex: 1; text-align: center; color: #333; font-size: 13px; font-weight: 500; cursor: pointer; padding: 10px; }
    .rt-btn:active { opacity: 0.6; }
    .rt-btn.disabled { color: #ccc; pointer-events: none; }
    
    .dir-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 4000; display: none; flex-direction: column; justify-content: flex-end; }
    .dir-panel { background: #fff; width: 100%; height: 70vh; border-radius: 16px 16px 0 0; display: flex; flex-direction: column; animation: slideUpDir 0.3s ease; padding-bottom: var(--safe-bottom); }
    .dir-header { padding: 12px; text-align: center; font-weight: bold; border-bottom: 1px solid #eee; font-size: 15px; position: relative;}
    .dir-close { position: absolute; right: 15px; top: 12px; color: #999; cursor: pointer; }
    .dir-list { flex: 1; overflow-y: auto; padding: 10px 0; }
    .dir-item { padding: 12px 20px; font-size: 13px; color: #333; border-bottom: 1px solid #f9f9f9; display: flex; justify-content: space-between; }
    .dir-item.active { color: var(--text-main); font-weight: bold; background: #f5f5f5; }
    .dir-item.active::after { content: '当前'; font-size: 11px; color: #999; font-weight: normal;}
    @keyframes slideUpDir { from { transform: translateY(100%); } to { transform: translateY(0); } }

    .post-html-preview { width: 100%; padding-top: 100%; height: 0; position: relative; background: #fff; overflow: hidden; }
    .post-html-preview iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; pointer-events: none; background: #fff; }

    .html-fab-add { position: fixed; bottom: calc(70px + var(--safe-bottom)); right: 20px; width: 50px; height: 50px; background: #fff; color: #333; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 2200; cursor: pointer; transition: transform 0.2s; }
    .html-fab-add:active { transform: scale(0.95); }
    .html-fab-add svg { width: 24px; height: 24px; stroke: currentColor; stroke-width: 2; }
    .html-center-back-btn { width: 44px; height: 44px; border-radius: 50%; background: #fff; box-shadow: 0 4px 12px rgba(0,0,0,0.08); border: 1px solid rgba(0,0,0,0.02); display: flex; align-items: center; justify-content: center; cursor: pointer; margin: 30px auto 20px auto; }
    .html-center-back-btn svg { width: 20px; height: 20px; stroke: #333; stroke-width: 2.5; fill: none; }
    .html-footer-section { padding: 0 20px 80px 20px; }
    .html-comment-input-line { display: flex; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 8px; margin-bottom: 20px; }
    .html-comment-input-line input { flex: 1; border: none; font-size: 14px; background: transparent; padding: 5px 0; }
    .html-comment-send { font-size: 14px; font-weight: bold; color: #333; cursor: pointer; padding: 5px; }
    .html-comments-title { font-size: 15px; font-weight: bold; margin-bottom: 15px; color: #333; }
    .html-comment-list-simple { min-height: 50px; }

    .col-item { display: flex; padding: 12px; background: #fff; border-radius: 10px; margin: 12px; align-items: center; box-shadow: 0 1px 2px rgba(0,0,0,0.05); cursor: pointer; }
    .col-cover { width: 70px; height: 70px; border-radius: 10px; background: #eee; object-fit: cover; margin-right: 12px; }
    .col-info { flex: 1; }
    .col-title { font-size: 15px; font-weight: bold; color: #333; margin-bottom: 4px; }
    .col-desc { font-size: 12px; color: #999; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .cd-header { position: relative; height: 260px; overflow: hidden; color: #fff; display: flex; flex-direction: column; padding-top: var(--safe-top); }
    .cd-bg-layer { position: absolute; top:0; left:0; width:100%; height:100%; background-size: cover; background-position: center; filter: blur(20px) brightness(0.8); transform: scale(1.2); z-index: 1; }
    .cd-navbar { position: relative; z-index: 10; display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; height: 44px; }
    .cd-info-area { position: relative; z-index: 10; flex: 1; display: flex; flex-direction: column; padding: 0 20px 20px; }
    .cd-info-top { display: flex; gap: 15px; align-items: flex-start; margin-bottom: 15px; }
    .cd-cover { width: 90px; height: 90px; border-radius: 10px; object-fit: cover; background: #fff; flex-shrink: 0; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
    .cd-text { flex: 1; padding-top: 5px; }
    .cd-title { font-size: 18px; font-weight: bold; margin-bottom: 6px; text-shadow: 0 1px 2px rgba(0,0,0,0.3); }
    .cd-meta { font-size: 11px; opacity: 0.9; display: flex; align-items: center; gap: 5px; text-shadow: 0 1px 2px rgba(0,0,0,0.3); }
    .cd-user-avatar { width: 14px; height: 14px; border-radius: 50%; }
    .cd-stats { display: flex; justify-content: space-between; text-align: center; padding: 0 10px; }
    .cd-stat-item { flex: 1; }
    .cd-stat-num { font-size: 15px; font-weight: bold; display: block; outline: 1px dashed transparent; }
    .cd-stat-num:focus { outline: 1px dashed rgba(255,255,255,0.5); background: rgba(0,0,0,0.2); border-radius:4px; }
    .cd-stat-label { font-size: 10px; opacity: 0.7; margin-top: 4px; display: block; }
    .cd-body { position: relative; z-index: 20; background: transparent; border-radius: 16px 16px 0 0; margin-top: -16px; min-height: 500px; padding: 15px 10px 80px 10px; }
    .cd-footer { position: fixed; bottom: 0; left: 0; width: 100%; height: calc(60px + var(--safe-bottom)); padding-bottom: var(--safe-bottom); background: rgba(255,255,255,0.7); backdrop-filter: blur(10px); border-top: 1px solid rgba(255,255,255,0.3); z-index: 100; display: flex; align-items: center; justify-content: center; gap: 12px; padding: 0 20px; }
    .cd-btn { flex: 1; height: 40px; border-radius: 20px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 13px; }
    .cd-btn-sub { background: #f0f0f0; color: #333; cursor: pointer;}
    .cd-btn-read { background: #333; color: #fff; cursor: pointer; }

    .profile-card { background: transparent; box-shadow: none; margin-top: -30px; border-radius: 16px 16px 0 0; position: relative; z-index: 5; padding-bottom: 20px; min-height: 600px; }
    .header-bg { width: 100%; height: 240px; background-color: #ddd; background-size: cover; background-position: center; }
    .avatar-area { position: relative; height: 50px; display: flex; justify-content: center; }
    .avatar-wrapper { position: absolute; top: -40px; width: 80px; height: 80px; background: #fff; border-radius: 50%; padding: 3px; }
    .avatar-img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
    .user-info { text-align: center; margin-top: 5px; }
    .user-name { font-size: 18px; font-weight: bold; margin-bottom: 4px; outline: 1px dashed transparent; transition: outline 0.2s; }
    .user-name:focus, .editable-span:focus { outline: 1px dashed #333; background: rgba(0,0,0,0.02); }
    .user-meta { font-size: 11px; color: #999; }
    .editable-span { border-bottom: none; }
    .profile-tab-container { display: flex; border-bottom: 1px solid rgba(0,0,0,0.05); background: transparent; margin-top: 10px; }
    .p-tab { flex: 1; text-align: center; padding: 12px 0; font-weight: bold; color: #999; cursor: pointer; transition: color 0.2s; font-size: 14px; }
    .p-tab.active { color: #333; border-bottom: 2px solid #333; }
    .new-col-btn { margin: 15px; padding: 12px; background: #fff; border: 1px solid #eee; border-radius: 8px; text-align: center; color: #666; cursor: pointer; font-weight: bold; font-size: 13px;}

    .theme-page { padding: calc(15px + var(--safe-top)) 15px 15px 15px; background: transparent; min-height: 100vh; }
    .btn-white { display: flex; justify-content: space-between; width: 100%; background: #fff; border: 1px solid #e0e0e0; border-radius: 8px; padding: 12px; margin-bottom: 10px; font-size: 13px; cursor: pointer; }
    .theme-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px; }
    .theme-icon-box { background: #f9f9f9; border: 1px solid #eee; border-radius: 8px; padding: 12px; display: flex; flex-direction: column; align-items: center; cursor: pointer; }
    .theme-icon-box img { width: 28px; height: 28px; margin-bottom: 5px; object-fit: cover; }
    .theme-icon-box span { font-size: 11px; color: #666; }
</style>
</head>
<body>

<div id="global-bg-layer"></div>

<div class="loading-mask" id="loadingMask">
    <div class="loading-spinner"></div>
    <div id="loadingText">处理中...</div>
</div>

<div class="view-container">

    <!-- 1. 主页 -->
    <div id="view-home" class="view active">
        <div class="home-header" id="homeHeader">
            <div class="search-box">
                <svg class="icon" style="width:14px; height:14px; margin-right:5px; color:#666;" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                <input type="text" id="searchInput" placeholder="搜索..." oninput="HomeRenderer.resetAndRender()">
            </div>
            <button style="background:none; border:none; padding:5px; margin-right:5px;" onclick="HomeRenderer.showFilterMenu()">
                <svg class="icon" style="color:#333;" viewBox="0 0 24 24"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>
            </button>
            <button style="background:none; border:none; padding:5px;" onclick="HomeRenderer.toggleLayout()">
                <svg id="layout-icon" class="icon" style="color:#333;" viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
            </button>
        </div>
        <div id="posts-list" class="posts-container mode-grid"></div>
        <div id="timeline-list" class="timeline-wrapper"></div>
        <div id="scroll-sentinel"></div>
        <div id="empty-state" style="text-align:center; padding:50px; color:#999; display:none;">还没有内容<br><small>点击下方 + 号发布</small></div>
    </div>

    <!-- HTML 首页 -->
    <div id="view-html-home" class="view">
        <div id="html-posts-list" class="posts-container mode-grid"></div>
        <div id="html-empty-state" style="text-align:center; padding:50px; color:#999; display:none;">这里空空如也<br><small>点击右下角 + 创建HTML作品</small></div>
        <div class="html-fab-add" onclick="Editor.open(null, 'html')"><svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg></div>
    </div>

    <!-- 批量操作栏 -->
    <div class="batch-bar" id="batchBar">
        <div style="flex:1; text-align:center; color:#ff4d4f; font-weight:bold; cursor:pointer;" onclick="BatchMgr.deleteSelected()">批量删除</div>
        <div style="width:1px; height:20px; background:#eee;"></div>
        <div style="flex:1; text-align:center; color:#333; font-weight:bold; cursor:pointer;" onclick="BatchMgr.addToCollection()">加入合集</div>
        <div style="width:1px; height:20px; background:#eee;"></div>
        <div style="flex:1; text-align:center; color:#666; cursor:pointer;" onclick="BatchMgr.exit()">取消</div>
    </div>

    <!-- 2. 编辑器 -->
    <div id="view-editor" class="view">
        <div class="editor-header">
            <div onclick="Router.back()" style="font-size:14px; color:#666;">取消</div>
            <div style="font-weight:bold;">发布内容</div>
            <div onclick="Editor.publish()" style="font-size:14px; color:#333; font-weight:bold;">发布</div>
        </div>
        <div class="editor-content">
            <div class="editor-gallery" id="editor-gallery">
                <div id="img-upload-btn" class="image-upload-area" onclick="document.getElementById('post-img-input').click()">
                    <svg class="icon" viewBox="0 0 24 24" style="stroke:#ccc;"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
                    <span style="font-size:11px; margin-top:5px;">添加图片</span>
                </div>
            </div>
            <input type="file" id="post-img-input" class="hidden-input" accept="image/*" multiple onchange="Editor.handleImages(this)">
            
            <div class="editor-input-group">
                <input type="text" id="post-title" placeholder="加个标题...">
                <textarea id="post-content" placeholder="记录这一刻..." oninput="Editor.updateWordCount()"></textarea>
                <div id="word-count-display" class="word-count-tip">0 字</div>
            </div>
        </div>
        <div class="editor-tools-bottom">
            <div class="et-left">
                <div class="col-pill-btn" id="editor-col-btn" onclick="Editor.openColPicker()">
                    <span id="editor-col-text">+ 加入合集</span>
                    <div class="col-pill-remove" style="display:none;" onclick="Editor.removeCollection(event)">×</div>
                </div>
            </div>
            <div class="et-right">
                <div class="bg-tool-btn" id="editor-bg-btn" onclick="document.getElementById('post-bg-file').click()">
                    <svg class="icon" style="width:18px; height:18px;" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
                </div>
                <input type="file" id="post-bg-file" class="hidden-input" accept="image/*" onchange="Editor.handlePostBg(this)">
            </div>
        </div>
    </div>

    <!-- 3. 详情页 -->
    <div id="view-detail" class="view">
        <div class="detail-nav">
            <div onclick="Router.back()" style="cursor:pointer;"><svg class="icon" viewBox="0 0 24 24"><path d="M15 18l-6-6 6-6"/></svg></div>
            <div class="d-user-info"><img id="d-avatar-img" src="" class="d-avatar"><span id="d-username" style="font-size:13px; font-weight:500;"></span></div>
            <div onclick="ContextMenu.showDetailMenu(event, DetailRenderer.currentPostId)" style="cursor:pointer;">
                <svg class="icon" style="width:18px;" viewBox="0 0 24 24"><circle cx="12" cy="12" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="12" cy="19" r="1"/></svg>
            </div>
        </div>
        <div class="detail-body">
            <div id="d-body-content"></div>
            <div class="d-meta"><span id="d-date"></span></div>
            <div class="divider"></div>
            <div id="d-inline-input-area"></div>
            <div class="comments-section" id="d-comments-list"></div>
        </div>
        <div class="reading-toolbar-bottom" id="reading-toolbar">
            <div class="rt-btn" id="rt-prev" onclick="DetailRenderer.prevPost()">上一篇</div>
            <div class="rt-btn" onclick="DetailRenderer.showDirectory()">目录</div>
            <div class="rt-btn" id="rt-next" onclick="DetailRenderer.nextPost()">下一篇</div>
        </div>
        <div class="input-bar" id="float-input-bar">
            <input type="text" id="comment-input" placeholder="自言自语一下...">
            <div class="send-btn" onclick="DetailRenderer.addComment()">发送</div>
        </div>
    </div>

    <!-- 目录 -->
    <div class="dir-overlay" id="dir-overlay" onclick="document.getElementById('dir-overlay').style.display='none'">
        <div class="dir-panel" onclick="event.stopPropagation()">
            <div class="dir-header">合集目录<div class="dir-close" onclick="document.getElementById('dir-overlay').style.display='none'">×</div></div>
            <div class="dir-list" id="dir-list-container"></div>
        </div>
    </div>

    <!-- HTML 详情页 -->
    <div id="view-html-detail" class="view">
        <div id="html-iframe-wrapper" style="width:100%; min-height:100px;">
            <iframe id="html-detail-iframe" scrolling="no" style="width:100%; height:0; border:none; display:block; background:#fff; overflow:hidden;"></iframe>
        </div>
        <div class="html-footer-section">
            <div class="html-center-back-btn" onclick="Router.back()"><svg viewBox="0 0 24 24"><path d="M15 18l-6-6 6-6"/></svg></div>
            <div class="html-comment-input-line">
                <input type="text" id="html-comment-input" placeholder="写评论...">
                <div class="html-comment-send" onclick="DetailRenderer.addHtmlComment()">发送</div>
            </div>
            <div class="html-comments-title">评论</div>
            <div id="html-comments-list-simple" class="html-comment-list-simple"></div>
        </div>
    </div>

    <!-- 创建合集 -->
    <div id="view-collection-create" class="view">
        <div class="editor-header">
            <div onclick="Router.back()" style="font-size:14px; color:#666;">取消</div>
            <div style="font-weight:bold;">编辑合集</div>
            <div onclick="ColMgr.save()" style="font-size:14px; color:#333; font-weight:bold;">完成</div>
        </div>
        <div class="editor-content" style="padding:20px;">
            <div class="col-create-cover" onclick="document.getElementById('col-cover-input').click()">
                <span id="col-cover-tip" style="color:#ccc;">+ 封面</span>
                <img id="col-cover-preview">
            </div>
            <input type="file" id="col-cover-input" class="hidden-input" accept="image/*" onchange="ColMgr.handleCover(this)">
            <div class="editor-input-group">
                <input type="text" id="col-title-input" placeholder="合集名称">
                <textarea id="col-desc-input" placeholder="写点简介..." style="min-height:100px;"></textarea>
            </div>
        </div>
    </div>

    <!-- 合集详情 -->
    <div id="view-collection-detail" class="view">
        <div class="cd-header">
            <div class="cd-bg-layer" id="cd-bg"></div>
            <div class="cd-navbar">
                <div onclick="ProfileRenderer.returnToCols()" style="color:#fff; cursor:pointer;"><svg class="icon" viewBox="0 0 24 24"><path d="M15 18l-6-6 6-6"/></svg></div>
                <div style="color:#fff; cursor:pointer;" onclick="ColDetailMgr.showMenu()"><svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="2"/><circle cx="12" cy="5" r="2"/><circle cx="12" cy="19" r="2"/></svg></div>
            </div>
            <div class="cd-info-area">
                <div class="cd-info-top">
                    <img id="cd-cover" class="cd-cover" src="">
                    <div class="cd-text">
                        <div class="cd-title" id="cd-title">合集标题</div>
                        <div class="cd-meta">
                            <img id="cd-avatar" class="cd-user-avatar">
                            <span id="cd-author">创建者</span>
                        </div>
                    </div>
                </div>
                <div class="cd-stats">
                    <div class="cd-stat-item"><span class="cd-stat-num" id="cd-stat-sub" contenteditable="true" onblur="ColDetailMgr.saveStat(this, 'sub')">0</span><span class="cd-stat-label">订阅数</span></div>
                    <div class="cd-stat-item"><span class="cd-stat-num" id="cd-stat-hot" contenteditable="true" onblur="ColDetailMgr.saveStat(this, 'hot')">0</span><span class="cd-stat-label">总热度</span></div>
                    <div class="cd-stat-item"><span class="cd-stat-num" id="cd-stat-view" contenteditable="true" onblur="ColDetailMgr.saveStat(this, 'view')">0</span><span class="cd-stat-label">浏览数</span></div>
                </div>
            </div>
        </div>
        <div class="cd-body">
            <div id="cd-post-list" class="posts-container mode-grid" style="padding:0; margin-top:15px;"></div>
            <div id="cd-empty" style="text-align:center; padding:50px; color:#ccc; display:none;">
                <svg width="50" height="50" viewBox="0 0 24 24" fill="none" stroke="#ddd" stroke-width="1"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>
                <div style="margin-top:10px; font-size:11px;">作者还在加油创作中</div>
            </div>
        </div>
        <div class="cd-footer">
            <div class="cd-btn cd-btn-sub" onclick="ColDetailMgr.toggleSubscribe(this)">订阅合集</div>
            <div class="cd-btn cd-btn-read" onclick="ColDetailMgr.startReading()">开始阅读</div>
        </div>
    </div>

    <!-- 个人主页 -->
    <div id="view-profile" class="view">
        <div class="header-bg" id="profileBg" onclick="document.getElementById('bgInput').click()">
            <input type="file" id="bgInput" class="hidden-input" accept="image/*" onchange="updateImage(this, 'profileBg', 'bg')">
        </div>
        <div class="profile-card">
            <div class="avatar-area">
                <div class="avatar-wrapper" onclick="document.getElementById('avatarInput').click()">
                    <img id="avatarImg" src="https://api.dicebear.com/7.x/avataaars/svg?seed=Jiang" class="avatar-img">
                    <input type="file" id="avatarInput" class="hidden-input" accept="image/*" onchange="updateImage(this, 'avatarImg', 'img')">
                </div>
            </div>
            <div class="user-info">
                <div class="user-name" id="userName" contenteditable="true" onblur="saveProfileMeta()">江忱</div>
                <div class="user-meta">
                    <span>ID: <span id="userId" class="editable-span" contenteditable="true" onblur="saveProfileMeta()">123456789</span></span>
                    <span style="margin:0 5px;">|</span>
                    <span>IP: <span id="userIp" class="editable-span" contenteditable="true" onblur="saveProfileMeta()">中国台湾</span></span>
                </div>
            </div>
            <div class="profile-tab-container">
                <div class="p-tab active" id="ptab-posts" onclick="ProfileRenderer.switchTab('posts')">帖子</div>
                <div class="p-tab" id="ptab-cols" onclick="ProfileRenderer.switchTab('cols')">合集</div>
            </div>
            <div id="profile-posts-area">
                <div id="profile-posts-list" class="posts-container mode-list" style="padding:0 12px;"></div>
                <div id="profile-empty" style="text-align:center; padding:30px; color:#ddd; display:none;">暂无内容</div>
            </div>
            <div id="profile-cols-area" style="display:none;">
                <div class="new-col-btn" onclick="ColMgr.openCreate()">+ 新建合集</div>
                <div id="col-list-container"></div>
            </div>
        </div>
    </div>

    <!-- 设置页 -->
    <div id="view-theme" class="view">
        <div class="theme-page">
            <h2 style="margin-bottom:20px;">设置与备份</h2>
            
            <div style="font-size:12px; color:#999; margin:20px 0 8px;">数据导出</div>
            <div class="btn-white" onclick="DBMgr.showExportYearMenu()">
                <span>备份数据 (支持选择保存位置)</span>
                <span style="color:#999;font-size:12px;">ZIP</span>
            </div>
            <div class="btn-white" onclick="DBMgr.exportTextOnly()">
                <span>仅导出文字 (JSON)</span>
                <span style="color:#999;font-size:12px;">轻量级</span>
            </div>

            <div style="font-size:12px; color:#999; margin:20px 0 8px;">数据导入</div>
            <div class="btn-white" style="position:relative;">
                <span>恢复数据 (选择 ZIP 或 JSON 文件)</span>
                <input type="file" class="hidden-input" style="display:block; opacity:0; position:absolute; top:0; left:0; width:100%; height:100%;" onchange="DBMgr.importData(this)">
            </div>
            <div class="btn-white" onclick="DBMgr.clearAll()" style="color:red; margin-top:10px;"><span>清空所有数据</span></div>

            <div style="font-size:12px; color:#999; margin:20px 0 8px;">栏目外观</div>
            <!-- 移除了顶部栏背景设置，因为已经强制透明了 -->
            <div class="btn-white" onclick="document.getElementById('bottomBarInput').click()"><span>底部栏背景</span><input type="file" id="bottomBarInput" class="hidden-input" accept="image/*" onchange="ThemeMgr.setBarBg('bottom', this)"></div>
            <div class="btn-white" onclick="document.getElementById('globalBgInput').click()"><span>全局背景图</span><input type="file" id="globalBgInput" class="hidden-input" accept="image/*" onchange="setGlobalBg(this)"></div>
            <div class="btn-white" onclick="document.getElementById('postBgInput').click()"><span>帖子默认名片背景</span><input type="file" id="postBgInput" class="hidden-input" accept="image/*" onchange="ThemeMgr.setPostBg(this)"></div>

            <div style="font-size:12px; color:#999; margin:20px 0 8px;">底部图标</div>
            <div class="theme-grid">
                <div class="theme-icon-box" onclick="document.getElementById('icon1Input').click()"><img id="icon1Preview" src=""><span style="margin-top:5px;">首页</span><input type="file" id="icon1Input" class="hidden-input" accept="image/*" onchange="ThemeMgr.setIcon(0, this)"></div>
                <div class="theme-icon-box" onclick="document.getElementById('icon2Input').click()"><img id="icon2Preview" src=""><span style="margin-top:5px;">HTML</span><input type="file" id="icon2Input" class="hidden-input" accept="image/*" onchange="ThemeMgr.setIcon(1, this)"></div>
                <div class="theme-icon-box" onclick="document.getElementById('icon3Input').click()"><img id="icon3Preview" src=""><span style="margin-top:5px;">发布</span><input type="file" id="icon3Input" class="hidden-input" accept="image/*" onchange="ThemeMgr.setIcon(2, this)"></div>
                <div class="theme-icon-box" onclick="document.getElementById('icon4Input').click()"><img id="icon4Preview" src=""><span style="margin-top:5px;">我的</span><input type="file" id="icon4Input" class="hidden-input" accept="image/*" onchange="ThemeMgr.setIcon(3, this)"></div>
                <div class="theme-icon-box" onclick="document.getElementById('icon5Input').click()"><img id="icon5Preview" src=""><span style="margin-top:5px;">设置</span><input type="file" id="icon5Input" class="hidden-input" accept="image/*" onchange="ThemeMgr.setIcon(4, this)"></div>
            </div>
            <div class="btn-white" onclick="ThemeMgr.resetAll()" style="margin-top:20px;"><span>重置美化设置</span></div>
        </div>
    </div>

    <!-- 底部导航 -->
    <div class="bottom-bar" id="bottomBar">
        <div class="nav-item active" onclick="Router.go('home', this)" id="nav-0"><svg class="icon" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg></div>
        <div class="nav-item" onclick="Router.go('html-home', this)" id="nav-1"><svg class="icon" viewBox="0 0 24 24"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg></div>
        <div class="nav-item" id="nav-2">
            <div class="nav-icon-plus" onclick="Editor.open()">
                <svg viewBox="0 0 24 24" id="svg-plus"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            </div>
        </div>
        <div class="nav-item" onclick="Router.go('profile', this)" id="nav-3"><svg class="icon" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></div>
        <div class="nav-item" onclick="Router.go('theme', this)" id="nav-4"><svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg></div>
    </div>
</div>

<div class="image-viewer-overlay" id="imageViewer" onclick="ImageViewer.close()">
    <div class="iv-img-wrapper"><img id="iv-img" src="" onclick="event.stopPropagation()"></div>
    <div class="iv-controls" onclick="event.stopPropagation()">
        <div class="iv-btn" onclick="ImageViewer.download()">
            <svg class="icon" style="width:16px; height:16px;" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>保存图片
        </div>
        <div class="iv-btn" onclick="ImageViewer.close()">关闭</div>
    </div>
</div>

<div class="overlay" id="contextOverlay" onclick="ContextMenu.hide()">
    <div class="context-menu" id="contextMenuBody" onclick="event.stopPropagation()"></div>
</div>

<div class="overlay" id="colSelectOverlay" onclick="document.getElementById('colSelectOverlay').style.display='none'">
    <div class="context-menu" id="colSelectMenu" onclick="event.stopPropagation()">
        <div style="padding:15px; font-weight:bold; border-bottom:1px solid #eee;">添加到合集</div>
        <div id="colSelectOptions" style="max-height:300px; overflow-y:auto;"></div>
        <div class="menu-item" onclick="document.getElementById('colSelectOverlay').style.display='none'">取消</div>
    </div>
</div>

<!-- 年份导出选择弹窗 -->
<div class="overlay" id="exportYearOverlay" onclick="document.getElementById('exportYearOverlay').style.display='none'">
    <div class="context-menu" onclick="event.stopPropagation()">
        <div style="padding:15px; font-weight:bold; border-bottom:1px solid #eee; text-align:center;">选择导出年份</div>
        <div id="exportYearOptions" style="max-height:300px; overflow-y:auto;"></div>
        <div class="menu-item" style="color:#666;" onclick="document.getElementById('exportYearOverlay').style.display='none'">取消</div>
    </div>
</div>

<script>
    // 通用保存文件函数 - 核心修改：使用系统分享让用户选择
    function saveFileUniversal(blob, fileName) {
        if (window.plus) {
            document.getElementById('loadingText').innerText = '正在调起系统保存...';
            // 1. 先保存到私有文档目录 (临时存放)
            plus.io.requestFileSystem(plus.io.PRIVATE_DOC, function(fs) {
                fs.root.getFile(fileName, { create: true }, function(fileEntry) {
                    fileEntry.createWriter(function(writer) {
                        writer.onwriteend = function() {
                            document.getElementById('loadingMask').style.display = 'none';
                            // 2. 写入成功后，调用系统分享功能
                            // 这样用户可以选择 "保存到文件"、"发送到微信"、"发送到网盘" 等
                            plus.share.sendWithSystem({
                                type: 'text', // 或者 'image' 但对于zip通常用通用分享
                                content: '我的备份数据', 
                                href: fileEntry.toURL(),
                                title: fileName
                            }, function(){
                                console.log('分享成功');
                            }, function(e){
                                console.log('分享失败: ' + JSON.stringify(e));
                            });
                        };
                        writer.onerror = function(e) { alert('写入临时文件失败: ' + e.message); };
                        writer.write(blob); 
                    }, function(e) { alert('无法创建写入器: ' + e.message); });
                }, function(e) { alert('无法创建文件: ' + e.message); });
            }, function(e) { alert('无法访问文件系统: ' + e.message); });
        } else {
            // 浏览器环境保持原样
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = fileName;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
            setTimeout(() => URL.revokeObjectURL(url), 10000);
            document.getElementById('loadingMask').style.display = 'none';
        }
    }

    const DBMgr = {
        dbName: 'LofterArchiveDB', dbVersion: 2, db: null,
        init: () => new Promise((resolve, reject) => {
            const request = indexedDB.open(DBMgr.dbName, DBMgr.dbVersion);
            request.onupgradeneeded = (event) => { const db = event.target.result; if (!db.objectStoreNames.contains('posts')) db.createObjectStore('posts', { keyPath: 'id' }); if (!db.objectStoreNames.contains('collections')) db.createObjectStore('collections', { keyPath: 'id' }); };
            request.onsuccess = (event) => { DBMgr.db = event.target.result; resolve(DBMgr.db); }; request.onerror = (event) => reject(event);
        }),
        getAllPostMeta: async () => {
            if(!DBMgr.db) await DBMgr.init();
            return new Promise((resolve) => {
                const tx = DBMgr.db.transaction(['posts'], 'readonly');
                const store = tx.objectStore('posts');
                const metaList = [];
                const request = store.openCursor(); 
                request.onsuccess = (event) => {
                    const cursor = event.target.result;
                    if (cursor) {
                        const p = cursor.value;
                        metaList.push({ 
                            id: p.id, date: p.date, isTop: p.isTop, type: p.type, 
                            searchString: (p.title + (p.content ? p.content.slice(0, 50) : '')).toLowerCase(), 
                            hasImage: (p.images && p.images.length > 0) || !!p.image 
                        });
                        cursor.continue();
                    } else { resolve(metaList); }
                };
            });
        },
        getPostsBatch: async (ids) => {
            if(!DBMgr.db) await DBMgr.init();
            return new Promise((resolve) => {
                const tx = DBMgr.db.transaction(['posts'], 'readonly');
                const store = tx.objectStore('posts');
                const results = [];
                let completed = 0;
                if(ids.length === 0) resolve([]);
                ids.forEach(id => {
                    const req = store.get(id);
                    req.onsuccess = (e) => { results.push(e.target.result); completed++; if(completed === ids.length) { const ordered = ids.map(id => results.find(r => r && r.id === id)).filter(x => x); resolve(ordered); } };
                    req.onerror = () => { completed++; if(completed === ids.length) resolve(results); };
                });
            });
        },
        getPost: async (id) => { if(!DBMgr.db) await DBMgr.init(); return new Promise((resolve) => { const request = DBMgr.db.transaction(['posts'], 'readonly').objectStore('posts').get(id); request.onsuccess = () => resolve(request.result); }); },
        savePost: async (post) => { if(!DBMgr.db) await DBMgr.init(); return new Promise((resolve) => { const tx = DBMgr.db.transaction(['posts'], 'readwrite'); tx.objectStore('posts').put(post); tx.oncomplete = () => resolve(true); }); },
        deletePost: async (id) => { if(!DBMgr.db) await DBMgr.init(); return new Promise((resolve) => { const tx = DBMgr.db.transaction(['posts'], 'readwrite'); tx.objectStore('posts').delete(id); tx.oncomplete = () => resolve(true); }); },
        getAllCollections: async () => { if(!DBMgr.db) await DBMgr.init(); return new Promise((resolve) => { const request = DBMgr.db.transaction(['collections'], 'readonly').objectStore('collections').getAll(); request.onsuccess = () => resolve(request.result || []); }); },
        saveCollection: async (col) => { if(!DBMgr.db) await DBMgr.init(); return new Promise((resolve) => { const request = DBMgr.db.transaction(['collections'], 'readwrite').objectStore('collections').put(col); request.onsuccess = () => resolve(true); }); },
        deleteCollection: async (id) => { if(!DBMgr.db) await DBMgr.init(); return new Promise((resolve) => { const tx = DBMgr.db.transaction(['collections'], 'readwrite'); tx.objectStore('collections').delete(id); tx.oncomplete = () => resolve(true); }); },
        showExportYearMenu: async () => {
            const meta = await DBMgr.getAllPostMeta();
            if(meta.length === 0) return alert('没有任何数据');
            const years = new Set(meta.map(m => new Date(m.date).getFullYear()));
            const sortedYears = Array.from(years).sort((a,b) => b-a);
            let html = '';
            sortedYears.forEach(y => { const count = meta.filter(m => new Date(m.date).getFullYear() === y).length; html += `<div class="menu-item" onclick="DBMgr.exportYear(${y})">${y} 年 <span style="font-size:11px;color:#999;margin-left:5px;">(${count}篇)</span></div>`; });
            html += `<div style="height:1px;background:#eee;margin:5px 0;"></div><div class="menu-item" onclick="DBMgr.exportYear('all')" style="color:#ff4d4f;">导出全部 (可能卡顿)</div>`;
            document.getElementById('exportYearOptions').innerHTML = html;
            document.getElementById('exportYearOverlay').style.display = 'flex';
        },
        exportYear: async (year) => {
            document.getElementById('exportYearOverlay').style.display = 'none';
            if (typeof JSZip === 'undefined') { alert('需要网络加载JSZip组件'); return; }
            document.getElementById('loadingMask').style.display = 'flex';
            document.getElementById('loadingText').innerText = '准备数据...';
            setTimeout(async () => {
                try {
                    const zip = new JSZip(); const imagesFolder = zip.folder("images");
                    const fullConfig = {}; for (let i = 0; i < localStorage.length; i++) { const key = localStorage.key(i); if (key.startsWith('profile_') || key.startsWith('theme_') || key === 'global_bg') fullConfig[key] = localStorage.getItem(key); }
                    const tx = DBMgr.db.transaction(['collections'], 'readonly');
                    const collections = await new Promise(r => tx.objectStore('collections').getAll().onsuccess = e => r(e.target.result));
                    const exportPosts = [];
                    const postTx = DBMgr.db.transaction(['posts'], 'readonly');
                    const store = postTx.objectStore('posts');
                    const request = store.openCursor();
                    let count = 0;
                    await new Promise((resolve, reject) => {
                        request.onsuccess = (event) => {
                            const cursor = event.target.result;
                            if (cursor) {
                                const p = cursor.value;
                                const pYear = new Date(p.date).getFullYear();
                                if (year === 'all' || pYear === year) {
                                    const pCopy = { ...p, images: [], image: null, postBg: null };
                                    if (p.images && p.images.length > 0) { for (let i = 0; i < p.images.length; i++) { const blob = p.images[i]; const ext = blob.type.split('/')[1] || 'jpg'; const fName = `p_${p.id}_${i}.${ext}`; imagesFolder.file(fName, blob); pCopy.images.push(fName); } }
                                    if (p.image) { const ext = p.image.type.split('/')[1] || 'jpg'; const fName = `p_${p.id}_cover.${ext}`; imagesFolder.file(fName, p.image); pCopy.image = fName; }
                                    if (p.postBg) { const ext = p.postBg.type.split('/')[1] || 'jpg'; const fName = `p_${p.id}_bg.${ext}`; imagesFolder.file(fName, p.postBg); pCopy.postBg = fName; }
                                    exportPosts.push(pCopy); count++;
                                    if (count % 10 === 0) document.getElementById('loadingText').innerText = `处理中: ${count} 篇...`;
                                }
                                cursor.continue();
                            } else { resolve(); }
                        };
                        request.onerror = (e) => reject(e);
                    });
                    const data = { version: 50, timestamp: Date.now(), year: year, posts: exportPosts, collections: collections, localStorage: fullConfig };
                    zip.file(`data_${year}.json`, JSON.stringify(data));
                    document.getElementById('loadingText').innerText = '正在压缩...';
                    const content = await zip.generateAsync({type:"blob", compression: "DEFLATE"}, (meta) => { document.getElementById('loadingText').innerText = `打包中 ${meta.percent.toFixed(0)}%`; });
                    saveFileUniversal(content, `Backup_${year}_${new Date().toISOString().slice(0,10)}.zip`);
                } catch(e) { console.error(e); alert('导出失败: ' + e.message); document.getElementById('loadingMask').style.display = 'none'; }
            }, 100);
        },
        exportTextOnly: async () => {
            document.getElementById('loadingMask').style.display = 'flex';
            document.getElementById('loadingText').innerText = '正在导出纯文本...';
            setTimeout(async () => {
                try {
                    const tx = DBMgr.db.transaction(['posts'], 'readonly'); const store = tx.objectStore('posts');
                    const allPosts = await new Promise(r => store.getAll().onsuccess = e => r(e.target.result));
                    const cleanPosts = allPosts.map(p => { const { images, image, postBg, ...rest } = p; return rest; });
                    const blob = new Blob([JSON.stringify(cleanPosts)], {type: "application/json"});
                    saveFileUniversal(blob, `TextOnly_Backup_${new Date().toISOString().slice(0,10)}.json`);
                } catch(e) { alert('导出失败: ' + e.message); document.getElementById('loadingMask').style.display = 'none'; }
            }, 50);
        },
        importData: async (input) => {
            const file = input.files[0]; if(!file) return;
            if(!confirm('导入将覆盖当前数据，确定？')) return;
            document.getElementById('loadingMask').style.display = 'flex';
            
            try {
                // 1. 检查是否为 ZIP 文件
                if (file.name.toLowerCase().endsWith('.zip')) {
                    document.getElementById('loadingText').innerText = '正在读取备份文件...';
                    
                    const zip = await new JSZip().loadAsync(file);
                    
                    // 查找 JSON 数据文件
                    const jsonFile = Object.values(zip.files).find(f => f.name.endsWith('.json') && f.name.includes('data'));
                    if (!jsonFile) throw new Error('压缩包内未找到数据文件 (data_*.json)');
                    
                    const jsonStr = await jsonFile.async('string');
                    const json = JSON.parse(jsonStr);
                    
                    document.getElementById('loadingText').innerText = '正在解压图片资源...';

                    // --- 第一步，先在内存中把所有图片 Blob 准备好 ---
                    const postsToSave = [];
                    const sourcePosts = json.posts || [];

                    for (let p of sourcePosts) {
                        // 1.1 恢复图集
                        if (Array.isArray(p.images) && p.images.length > 0) {
                            const blobPromises = p.images.map(async (fileName) => {
                                if (typeof fileName === 'string') {
                                    const imgFile = zip.file("images/" + fileName);
                                    if (imgFile) return await imgFile.async('blob');
                                }
                                return null;
                            });
                            // 等待所有图片解压完成
                            p.images = (await Promise.all(blobPromises)).filter(b => b);
                        }
                        
                        // 1.2 恢复封面
                        if (p.image && typeof p.image === 'string') {
                            const imgFile = zip.file("images/" + p.image);
                            if (imgFile) p.image = await imgFile.async('blob');
                            else p.image = null;
                        }
                        
                        // 1.3 恢复单贴背景 (postBg)
                        if (p.postBg && typeof p.postBg === 'string') {
                            const imgFile = zip.file("images/" + p.postBg);
                            if (imgFile) p.postBg = await imgFile.async('blob');
                            else p.postBg = null;
                        }
                        
                        postsToSave.push(p);
                    }
                    
                    // --- 第二步，开启事务并同步写入 ---
                    document.getElementById('loadingText').innerText = '正在写入数据库...';
                    
                    const tx = DBMgr.db.transaction(['posts', 'collections'], 'readwrite');
                    const postStore = tx.objectStore('posts');
                    const colStore = tx.objectStore('collections');
                    
                    // 清空旧数据
                    postStore.clear();
                    colStore.clear();
                    
                    // 恢复 LocalStorage
                    if(json.localStorage) {
                        Object.keys(json.localStorage).forEach(key => localStorage.setItem(key, json.localStorage[key]));
                    }
                    
                    // 写入合集
                    if(json.collections) {
                        for (let col of json.collections) colStore.put(col);
                    }
                    
                    // 写入帖子
                    for (let p of postsToSave) {
                        postStore.put(p);
                    }
                    
                    tx.oncomplete = () => { 
                        alert('恢复成功！'); 
                        location.reload(); 
                    };
                    
                    tx.onerror = (e) => {
                        throw new Error('数据库写入失败: ' + e.target.error.message);
                    };

                } else {
                    // 原有的 JSON 导入逻辑 (纯文本)
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        try {
                            const json = JSON.parse(e.target.result);
                            const tx = DBMgr.db.transaction(['posts', 'collections'], 'readwrite');
                            tx.objectStore('posts').clear(); 
                            tx.objectStore('collections').clear();
                            
                            if(json.localStorage) Object.keys(json.localStorage).forEach(key => localStorage.setItem(key, json.localStorage[key]));
                            if(json.collections) for (let col of json.collections) tx.objectStore('collections').put(col);
                            if(json.posts || Array.isArray(json)) { 
                                const posts = json.posts || json; 
                                for (let post of posts) { tx.objectStore('posts').put(post); } 
                            }
                            tx.oncomplete = () => { alert('恢复成功！'); location.reload(); };
                        } catch(err) { 
                            alert('JSON 解析失败: ' + err.message); 
                        } finally { 
                            document.getElementById('loadingMask').style.display = 'none'; 
                        }
                    };
                    reader.readAsText(file);
                }
            } catch(err) {
                console.error(err);
                alert('导入失败: ' + err.message);
                document.getElementById('loadingMask').style.display = 'none';
            }
        },
        clearAll: async () => { if(confirm('确定清空？')) { const tx = DBMgr.db.transaction(['posts', 'collections'], 'readwrite'); tx.objectStore('posts').clear(); tx.objectStore('collections').clear(); localStorage.clear(); location.reload(); } }
    };

    const Utils = {
        formatDate: (ts) => { const d = new Date(ts); return { day: d.getDate().toString().padStart(2, '0'), ym: `/ ${d.getMonth()+1} ${d.getFullYear()}`, full: `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2,'0')}-${d.getDate()}` }; },
        getCurrentUser: () => { return { name: localStorage.getItem('profile_name') || 'Lofter用户', avatar: localStorage.getItem('profile_avatar') || 'https://api.dicebear.com/7.x/avataaars/svg?seed=Jiang' }; },
        getImgSrc: (imgData) => { if (!imgData) return ''; if (typeof imgData === 'string') return imgData; return URL.createObjectURL(imgData); },
        fileToBase64: (file, callback) => { const reader = new FileReader(); reader.onload = (e) => callback(e.target.result); reader.readAsDataURL(file); },
        compressImage: (file, maxWidth = 1280, quality = 0.7) => {
            return new Promise((resolve) => {
                if (!file.type.match(/image.*/)) return resolve(file);
                const reader = new FileReader();
                reader.onload = (readerEvent) => {
                    const image = new Image();
                    image.onload = () => {
                        let canvas = document.createElement('canvas'); let width = image.width; let height = image.height;
                        if (width > maxWidth || height > maxWidth) { if (width > height) { height *= maxWidth / width; width = maxWidth; } else { width *= maxWidth / height; height = maxWidth; } }
                        canvas.width = width; canvas.height = height; canvas.getContext('2d').drawImage(image, 0, 0, width, height);
                        canvas.toBlob((blob) => { resolve(blob); }, 'image/jpeg', quality);
                    };
                    image.src = readerEvent.target.result;
                };
                reader.readAsDataURL(file);
            });
        }
    };

    const Router = { 
        history: ['home'], 
        go: (viewName, navEl) => { 
            if(viewName === 'home') Router.history = ['home']; else Router.history.push(viewName); 
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active')); if(navEl) navEl.classList.add('active'); 
            document.querySelectorAll('.view').forEach(el => el.classList.remove('active')); document.getElementById(`view-${viewName}`).classList.add('active'); 
            document.getElementById('view-detail').style.backgroundImage = ''; 
            if(viewName !== 'html-detail') { document.getElementById('html-detail-iframe').srcdoc = ''; }
            if(viewName === 'home') HomeRenderer.checkAndRender(); 
            if(viewName === 'html-home') HtmlHomeRenderer.render(); 
            if(viewName === 'profile') ProfileRenderer.render(); 
        }, 
        back: () => { 
            if(Router.history.length > 1) { 
                Router.history.pop(); const prev = Router.history[Router.history.length-1]; 
                if (document.getElementById('view-html-detail').classList.contains('active')) { document.getElementById('html-detail-iframe').srcdoc = ''; }
                document.querySelectorAll('.view').forEach(el => el.classList.remove('active')); document.getElementById(`view-${prev}`).classList.add('active'); 
                document.getElementById('view-detail').style.backgroundImage = ''; 
                if(prev === 'home') HomeRenderer.checkAndRender(); 
                if(prev === 'html-home') HtmlHomeRenderer.render(); 
                if(prev === 'profile') ProfileRenderer.render(); 
            } else { Router.go('home'); } 
        } 
    };

    const ImageViewer = { open: (src) => { if (!src) return; document.getElementById('imageViewer').style.display = 'flex'; document.getElementById('iv-img').src = src; }, close: () => { document.getElementById('imageViewer').style.display = 'none'; }, download: () => { const src = document.getElementById('iv-img').src; const a = document.createElement('a'); a.href = src; a.download = `image_${Date.now()}.png`; document.body.appendChild(a); a.click(); document.body.removeChild(a); } };

    const ContextMenu = { 
        targetId: null, 
        show: (e, id) => { 
            e.preventDefault(); 
            ContextMenu.targetId = id; 
            const isCollectionMode = document.getElementById('view-collection-detail').classList.contains('active');
            
            let deleteHtml = `<div class="menu-item danger" onclick="ContextMenu.del()">删除帖子</div>`;
            if (isCollectionMode) {
                deleteHtml = `<div class="menu-item danger" onclick="ContextMenu.removeFromCollection()">从合集移除</div>`;
            }

            const menuHtml = `
                <div class="menu-item" onclick="ContextMenu.toggleTop()">置顶/取消置顶</div>
                <div class="menu-item" onclick="ContextMenu.edit()">编辑</div>
                <div class="menu-item" onclick="BatchMgr.enter()">批量管理</div>
                ${deleteHtml}
                <div class="menu-item" onclick="ContextMenu.hide()">取消</div>
            `;
            document.getElementById('contextMenuBody').innerHTML = menuHtml; 
            document.getElementById('contextOverlay').style.display = 'flex'; 
        }, 
        showDetailMenu: (e, id) => { 
            e.stopPropagation(); ContextMenu.targetId = id; 
            const menuHtml = `<div class="menu-item" onclick="ContextMenu.edit()">编辑帖子</div><div class="menu-item" onclick="ContextMenu.addToColSingle(${id})">加入合集</div><div class="menu-item danger" onclick="ContextMenu.delFromDetail()">删除帖子</div><div class="menu-item" onclick="ContextMenu.hide()">取消</div>`; 
            document.getElementById('contextMenuBody').innerHTML = menuHtml; 
            document.getElementById('contextOverlay').style.display = 'flex'; 
        }, 
        hide: () => { document.getElementById('contextOverlay').style.display = 'none'; }, 
        del: async () => { 
            if(confirm('彻底删除这条内容?')) { 
                await DBMgr.deletePost(ContextMenu.targetId); 
                HomeRenderer.resetAndRender(); 
                HtmlHomeRenderer.render(); 
                ContextMenu.hide(); 
            } 
        }, 
        removeFromCollection: async () => {
            const colId = ColDetailMgr.currentColId;
            const postId = ContextMenu.targetId;
            if(!colId) return;
            if(confirm('将帖子移出当前合集（不会删除原帖）？')) {
                const cols = await DBMgr.getAllCollections();
                const target = cols.find(c => c.id === colId);
                if (target && target.postIds) {
                    target.postIds = target.postIds.filter(pid => pid !== postId);
                    await DBMgr.saveCollection(target);
                    await ColMgr.openDetail(colId); // 刷新合集视图
                }
                ContextMenu.hide();
            }
        },
        delFromDetail: async () => { if(confirm('删除当前帖子?')) { await DBMgr.deletePost(ContextMenu.targetId); HomeRenderer.resetAndRender(); HtmlHomeRenderer.render(); ContextMenu.hide(); Router.back(); } }, 
        edit: async () => { const post = await DBMgr.getPost(ContextMenu.targetId); Editor.open(post, post.type || 'normal'); ContextMenu.hide(); }, 
        toggleTop: async () => { const post = await DBMgr.getPost(ContextMenu.targetId); post.isTop = !post.isTop;await DBMgr.savePost(post); HomeRenderer.resetAndRender(); HtmlHomeRenderer.render(); ContextMenu.hide(); }, 
        addToColSingle: (id) => { ContextMenu.showCollectionSelector([id]); }, 
        showCollectionSelector: async (postIds) => { const cols = await DBMgr.getAllCollections(); if(cols.length === 0) { ContextMenu.hide(); return alert('请先去“合集”页创建一个合集'); } const listEl = document.getElementById('colSelectOptions'); listEl.innerHTML = cols.map(c => `<div class="menu-item" onclick="ContextMenu.executeAdd([${postIds}], ${c.id})">${c.title}</div>`).join(''); document.getElementById('colSelectOverlay').style.display = 'flex'; ContextMenu.hide(); }, 
        executeAdd: async (postIds, colId) => { const col = await DBMgr.getAllCollections(); const target = col.find(c => c.id === colId); if(!target.postIds) target.postIds = []; for(let pid of postIds) { if(!target.postIds.includes(pid)) target.postIds.push(pid); } await DBMgr.saveCollection(target); document.getElementById('colSelectOverlay').style.display = 'none'; alert('已加入合集'); } 
    };

    const ColDetailMgr = { 
        currentColId: null, postIds: [], 
        saveStat: async (el, type) => { const val = el.innerText; const cols = await DBMgr.getAllCollections(); const target = cols.find(c => c.id === ColDetailMgr.currentColId); if(target) { if(type === 'sub') target.subCount = val; if(type === 'hot') target.hotCount = val; if(type === 'view') target.viewCount = val; await DBMgr.saveCollection(target); } },
        startReading: () => { if(!ColDetailMgr.postIds || ColDetailMgr.postIds.length === 0) return alert('合集是空的'); DetailRenderer.open(ColDetailMgr.postIds[0], ColDetailMgr.currentColId); },
        showMenu: () => { const html = `<div class="menu-item" onclick="ColMgr.editFromDetail()">编辑合集</div><div class="menu-item danger" onclick="ColDetailMgr.deleteCurrent()">删除合集</div><div class="menu-item" onclick="ContextMenu.hide()">取消</div>`; document.getElementById('contextMenuBody').innerHTML = html; document.getElementById('contextOverlay').style.display = 'flex'; },
        deleteCurrent: async () => { if(confirm('确定要删除这个合集吗？')) { await DBMgr.deleteCollection(ColDetailMgr.currentColId); ContextMenu.hide(); Router.go('profile'); setTimeout(() => ProfileRenderer.switchTab('cols'), 100); } },
        toggleSubscribe: (btn) => { if(btn.innerText === '订阅合集') { btn.innerText = '已订阅'; btn.style.background = '#ccc'; btn.style.color = '#fff'; } else { btn.innerText = '订阅合集'; btn.style.background = '#333'; btn.style.color = '#fff'; } }
    };

    const DetailRenderer = {
        currentPostId: null, contextColId: null,
        open: async (id, colId = null) => {
            if (Router.history[Router.history.length - 1] !== 'detail') Router.history.push('detail');
            DetailRenderer.currentPostId = id; DetailRenderer.contextColId = colId;
            const post = await DBMgr.getPost(id); if(!post) return;
            if(post.type === 'html') { DetailRenderer.openHtmlDetail(post); return; }
            const user = Utils.getCurrentUser(); document.getElementById('d-avatar-img').src = user.avatar; document.getElementById('d-username').innerText = user.name;
            const detailView = document.getElementById('view-detail');
            if(post.postBg) {
                detailView.style.backgroundImage = `url(${Utils.getImgSrc(post.postBg)})`;
            } else {
                detailView.style.backgroundImage = ''; 
            }
            const bodyEl = document.getElementById('d-body-content'); let html = ''; const images = post.images || (post.image ? [post.image] : []);
            if(images.length > 0) { 
                let sliderItems = images.map(blob => `<div class="d-slider-item"><img src="${Utils.getImgSrc(blob)}" onclick="ImageViewer.open(this.src)"></div>`).join('');
                html += `<div class="d-slider-container"><div class="d-slider">${sliderItems}</div>${images.length > 1 ? `<div class="d-slider-indicator">1 / ${images.length}</div>` : ''}</div>`;
                setTimeout(() => { const slider = document.querySelector('.d-slider'); const indicator = document.querySelector('.d-slider-indicator'); if(slider && indicator) slider.addEventListener('scroll', () => { const index = Math.round(slider.scrollLeft / slider.clientWidth) + 1; indicator.innerText = `${index} / ${images.length}`; }); }, 100);
                if(post.title) html += `<div style="padding:15px 20px 0; font-size:18px; font-weight:bold;">${post.title}</div>`; if(post.content) html += `<div class="d-content">${post.content}</div>`; 
            } else { if(post.title) html += `<div style="padding:20px 20px 0; font-size:18px; font-weight:bold;">${post.title}</div>`; html += `<div class="d-content text-mode">${post.content}</div>`; } 
            html += '<div style="height:60px;"></div>';
            bodyEl.innerHTML = html; document.getElementById('d-date').innerText = Utils.formatDate(post.date).full; DetailRenderer.renderComments(post);
            const inputBar = document.getElementById('float-input-bar');
            const toolbar = document.getElementById('reading-toolbar');
            if(colId) { 
                inputBar.style.display = 'none'; toolbar.style.display = 'flex'; 
                document.getElementById('d-inline-input-area').innerHTML = `<div class="static-input-bar"><input type="text" id="inline-comment-input" placeholder="评论..."><div class="send-btn" onclick="DetailRenderer.addComment()">发送</div></div>`; 
                const ids = ColDetailMgr.postIds; const idx = ids.indexOf(id); 
                document.getElementById('rt-prev').className = idx <= 0 ? 'rt-btn disabled' : 'rt-btn';
                document.getElementById('rt-next').className = (idx === -1 || idx >= ids.length - 1) ? 'rt-btn disabled' : 'rt-btn';
            } else { 
                inputBar.style.display = 'flex'; toolbar.style.display = 'none'; document.getElementById('d-inline-input-area').innerHTML = ''; 
            }
            document.querySelectorAll('.view').forEach(el => el.classList.remove('active')); document.getElementById('view-detail').classList.add('active');
        },
        openHtmlDetail: (post) => { 
            DetailRenderer.currentPostId = post.id; 
            const container = document.getElementById('view-html-detail'); 
            const iframe = document.getElementById('html-detail-iframe');
            const safeContent = post.content + `<style>body { margin:0; overflow:hidden; }</style>`;
            iframe.srcdoc = safeContent;
            iframe.onload = () => {
                setTimeout(() => {
                    try { const innerHeight = iframe.contentWindow.document.body.scrollHeight; iframe.style.height = (innerHeight + 20) + 'px'; } catch(e) { iframe.style.height = '800px'; }
                }, 100);
            };
            const user = Utils.getCurrentUser(); 
            const comments = post.comments || []; 
            let commentsHtml = comments.length === 0 ? '<div style="text-align:center; color:#ccc; font-size:12px; padding:10px;">暂无评论</div>' : comments.map(c => `<div style="margin-bottom:10px; font-size:13px;"><span style="font-weight:bold;">${user.name}:</span> ${c.text}</div>`).join(''); 
            const listEl = document.getElementById('html-comments-list-simple');
            listEl.innerHTML = commentsHtml; 
            document.querySelectorAll('.view').forEach(el => el.classList.remove('active')); 
            container.classList.add('active'); 
        },
        renderComments: (post) => { const listEl = document.getElementById('d-comments-list'); if(!post.comments || post.comments.length === 0) { listEl.innerHTML = '<div style="text-align:center; color:#eee;">暂无评论</div>'; return; } const user = Utils.getCurrentUser(); listEl.innerHTML = post.comments.map(c => `<div class="comment-item"><img src="${user.avatar}" class="c-avatar"><div class="c-right"><div class="c-top"><span>${user.name}</span></div><div class="c-text">${c.text}</div><div class="c-date">${Utils.formatDate(c.date).full}</div></div></div>`).join(''); },
        addComment: async () => { let text = ''; const floatInput = document.getElementById('comment-input'); const inlineInput = document.getElementById('inline-comment-input'); if (inlineInput && document.body.contains(inlineInput) && inlineInput.offsetParent !== null) { text = inlineInput.value; inlineInput.value = ''; } else if (floatInput && floatInput.value) { text = floatInput.value; floatInput.value = ''; } if(!text) return; const post = await DBMgr.getPost(DetailRenderer.currentPostId); if(!post.comments) post.comments = []; post.comments.push({ text: text, date: Date.now() }); await DBMgr.savePost(post); DetailRenderer.renderComments(post); if(!document.getElementById('d-inline-input-area').innerHTML) { setTimeout(() => { document.getElementById('view-detail').scrollTop = document.getElementById('view-detail').scrollHeight; }, 100); } },
        addHtmlComment: async () => { const input = document.getElementById('html-comment-input'); const text = input.value; if(!text) return; const post = await DBMgr.getPost(DetailRenderer.currentPostId); if(!post.comments) post.comments = []; post.comments.push({ text: text, date: Date.now() }); await DBMgr.savePost(post); input.value = ''; const user = Utils.getCurrentUser(); const listEl = document.getElementById('html-comments-list-simple'); const newCommentHtml = `<div style="margin-bottom:10px; font-size:13px;"><span style="font-weight:bold;">${user.name}:</span> ${text}</div>`; if(post.comments.length === 1) listEl.innerHTML = newCommentHtml; else listEl.insertAdjacentHTML('beforeend', newCommentHtml); },
        nextPost: () => { if(!DetailRenderer.contextColId) return; const ids = ColDetailMgr.postIds; const idx = ids.indexOf(DetailRenderer.currentPostId); if(idx !== -1 && idx < ids.length - 1) DetailRenderer.open(ids[idx+1], DetailRenderer.contextColId); },
        prevPost: () => { if(!DetailRenderer.contextColId) return; const ids = ColDetailMgr.postIds; const idx = ids.indexOf(DetailRenderer.currentPostId); if(idx > 0) DetailRenderer.open(ids[idx-1], DetailRenderer.contextColId); },
        showDirectory: async () => { const listEl = document.getElementById('dir-list-container'); const ids = ColDetailMgr.postIds; let html = ''; const batchPosts = await DBMgr.getPostsBatch(ids); batchPosts.forEach(p => { const isActive = p.id === DetailRenderer.currentPostId; const title = p.title || (p.content ? p.content.substring(0, 20) + '...' : '无标题'); html += `<div class="dir-item ${isActive?'active':''}" onclick="DetailRenderer.jumpFromDir(${p.id})"><span>${title}</span></div>`; }); listEl.innerHTML = html; document.getElementById('dir-overlay').style.display = 'flex'; },
        jumpFromDir: (id) => { document.getElementById('dir-overlay').style.display = 'none'; DetailRenderer.open(id, DetailRenderer.contextColId); }
    };
    
    const Editor = {
        currentImages: [], currentId: null, currentType: 'normal', currentPostBg: null, currentColId: null,
        open: async (post, type = 'normal') => { 
            Editor.currentType = type; 
            document.getElementById('post-title').value = ''; 
            document.getElementById('post-content').value = ''; 
            Editor.currentImages = []; Editor.currentId = null; Editor.currentPostBg = null; Editor.currentColId = null;
            document.getElementById('editor-bg-btn').classList.remove('has-bg'); document.getElementById('editor-col-btn').classList.remove('active'); document.getElementById('editor-col-text').innerText = '+ 加入合集';
            const wordCountEl = document.getElementById('word-count-display');
            if(type === 'html') { wordCountEl.style.display = 'none'; } else { wordCountEl.style.display = 'block'; wordCountEl.classList.remove('show'); wordCountEl.innerText = '0 字'; }
            if(post) { 
                Editor.currentId = post.id; Editor.currentType = post.type || 'normal'; document.getElementById('post-title').value = post.title || ''; document.getElementById('post-content').value = post.content || ''; 
                if(post.images && post.images.length > 0) Editor.currentImages = [...post.images]; else if(post.image) Editor.currentImages = [post.image];
                if(post.postBg) { Editor.currentPostBg = post.postBg; document.getElementById('editor-bg-btn').classList.add('has-bg'); }
                const cols = await DBMgr.getAllCollections(); const parentCol = cols.find(c => c.postIds && c.postIds.includes(post.id)); if(parentCol) Editor.selectCollection(parentCol.id, parentCol.title);
                if(type !== 'html') Editor.updateWordCount();
            } 
            Editor.renderGallery(); document.querySelectorAll('.view').forEach(el => el.classList.remove('active')); document.getElementById('view-editor').classList.add('active'); 
        },
        updateWordCount: () => { if(Editor.currentType === 'html') return; const content = document.getElementById('post-content').value; const count = content.length; const el = document.getElementById('word-count-display'); el.innerText = count + ' 字'; if(count > 0) el.classList.add('show'); else el.classList.remove('show'); },
        handleImages: async (input) => { if(input.files && input.files.length > 0) { const files = Array.from(input.files); const btnHtml = document.getElementById('img-upload-btn').innerHTML; document.getElementById('img-upload-btn').innerHTML = '<span style="font-size:10px;">处理中...</span>'; for (let file of files) { const compressed = await Utils.compressImage(file); Editor.currentImages.push(compressed); } document.getElementById('img-upload-btn').innerHTML = btnHtml; Editor.renderGallery(); } },
        handlePostBg: async (input) => { if(input.files && input.files[0]) { const compressed = await Utils.compressImage(input.files[0]); Editor.currentPostBg = compressed; document.getElementById('editor-bg-btn').classList.add('has-bg'); } },
        openColPicker: async () => { const cols = await DBMgr.getAllCollections(); const listEl = document.getElementById('colSelectOptions'); if(cols.length === 0) return alert('还没有创建过合集'); listEl.innerHTML = cols.map(c => `<div class="menu-item" onclick="Editor.selectCollection(${c.id}, '${c.title}')">${c.title}</div>`).join(''); document.getElementById('colSelectOverlay').style.display = 'flex'; },
        selectCollection: (id, title) => { Editor.currentColId = id; document.getElementById('editor-col-btn').classList.add('active'); document.getElementById('editor-col-text').innerText = title; document.getElementById('colSelectOverlay').style.display = 'none'; },
        removeCollection: (e) => { e.stopPropagation(); Editor.currentColId = null; document.getElementById('editor-col-btn').classList.remove('active'); document.getElementById('editor-col-text').innerText = '+ 加入合集'; },
        removeImage: (index) => { Editor.currentImages.splice(index, 1); Editor.renderGallery(); },
        renderGallery: () => { const gallery = document.getElementById('editor-gallery'); const btn = document.getElementById('img-upload-btn'); while(gallery.firstChild && gallery.firstChild !== btn) { gallery.removeChild(gallery.firstChild); } Editor.currentImages.forEach((imgBlob, idx) => { const div = document.createElement('div'); div.className = 'editor-img-item'; const src = Utils.getImgSrc(imgBlob); div.innerHTML = `<img src="${src}"><div class="editor-img-remove" onclick="Editor.removeImage(${idx})">×</div>`; gallery.insertBefore(div, btn); }); },
        publish: async () => { 
            const title = document.getElementById('post-title').value; const content = document.getElementById('post-content').value; 
            if(!content && Editor.currentImages.length === 0 && !title) return alert('写点什么吧'); 
            let oldPost = null; if (Editor.currentId) oldPost = await DBMgr.getPost(Editor.currentId); const postId = Editor.currentId || Date.now();
            const newPost = { id: postId, type: Editor.currentType, title: title, content: content, images: Editor.currentImages, image: Editor.currentImages.length > 0 ? Editor.currentImages[0] : null, date: oldPost ? oldPost.date : Date.now(), isTop: oldPost ? oldPost.isTop : false, comments: oldPost ? oldPost.comments : [], postBg: Editor.currentPostBg }; 
            await DBMgr.savePost(newPost); 
            const cols = await DBMgr.getAllCollections(); const targetColId = Editor.currentColId; const oldCol = cols.find(c => c.postIds && c.postIds.includes(postId));
            if (oldCol && (!targetColId || oldCol.id !== targetColId)) { oldCol.postIds = oldCol.postIds.filter(id => id !== postId); await DBMgr.saveCollection(oldCol); }
            if (targetColId) { const targetCol = cols.find(c => c.id === targetColId); if (targetCol) { if (!targetCol.postIds) targetCol.postIds = []; if (!targetCol.postIds.includes(postId)) { targetCol.postIds.push(postId); await DBMgr.saveCollection(targetCol); } } }
            if(Editor.currentType === 'html') Router.go('html-home'); else Router.go('home');
        }
    };

    const HomeRenderer = {
        layout: 0, allMeta: [], currentIndex: 0, BATCH_SIZE: 15, observer: null, sortOrder: 'desc', filterType: 'all', isLoading: false,
        layoutIcons: ['<path d="M3 12h18M3 6h18M3 18h18"/>', '<rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>', '<rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect>'],
        toggleLayout: () => { HomeRenderer.layout = (HomeRenderer.layout + 1) % 3; HomeRenderer.updateIcon(); HomeRenderer.resetAndRender(); },
        updateIcon: () => { document.getElementById('layout-icon').innerHTML = HomeRenderer.layoutIcons[HomeRenderer.layout]; },
        showFilterMenu: () => { const html = `<div class="menu-section-title">排序方式</div><div class="menu-item ${HomeRenderer.sortOrder==='desc'?'active':''}" onclick="HomeRenderer.setSort('desc')">最新发布</div><div class="menu-item ${HomeRenderer.sortOrder==='asc'?'active':''}" onclick="HomeRenderer.setSort('asc')">最早发布</div><div class="menu-section-title">内容筛选</div><div class="menu-item ${HomeRenderer.filterType==='all'?'active':''}" onclick="HomeRenderer.setFilter('all')">全部内容</div><div class="menu-item ${HomeRenderer.filterType==='image'?'active':''}" onclick="HomeRenderer.setFilter('image')">仅看图片</div><div class="menu-item ${HomeRenderer.filterType==='text'?'active':''}" onclick="HomeRenderer.setFilter('text')">仅看文字</div><div class="menu-item" style="color:#666;margin-top:10px;" onclick="ContextMenu.hide()">关闭</div>`; document.getElementById('contextMenuBody').innerHTML = html; document.getElementById('contextOverlay').style.display = 'flex'; },
        setSort: (order) => { HomeRenderer.sortOrder = order; ContextMenu.hide(); HomeRenderer.resetAndRender(); },
        setFilter: (type) => { HomeRenderer.filterType = type; ContextMenu.hide(); HomeRenderer.resetAndRender(); },
        checkAndRender: () => HomeRenderer.resetAndRender(),
        resetAndRender: async () => {
            if (HomeRenderer.observer) { HomeRenderer.observer.disconnect(); HomeRenderer.observer = null; }
            let meta = await DBMgr.getAllPostMeta();
            meta = meta.filter(p => !p.type || p.type === 'normal');
            const term = document.getElementById('searchInput').value.toLowerCase();
            if(term) meta = meta.filter(p => p.searchString.includes(term));
            if(HomeRenderer.filterType === 'image') meta = meta.filter(p => p.hasImage); else if(HomeRenderer.filterType === 'text') meta = meta.filter(p => !p.hasImage);
            meta.sort((a, b) => { if(a.isTop && !b.isTop) return -1; if(!a.isTop && b.isTop) return 1; if(HomeRenderer.sortOrder === 'asc') return a.date - b.date; else return b.date - a.date; });
            HomeRenderer.allMeta = meta; HomeRenderer.currentIndex = 0; HomeRenderer.isLoading = false;
            const postsContainer = document.getElementById('posts-list'); const timelineContainer = document.getElementById('timeline-list');
            postsContainer.style.display = 'none'; timelineContainer.style.display = 'none'; document.getElementById('empty-state').style.display = (meta.length === 0) ? 'block' : 'none';
            if(meta.length === 0) return;
            
            if(HomeRenderer.layout === 2) {
                // Timeline
                timelineContainer.style.display = 'block'; timelineContainer.innerHTML = ''; 
                const batchMeta = meta.slice(0, 100); const batchPosts = await DBMgr.getPostsBatch(batchMeta.map(m=>m.id));
                HomeRenderer.renderTimelineFull(batchPosts);
            } else if (HomeRenderer.layout === 0) {
                // Grid (Dual Column JS Layout)
                postsContainer.style.display = 'block'; 
                postsContainer.className = 'posts-container mode-grid';
                // Reset to structure
                postsContainer.innerHTML = `<div class="waterfall-container"><div class="waterfall-col" id="wf-col-0"></div><div class="waterfall-col" id="wf-col-1"></div></div>`;
                await HomeRenderer.loadMore(); HomeRenderer.setupObserver();
            } else {
                // List (Single Column)
                postsContainer.style.display = 'block';
                postsContainer.className = 'posts-container mode-list';
                postsContainer.innerHTML = '';
                await HomeRenderer.loadMore(); HomeRenderer.setupObserver();
            }
        },
        loadMore: async () => { 
            if (HomeRenderer.layout === 2) return; if (HomeRenderer.isLoading) return; if (HomeRenderer.currentIndex >= HomeRenderer.allMeta.length) return; 
            HomeRenderer.isLoading = true;
            try {
                const nextIndex = HomeRenderer.currentIndex + HomeRenderer.BATCH_SIZE; 
                const batchMeta = HomeRenderer.allMeta.slice(HomeRenderer.currentIndex, nextIndex);
                const batchPosts = await DBMgr.getPostsBatch(batchMeta.map(m => m.id));
                
                // Rendering Logic
                if (HomeRenderer.layout === 0) {
                    const col0 = document.getElementById('wf-col-0');
                    const col1 = document.getElementById('wf-col-1');
                    batchPosts.forEach((p, idx) => {
                        const html = HomeRenderer.createPostHTML(p);
                        // 智能判断：每次添加时，把新卡片加到当前更短的那一列
                        if (col0.offsetHeight <= col1.offsetHeight) {
                            col0.insertAdjacentHTML('beforeend', html);
                        } else {
                            col1.insertAdjacentHTML('beforeend', html);
                        }
                    });
                } else {
                    const html = batchPosts.map(p => HomeRenderer.createPostHTML(p)).join(''); 
                    document.getElementById('posts-list').insertAdjacentHTML('beforeend', html); 
                }

                HomeRenderer.currentIndex = nextIndex; 
            } finally { HomeRenderer.isLoading = false; }
        },
        setupObserver: () => { if (HomeRenderer.observer) HomeRenderer.observer.disconnect(); const options = { root: document.getElementById('view-home'), rootMargin: '200px', threshold: 0.1 }; HomeRenderer.observer = new IntersectionObserver((entries) => { if (entries[0].isIntersecting) { HomeRenderer.loadMore(); } }, options); HomeRenderer.observer.observe(document.getElementById('scroll-sentinel')); },
        createPostHTML: (p, specificLayout = null) => { 
            if(!p) return '';
            const d = Utils.formatDate(p.date); const user = Utils.getCurrentUser(); const images = p.images || (p.image ? [p.image] : []); let mediaHTML = ''; const targetLayout = (specificLayout !== null) ? specificLayout : HomeRenderer.layout;
            const firstImg = images.length > 0 ? Utils.getImgSrc(images[0]) : '';
            if (images.length > 0) {
                if (targetLayout === 0) { const badge = images.length > 1 ? `<div class="img-count-badge"><svg class="icon" style="width:10px;height:10px;" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg> ${images.length}</div>` : ''; mediaHTML = `<div class="post-img-grid"><img src="${firstImg}" loading="lazy">${badge}</div>`; } 
                else { const displayImgs = images.slice(0, 4); const count = displayImgs.length; const imgs = displayImgs.map(blob => `<div class="post-img-item"><img src="${Utils.getImgSrc(blob)}"></div>`).join(''); mediaHTML = `<div class="post-img-grid cols-${count}">${imgs}</div>`; }
            }
            const contentText = p.content || ''; 
            const bgStyle = p.postBg ? `style="background-image: url(${Utils.getImgSrc(p.postBg)}) !important; background-attachment: scroll !important;"` : '';
            return `<div class="post-card ${p.isTop?'is-top':''}" id="post-${p.id}" ${bgStyle} onclick="handlePostClick(${p.id}, this)" oncontextmenu="ContextMenu.show(event, ${p.id})"><div class="pin-mark"><svg viewBox="0 0 24 24"><line x1="4" y1="4" x2="20" y2="4"/><line x1="12" y1="20" x2="12" y2="8"/><polyline points="6 14 12 8 18 14"/></svg></div><div class="post-header"><div style="display:flex;align-items:center;"><img src="${user.avatar}" style="width:24px;height:24px;border-radius:50%;margin-right:8px; object-fit:cover;"><div class="post-date"><span class="date-day">${d.day}</span><span class="date-info">${d.ym}</span></div></div></div>${mediaHTML}<div class="post-content-wrap">${p.title ? `<div class="post-title">${p.title}</div>` : ''}<div class="post-text">${contentText}</div></div></div>`; 
        },
        renderTimelineFull: (posts) => { const groups = {}; posts.forEach(p => { const d = new Date(p.date); const key = `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2, '0')}`; if(!groups[key]) groups[key] = []; groups[key].push(p); }); let tlHtml = ''; Object.keys(groups).sort((a,b)=> new Date(b)-new Date(a)).forEach(key => { const [year, month] = key.split('-'); const monthPosts = groups[key]; let gridHtml = monthPosts.map(p => { const images = p.images || (p.image ? [p.image] : []); if(images.length > 0) return `<div class="grid-item" onclick="DetailRenderer.open(${p.id})"><img src="${Utils.getImgSrc(images[0])}" loading="lazy"></div>`; else return `<div class="grid-item" onclick="DetailRenderer.open(${p.id})"><div class="text-card"><div class="text-content-sm">${p.title || p.content}</div></div></div>`; }).join(''); tlHtml += `<div class="month-section"><div class="month-header"><div class="month-left"><span class="month-num">${parseInt(month)}月</span><span class="year-num">${year}</span></div><span class="post-count-badge">${monthPosts.length}篇</span></div><div class="grid-row">${gridHtml}</div></div>`; }); document.getElementById('timeline-list').innerHTML = tlHtml; }
    };
    
    const ColMgr = { 
        currentCover: null, currentColId: null, 
        renderList: async () => { const cols = await DBMgr.getAllCollections(); const container = document.getElementById('col-list-container'); if(cols.length === 0) { container.innerHTML = '<div style="text-align:center; padding:40px; color:#999;">暂无合集，点击右上角创建</div>'; return; } container.innerHTML = cols.map(c => `<div class="col-item" onclick="ColMgr.openDetail(${c.id})"><img src="${Utils.getImgSrc(c.cover) || 'https://via.placeholder.com/150'}" class="col-cover"><div class="col-info"><div class="col-title">${c.title}</div><div class="col-desc">${c.desc || '无描述'}</div><div style="font-size:12px; color:#bbb; margin-top:5px;">${c.postIds ? c.postIds.length : 0} 篇</div></div></div>`).join(''); }, 
        openCreate: () => { ColMgr.currentColId = null; ColMgr.currentCover = null; document.getElementById('col-title-input').value = ''; document.getElementById('col-desc-input').value = ''; document.getElementById('col-cover-preview').style.display = 'none'; document.getElementById('col-cover-tip').style.display = 'block'; document.querySelectorAll('.view').forEach(el => el.classList.remove('active')); document.getElementById('view-collection-create').classList.add('active'); }, 
        handleCover: async (input) => { if(input.files && input.files[0]) { const compressed = await Utils.compressImage(input.files[0]); Utils.fileToBase64(compressed, (base64) => { ColMgr.currentCover = base64; document.getElementById('col-cover-preview').src = base64; document.getElementById('col-cover-preview').style.display = 'block'; document.getElementById('col-cover-tip').style.display = 'none'; }); } }, 
        save: async () => { const title = document.getElementById('col-title-input').value; const desc = document.getElementById('col-desc-input').value; if(!title) return alert('请输入标题'); let newCol; if(ColMgr.currentColId) { const cols = await DBMgr.getAllCollections(); const existing = cols.find(c => c.id === ColMgr.currentColId); newCol = { ...existing, title: title, desc: desc, cover: ColMgr.currentCover }; } else { newCol = { id: Date.now(), title: title, desc: desc, cover: ColMgr.currentCover, postIds: [] }; } await DBMgr.saveCollection(newCol); Router.go('profile'); setTimeout(() => ProfileRenderer.switchTab('cols'), 100); }, 
        editFromDetail: async () => { const cols = await DBMgr.getAllCollections(); const target = cols.find(c => c.id === ColDetailMgr.currentColId); if(!target) return; ColMgr.currentColId = target.id; ColMgr.currentCover = target.cover; document.getElementById('col-title-input').value = target.title; document.getElementById('col-desc-input').value = target.desc || ''; if(target.cover) { document.getElementById('col-cover-preview').src = Utils.getImgSrc(target.cover); document.getElementById('col-cover-preview').style.display = 'block'; document.getElementById('col-cover-tip').style.display = 'none'; } else { document.getElementById('col-cover-preview').style.display = 'none'; document.getElementById('col-cover-tip').style.display = 'block'; } ContextMenu.hide(); document.querySelectorAll('.view').forEach(el => el.classList.remove('active')); document.getElementById('view-collection-create').classList.add('active'); },
        openDetail: async (colId) => { 
            const cols = await DBMgr.getAllCollections(); 
            const target = cols.find(c => c.id === colId); 
            if(!target) return; 
            Router.history.push('collection-detail');
            document.querySelectorAll('.view').forEach(el => el.classList.remove('active')); 
            document.getElementById('view-collection-detail').classList.add('active');
            document.getElementById('cd-bg').style.backgroundImage = `url(${Utils.getImgSrc(target.cover) || ''})`; 
            document.getElementById('cd-cover').src = Utils.getImgSrc(target.cover) || 'https://via.placeholder.com/150'; 
            document.getElementById('cd-title').innerText = target.title; 
            const user = Utils.getCurrentUser(); 
            document.getElementById('cd-avatar').src = user.avatar; 
            document.getElementById('cd-author').innerText = `${user.name} · 创建于刚刚`; 
            document.getElementById('cd-stat-sub').innerText = target.subCount || '0'; 
            document.getElementById('cd-stat-hot').innerText = target.hotCount || '0'; 
            document.getElementById('cd-stat-view').innerText = target.viewCount || '0'; 
            let posts = []; 
            if(target.postIds && target.postIds.length > 0) { posts = await DBMgr.getPostsBatch(target.postIds); } 
            posts.sort((a,b) => b.date - a.date); 
            const listContainer = document.getElementById('cd-post-list'); 
            if(posts.length === 0) { listContainer.innerHTML = ''; document.getElementById('cd-empty').style.display = 'block'; } 
            else { document.getElementById('cd-empty').style.display = 'none'; listContainer.innerHTML = posts.map(p => HomeRenderer.createPostHTML(p, 0)).join(''); } 
            ColDetailMgr.currentColId = colId; 
            ColDetailMgr.postIds = posts.map(p => p.id); 
        } 
    };

    const ProfileRenderer = {
        currentTab: 'posts', render: async () => { document.querySelectorAll('.p-tab').forEach(el => el.classList.remove('active')); document.getElementById(`ptab-${ProfileRenderer.currentTab}`).classList.add('active'); if(ProfileRenderer.currentTab === 'posts') { document.getElementById('profile-posts-area').style.display = 'block'; document.getElementById('profile-cols-area').style.display = 'none'; await ProfileRenderer.renderPosts(); } else { document.getElementById('profile-posts-area').style.display = 'none'; document.getElementById('profile-cols-area').style.display = 'block'; await ColMgr.renderList(); } },
        switchTab: (tabName) => { ProfileRenderer.currentTab = tabName; ProfileRenderer.render(); },
        returnToCols: () => { Router.go('profile'); setTimeout(() => { ProfileRenderer.switchTab('cols'); }, 50); },
        renderPosts: async () => { let meta = await DBMgr.getAllPostMeta(); meta = meta.filter(p => !p.type || p.type === 'normal'); meta.sort((a, b) => { if(a.isTop && !b.isTop) return -1; if(!a.isTop && b.isTop) return 1; return b.date - a.date; }); const batchMeta = meta.slice(0, 50); const posts = await DBMgr.getPostsBatch(batchMeta.map(m=>m.id)); const container = document.getElementById('profile-posts-list'); if (posts.length === 0) { container.innerHTML = ''; document.getElementById('profile-empty').style.display = 'block'; } else { document.getElementById('profile-empty').style.display = 'none'; container.innerHTML = posts.map(p => HomeRenderer.createPostHTML(p, 1)).join(''); } }
    };

    const HtmlHomeRenderer = { 
        render: async () => { 
            let meta = await DBMgr.getAllPostMeta(); 
            meta = meta.filter(p => p.type === 'html'); 
            meta.sort((a, b) => { if(a.isTop && !b.isTop) return -1; if(!a.isTop && b.isTop) return 1; return b.date - a.date; }); 
            const posts = await DBMgr.getPostsBatch(meta.map(m=>m.id)); 
            const container = document.getElementById('html-posts-list'); 
            
            if(posts.length === 0) { 
                container.innerHTML = ''; 
                document.getElementById('html-empty-state').style.display = 'block'; 
            } else { 
                document.getElementById('html-empty-state').style.display = 'none'; 
                container.innerHTML = ''; 
                // HTML 首页也使用双列智能逻辑
                container.className = 'posts-container mode-grid';
                container.innerHTML = `<div class="waterfall-container"><div class="waterfall-col" id="html-wf-col-0"></div><div class="waterfall-col" id="html-wf-col-1"></div></div>`;
                const col0 = document.getElementById('html-wf-col-0');
                const col1 = document.getElementById('html-wf-col-1');

                const user = Utils.getCurrentUser();
                posts.forEach((p, index) => {
                    const d = Utils.formatDate(p.date);
                    const bgStyle = p.postBg ? `style="background-image: url(${Utils.getImgSrc(p.postBg)}) !important; background-attachment: scroll !important;"` : '';
                    let innerHTML = `<div class="post-card ${p.isTop?'is-top':''}" style="${p.postBg ? 'background-image: url('+Utils.getImgSrc(p.postBg)+') !important; background-attachment: scroll !important;' : ''}" onclick="handlePostClick(${p.id}, this)" oncontextmenu="ContextMenu.show(event, ${p.id})"><div class="pin-mark"><svg viewBox="0 0 24 24"><line x1="4" y1="4" x2="20" y2="4"/><line x1="12" y1="20" x2="12" y2="8"/><polyline points="6 14 12 8 18 14"/></svg></div><div class="post-header"><div style="display:flex;align-items:center;"><img src="${user.avatar}" style="width:24px;height:24px;border-radius:50%;margin-right:8px; object-fit:cover;"><div class="post-date"><span class="date-day">${d.day}</span><span class="date-info">${d.ym}</span></div></div></div><div class="post-html-preview"></div><div class="post-content-wrap">${p.title ? `<div class="post-title">${p.title}</div>` : ''}</div></div>`;
                    
                    const template = document.createElement('template');
                    template.innerHTML = innerHTML.trim();
                    const card = template.content.firstChild;
                    
                    const previewContainer = card.querySelector('.post-html-preview');
                    const iframe = document.createElement('iframe');
                    const zoomedContent = p.content + `<style>body { transform: scale(0.4); transform-origin: top left; width: 250%; overflow: hidden; }</style>`;
                    iframe.srcdoc = zoomedContent;
                    iframe.loading = "lazy";
                    previewContainer.appendChild(iframe);

                    if(col0.offsetHeight <= col1.offsetHeight) col0.appendChild(card);
                    else col1.appendChild(card);
                });
            } 
        } 
    };

    const BatchMgr = { 
        active: false, selectedIds: new Set(), 
        enter: () => { BatchMgr.active = true; BatchMgr.selectedIds.clear(); document.body.classList.add('batch-mode'); ContextMenu.hide(); }, 
        exit: () => { BatchMgr.active = false; BatchMgr.selectedIds.clear(); document.body.classList.remove('batch-mode'); document.querySelectorAll('.post-card').forEach(el => el.classList.remove('selected')); }, 
        toggleSelect: (id, cardEl) => { if(BatchMgr.selectedIds.has(id)) { BatchMgr.selectedIds.delete(id); cardEl.classList.remove('selected'); } else { BatchMgr.selectedIds.add(id); cardEl.classList.add('selected'); } }, 
        deleteSelected: async () => { 
            if(BatchMgr.selectedIds.size === 0) return; 
            if(confirm(`确定删除选中的 ${BatchMgr.selectedIds.size} 篇内容？`)) { 
                for (let id of BatchMgr.selectedIds) { await DBMgr.deletePost(id); } 
                BatchMgr.exit(); 
                HomeRenderer.resetAndRender(); 
                HtmlHomeRenderer.render(); 
            } 
        }, 
        addToCollection: async () => { if(BatchMgr.selectedIds.size === 0) return; ContextMenu.showCollectionSelector(Array.from(BatchMgr.selectedIds)); } 
    };
    
    const ThemeMgr = { 
        init: () => { 
            if(localStorage.getItem('global_bg')) document.getElementById('global-bg-layer').style.backgroundImage = `url(${localStorage.getItem('global_bg')})`; 
            // 注意：顶部栏现在强制透明，不再读取 theme_top_bg
            if(localStorage.getItem('theme_bottom_bg')) document.documentElement.style.setProperty('--bottom-bar-bg', `url(${localStorage.getItem('theme_bottom_bg')})`); 
            if(localStorage.getItem('theme_post_bg')) document.documentElement.style.setProperty('--post-card-bg', `url(${localStorage.getItem('theme_post_bg')})`); 
            
            const defaultIcons = ['<svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="9 22 9 12 15 12 15 22"/></svg>', '<svg viewBox="0 0 24 24"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>', '<svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>', '<svg viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>', '<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>']; 
            for(let i=0; i<5; i++) { 
                const iconSrc = localStorage.getItem(`theme_icon_${i}`); 
                const preview = document.getElementById(`icon${i+1}Preview`); 
                if(iconSrc) { ThemeMgr.renderIcon(i, iconSrc); if(preview) preview.src = iconSrc; } 
                else if(preview) { const svgString = defaultIcons[i].replace('<svg ', '<svg xmlns="http://www.w3.org/2000/svg" stroke="#999" fill="none" stroke-width="2" '); preview.src = 'data:image/svg+xml;base64,' + btoa(svgString); } 
            } 
        }, 
        renderIcon: (index, src) => { 
            const nav = document.getElementById(`nav-${index}`); if(!nav) return; 
            if(index === 2) { const plusIcon = nav.querySelector('.nav-icon-plus') || nav; plusIcon.innerHTML = `<img src="${src}" style="width:100%; height:100%; object-fit:cover; border-radius:8px;">`; if(plusIcon.classList.contains('nav-icon-plus')) plusIcon.style.background = 'transparent'; } 
            else { nav.innerHTML = `<img src="${src}" class="custom-nav-icon">`; } 
            const preview = document.getElementById(`icon${index+1}Preview`); if(preview) preview.src = src; 
        }, 
        setIcon: (index, input) => { if (input.files && input.files[0]) { Utils.fileToBase64(input.files[0], (base64) => { localStorage.setItem(`theme_icon_${index}`, base64); ThemeMgr.renderIcon(index, base64); }); } }, 
        setBarBg: (type, input) => { if (input.files && input.files[0]) { Utils.fileToBase64(input.files[0], (base64) => { localStorage.setItem(`theme_${type}_bg`, base64); document.documentElement.style.setProperty(`--${type}-bar-bg`, `url(${base64})`); }); } }, 
        setPostBg: async (input) => { 
            if (input.files && input.files[0]) { 
                const compressed = await Utils.compressImage(input.files[0], 1024, 0.7);
                Utils.fileToBase64(compressed, (base64) => { 
                    try {
                        localStorage.setItem('theme_post_bg', base64); 
                        document.documentElement.style.setProperty('--post-card-bg', `url(${base64})`); 
                        alert('全局名片背景已更新');
                    } catch (e) {
                        alert('图片太大，无法保存到配置中，请换一张小图');
                    }
                }); 
                input.value = ''; 
            } 
        }, 
        resetAll: () => { if(confirm('重置美化？')) { Object.keys(localStorage).forEach(key => { if(key.startsWith('theme_') || key === 'global_bg') localStorage.removeItem(key); }); location.reload(); } } 
    };

    function handlePostClick(id, el) { 
        if(BatchMgr.active) { BatchMgr.toggleSelect(id, el); } 
        else { if (document.getElementById('view-collection-detail').classList.contains('active')) { DetailRenderer.open(id, ColDetailMgr.currentColId); } else { DetailRenderer.open(id); } } 
    }

    let touchTimer = null; document.addEventListener('touchstart', (e) => { const card = e.target.closest('.post-card'); if(card && !BatchMgr.active) { touchTimer = setTimeout(() => { const evt = new MouseEvent('contextmenu', { bubbles: true, cancelable: true, view: window }); card.dispatchEvent(evt); }, 600); } }); document.addEventListener('touchend', () => clearTimeout(touchTimer)); document.addEventListener('touchmove', () => clearTimeout(touchTimer));
    function updateImage(input, elemId, type) { if (input.files && input.files[0]) { Utils.fileToBase64(input.files[0], (base64) => { if(type === 'bg') { document.getElementById(elemId).style.backgroundImage = `url(${base64})`; localStorage.setItem('profile_bg', base64); } else { document.getElementById(elemId).src = base64; localStorage.setItem('profile_avatar', base64); } }); } }
    function saveProfileMeta() { localStorage.setItem('profile_name', document.getElementById('userName').innerText); localStorage.setItem('profile_id', document.getElementById('userId').innerText); localStorage.setItem('profile_ip', document.getElementById('userIp').innerText); }
    function setGlobalBg(input) { if(input.files && input.files[0]) { Utils.fileToBase64(input.files[0], (base64) => { document.getElementById('global-bg-layer').style.backgroundImage = `url(${base64})`; localStorage.setItem('global_bg', base64); }); } }

    window.addEventListener('DOMContentLoaded', async () => {
        await DBMgr.init();
        if(localStorage.getItem('profile_bg')) document.getElementById('profileBg').style.backgroundImage = `url(${localStorage.getItem('profile_bg')})`;
        if(localStorage.getItem('profile_avatar')) document.getElementById('avatarImg').src = localStorage.getItem('profile_avatar');
        if(localStorage.getItem('profile_name')) document.getElementById('userName').innerText = localStorage.getItem('profile_name');
        if(localStorage.getItem('profile_id')) document.getElementById('userId').innerText = localStorage.getItem('profile_id');
        if(localStorage.getItem('profile_ip')) document.getElementById('userIp').innerText = localStorage.getItem('profile_ip');
        ThemeMgr.init(); 
        HomeRenderer.updateIcon();
        HomeRenderer.resetAndRender();

        document.addEventListener('plusready', function(){ 
            console.log("APP环境就绪，设置全屏");
            plus.navigator.setFullscreen(true);
        });
    });
</script>
</body>
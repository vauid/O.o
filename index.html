<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#ffffff">
<link rel="manifest" href="manifest.json">
<title>æˆ‘çš„çè— - å…¨å±é€æ˜ç‰ˆ</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<style>
    :root {
        --active-color: #333; --bg-color: #f5f5f5; --card-bg: #fff;
        --text-main: #333; --text-sub: #999;
        --nav-height: 50px;
        --default-font: -apple-system, BlinkMacSystemFont, "PingFang SC", "Helvetica Neue", Arial, sans-serif;
        
        /* åº•éƒ¨ä¾ç„¶ä½¿ç”¨å˜é‡ï¼Œä½†é¡¶éƒ¨æ ç°åœ¨å¼ºåˆ¶é€æ˜ï¼Œä¸å†ä½¿ç”¨ --top-bar-bg */
        --bottom-bar-bg: #fff;
        --post-card-bg: #fff;
        
        --safe-top: 15px;
        --safe-bottom: env(safe-area-inset-bottom, 0px);
    }
    
    html { font-size: var(--app-font-size, 13.5px); width: 100%; height: 100%; overflow: hidden; -webkit-text-size-adjust: 100%; }
    body { width: 100%; height: 100%; overflow: hidden; }
    * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
    
    body {
        font-size: 1rem;
        font-family: var(--app-font, var(--default-font)) !important;
        background-color: transparent; color: var(--text-main);
        -webkit-user-select: none; user-select: none; line-height: 1.5;
    }
    
    #global-bg-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -999; background-color: var(--bg-color); background-size: cover; background-position: center; pointer-events: none; }
    
    /* è§†å›¾ç³»ç»Ÿ */
    .view-container { position: relative; width: 100%; height: 100%; overflow: hidden; }
    .view { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow-y: auto; overflow-x: hidden; background: transparent; display: none; padding-bottom: calc(60px + var(--safe-bottom)); opacity: 0; transition: opacity 0.2s ease; z-index: 10; }
    .view.active { display: block; opacity: 1; }
    
    #view-editor, #view-collection-create { background: #fff; padding-bottom: 0; z-index: 2000; display: none; flex-direction: column; height: 100%; }
    #view-editor.active, #view-collection-create.active { display: flex; opacity: 1; }
    #view-html-detail { background: #fff; padding: 0; margin: 0; z-index: 3000; display: none; width: 100%; height: 100%; overflow-y: auto; }
    #view-html-detail.active { display: block; }
    #view-collection-detail { background: transparent; padding-bottom: 0; z-index: 2000; }
    #view-html-home { background: transparent; padding-top: calc(40px + var(--safe-top)); }
    
    #view-detail { 
        background: var(--post-card-bg); background-size: cover; background-position: center; 
        background-repeat: no-repeat; background-attachment: scroll; 
        padding-bottom: 80px; z-index: 2000; transition: background-image 0.3s; width: 100%; 
    }

    /* é€šç”¨ç»„ä»¶ */
    .icon { width: 22px; height: 22px; fill: none; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }
    .hidden-input { display: none; }
    .loading-mask { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index: 9999; display:none; flex-direction:column; justify-content:center; align-items:center; color:#333; font-weight:bold; }
    .loading-spinner { width: 36px; height: 36px; border: 3px solid #f3f3f3; border-top: 3px solid var(--active-color); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    #scroll-sentinel { height: 20px; width: 100%; opacity: 0; pointer-events: none; }
    
    .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 4000; display: none; align-items: center; justify-content: center; }
    .context-menu { background: #fff; width: 80%; border-radius: 12px; overflow: hidden; animation: popUp 0.2s ease-out; max-height: 80vh; overflow-y: auto; }
    .menu-item { padding: 14px; text-align: center; border-bottom: 1px solid #eee; font-size: 1.04rem; color: #333; display: flex; justify-content: center; align-items: center; position: relative; }
    .menu-item.danger { color: #ff4d4f; }
    .menu-item.active { color: var(--active-color); font-weight: bold; background: #f7f7f7; }
    .menu-section-title { background: #f9f9f9; color: #999; font-size: 0.81rem; padding: 8px 15px; font-weight: bold; text-align: left; border-bottom: 1px solid #eee; }
    @keyframes popUp { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

    .image-viewer-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 5000; display: none; flex-direction: column; justify-content: center; align-items: center; animation: fadeIn 0.2s ease; }
    .iv-img-wrapper { width: 100%; height: 80%; display: flex; justify-content: center; align-items: center; }
    .iv-img-wrapper img { max-width: 100%; max-height: 100%; object-fit: contain; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
    .iv-controls { position: absolute; bottom: calc(40px + var(--safe-bottom)); display: flex; gap: 20px; }
    .iv-btn { background: rgba(255,255,255,0.2); color: #fff; padding: 8px 20px; border-radius: 30px; border: 1px solid rgba(255,255,255,0.3); backdrop-filter: blur(10px); cursor: pointer; font-size: 0.96rem; font-weight: bold; display: flex; align-items: center; gap: 5px; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* åº•éƒ¨å¯¼èˆª (åº”ç”¨åº•éƒ¨èƒŒæ™¯) */
    .bottom-bar { 
        position: fixed; bottom: 0; left: 0; width: 100%; 
        height: calc(var(--nav-height) + var(--safe-bottom)); 
        padding-bottom: var(--safe-bottom); 
        background: var(--bottom-bar-bg); 
        background-size: cover; background-position: center; 
        backdrop-filter: blur(10px); 
        border-top: 1px solid rgba(0,0,0,0.05); 
        display: flex; justify-content: space-around; align-items: center; 
        z-index: 1000; transition: transform 0.3s ease; 
    }
    .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; color: #999; width: 20%; height: 100%; cursor: pointer; }
    .nav-item.active { color: var(--text-main); }
    .custom-nav-icon { width: 24px; height: 24px; border-radius: 6px; object-fit: cover; margin-bottom: 2px; }
    .nav-icon-plus { background: transparent; color: var(--text-main); width: 36px; height: 100%; display: flex; align-items: center; justify-content: center; box-shadow: none; border-radius: 0; }
    .nav-icon-plus svg { width: 28px; height: 28px; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; fill: none; }

    .batch-bar { position: fixed; bottom: 0; left: 0; width: 100%; height: calc(50px + var(--safe-bottom)); padding-bottom: var(--safe-bottom); background: #fff; display: none; justify-content: space-around; align-items: center; z-index: 2100; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); border-top: 1px solid #eee; }
    body.batch-mode .batch-bar { display: flex; animation: slideUp 0.3s ease; }
    body.batch-mode .bottom-bar { display: none; }
    body.batch-mode .post-card { transform: scale(0.95); opacity: 0.8; cursor: pointer; transition: all 0.2s; }
    body.batch-mode .post-card.selected { transform: scale(1); opacity: 1; box-shadow: 0 0 0 3px var(--active-color); }
    body.batch-mode .post-card.selected::after { content: 'âœ“'; position: absolute; top: 10px; right: 10px; background: var(--active-color); color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight:bold; z-index: 5; }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

    /* Home Header (å…¨é€æ˜ä¿®æ”¹) */
    .home-header { 
        position: sticky; top: 0; z-index: 50; 
        background: transparent;  /* å¼ºåˆ¶é€æ˜ */
        backdrop-filter: none;    /* å»æ‰ç£¨ç ‚ */
        box-shadow: none;         /* å»æ‰é˜´å½± */
        padding: calc(8px + var(--safe-top)) 15px 8px 15px; 
        display: flex; justify-content: space-between; align-items: center; 
    }
    /* æœç´¢æ¡†ä¿ç•™å¾®å¼±èƒŒæ™¯ï¼Œé˜²æ­¢çœ‹ä¸è§ */
    .search-box { 
        background: rgba(255,255,255, 0.3); 
        border-radius: 18px; padding: 5px 12px; display: flex; align-items: center; flex: 1; margin-right: 10px; 
        backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.2); 
    }
    .search-box input { border: none; background: transparent; font-size: 0.96rem; width: 100%; color: #333; }
    
    .posts-container { padding: 12px; transition: all 0.3s ease; min-height: 300px; display: block; }

    /* ç€‘å¸ƒæµåŒåˆ—å¸ƒå±€ç³»ç»Ÿ */
    .waterfall-container { display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; }
    .waterfall-col { flex: 1; width: 48%; display: flex; flex-direction: column; gap: 10px; }

    /* å¡ç‰‡ */
    .post-card { 
        background: var(--post-card-bg); 
        background-size: cover; background-position: center; background-repeat: no-repeat; background-attachment: scroll !important; 
        border-radius: 10px; overflow: hidden; box-shadow: 0 1px 2px rgba(0,0,0,0.05); 
        position: relative; transition: transform 0.1s; 
        content-visibility: auto; contain-intrinsic-size: 300px; width: 100%; 
    }
    .post-card:active { transform: scale(0.98); }
    .post-header { display: flex; align-items: center; justify-content: space-between; padding: 10px 12px 6px; }
    .post-date { display: flex; align-items: baseline; gap: 4px; }
    .date-day { font-size: 1.48rem; font-weight: 600; color: #333; line-height: 1; }
    .date-info { font-size: 0.81rem; color: #999; }
    .post-content-wrap { padding: 8px 12px 12px; }
    .post-title { font-size: 1.11rem; font-weight: 600; color: #333; line-height: 1.4; margin-bottom: 6px; }
    .post-text { font-size: 0.96rem; color: #555; line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;}
    .pin-mark { position: absolute; top: 8px; right: 10px; width: 16px; height: 16px; display: none; z-index: 5; color: #666; }
    .pin-mark svg { width: 100%; height: 100%; fill: none; stroke: currentColor; stroke-width: 3; stroke-linecap: round; stroke-linejoin: round; }
    .is-top .pin-mark { display: block; }
    
    /* æ¨¡å¼åŒºåˆ† */
    .posts-container.mode-list .post-card { margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.03); }
    .posts-container.mode-list .post-img-grid { display: grid; gap: 4px; padding: 0 12px; }
    .posts-container.mode-list .post-img-item { width: 100%; aspect-ratio: 4/3; overflow: hidden; border-radius: 4px; position: relative; }
    .posts-container.mode-list .post-img-item img { width: 100%; height: 100%; object-fit: cover; display: block; }
    
    /* Grid æ¨¡å¼ä¸‹å›¾ç‰‡ 1:1 å¼ºåˆ¶ */
    .post-img-grid img { width: 100%; height: auto; display: block; aspect-ratio: 1/1; object-fit: cover; }

    .img-count-badge { position: absolute; bottom: 5px; right: 5px; background: rgba(0,0,0,0.6); color: #fff; font-size: 0.74rem; padding: 2px 6px; border-radius: 10px; display: flex; align-items: center; gap: 3px; pointer-events: none; }
    
    .timeline-wrapper { display: none; padding: 0 14px; }
    .month-section { margin-bottom: 20px; content-visibility: auto; contain-intrinsic-size: 500px; }
    .month-header { display: flex; justify-content: space-between; align-items: baseline; padding: 10px 0 10px; border-bottom: 1px dashed #eee; margin-bottom: 10px; }
    .month-left { display: flex; align-items: baseline; gap: 5px; }
    .month-num { font-size: 1.63rem; font-weight: bold; color: #333; }
    .year-num { font-size: 0.96rem; color: #999; }
    .post-count-badge { background: #f0f0f0; color: #999; font-size: 0.74rem; padding: 2px 8px; border-radius: 10px; }
    .grid-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 3px; }
    .grid-item { aspect-ratio: 1 / 1; background: #f7f7f7; border-radius: 4px; overflow: hidden; position: relative; cursor: pointer; }
    .grid-item img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s; }
    .grid-item:active img { transform: scale(0.95); }
    .text-card { width: 100%; height: 100%; background: #fff; padding: 8px; display: flex; align-items: flex-start; border: 1px solid #f0f0f0; border-radius: 4px; }
    .text-content-sm { font-size: 0.81rem; line-height: 1.4; color: #666; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 6; -webkit-box-orient: vertical; width: 100%; word-break: break-all; }

    .editor-header { display: flex; justify-content: space-between; align-items: center; padding: calc(8px + var(--safe-top)) 15px 8px 15px; height: calc(46px + var(--safe-top)); background: #fff; flex-shrink: 0; }
    .editor-content { padding: 15px; overflow-y: auto; flex: 1; position: relative;}
    .editor-gallery { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px; }
    .editor-img-item { width: 90px; height: 90px; position: relative; border-radius: 8px; overflow: hidden; }
    .editor-img-item img { width: 100%; height: 100%; object-fit: cover; }
    .editor-img-remove { position: absolute; top: 4px; right: 4px; background: rgba(0,0,0,0.5); color: #fff; width: 18px; height: 18px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 0.89rem; cursor: pointer; }
    .image-upload-area { width: 90px; height: 90px; background: #f7f7f7; border-radius: 8px; border: 1px dashed #e0e0e0; display: flex; flex-direction: column; justify-content: center; align-items: center; color: #ccc; cursor: pointer; }
    .col-create-cover { width: 100px; height: 100px; background: #f7f7f7; border-radius: 10px; margin: 25px auto; display: flex; justify-content: center; align-items: center; cursor: pointer; border: 1px dashed #ccc; overflow: hidden; }
    .col-create-cover img { width: 100%; height: 100%; object-fit: cover; display: none; }
    .editor-input-group { position: relative; }
    .editor-input-group input { width: 100%; border: none; font-size: 1.19rem; padding: 10px 0; border-bottom: 1px solid #eee; margin-bottom: 15px; }
    .editor-input-group textarea {width: 100%; min-height: 300px; border: none; resize: none; font-size: 1.04rem; line-height: 1.6; color: #555; font-family: inherit; }
    .editor-tools-bottom { padding: 10px 15px; padding-bottom: calc(10px + var(--safe-bottom)); border-top: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background: #fff; flex-shrink: 0; }
    .et-left { display: flex; gap: 15px; align-items: center; }
    .col-pill-btn { display: flex; align-items: center; gap: 5px; background: #f2f2f2; color: #666; padding: 6px 12px; border-radius: 18px; font-size: 0.89rem; font-weight: 500; cursor: pointer; transition: all 0.2s; }
    .col-pill-btn.active { background: #333; color: #fff; }
    .col-pill-remove { display: none; width: 14px; height: 14px; background: rgba(255,255,255,0.3); border-radius: 50%; align-items: center; justify-content: center; font-size: 0.74rem; color: #fff; }
    .col-pill-btn.active .col-pill-remove { display: flex; }
    .bg-tool-btn { width: 32px; height: 32px; border-radius: 50%; display: flex; justify-content: center; align-items: center; background: #fff; color: #666; cursor: pointer; }
    .bg-tool-btn.has-bg { background: #333; color: #fff; }
    .word-count-tip { position: fixed; right: 20px; bottom: 80px; font-size: 0.89rem; color: #ccc; pointer-events: none; transition: opacity 0.3s; opacity: 0; }
    .word-count-tip.show { opacity: 1; }

    /* è¯¦æƒ…é¡µå¤´éƒ¨ (å…¨é€æ˜ä¿®æ”¹) */
    .detail-nav { 
        display: flex; align-items: center; justify-content: space-between; 
        padding: calc(10px + var(--safe-top)) 15px 10px 15px; 
        position: sticky; top: 0; 
        background: transparent;   /* å¼ºåˆ¶é€æ˜ */
        backdrop-filter: none;     /* å»æ‰ç£¨ç ‚ */
        z-index: 50; 
    }
    .d-user-info { display: flex; align-items: center; }
    .d-avatar { width: 30px; height: 30px; border-radius: 50%; margin-right: 8px; background: #eee; }
    .detail-body { padding-bottom: 70px; background: transparent; }
    .d-slider-container { position: relative; width: 100%; overflow: hidden; background: #000; }
    .d-slider { display: flex; overflow-x: auto; scroll-snap-type: x mandatory; -webkit-overflow-scrolling: touch; scrollbar-width: none; scroll-behavior: smooth; }
    .d-slider::-webkit-scrollbar { display: none; }
    .d-slider-item { flex: 0 0 100%; width: 100%; scroll-snap-align: center; scroll-snap-stop: always; display: flex; justify-content: center; align-items: center; background: #000; min-height: 250px; }
    .d-slider-item img { max-width: 100%; max-height: 80vh; object-fit: contain; display: block; }
    .d-slider-indicator { position: absolute; top: 15px; right: 15px; background: rgba(0,0,0,0.5); color: #fff; padding: 3px 8px; border-radius: 10px; font-size: 0.81rem; font-weight: bold; pointer-events: none; }
    .d-content { padding: 10px 20px; font-size: 1.11rem; line-height: 1.8; color: #333; white-space: normal; word-wrap: break-word; }
    /* Markdoom æ ·å¼ç³»ç»Ÿ */
    .d-content h1 { font-size: 1.7em; font-weight: 800; color: #111; margin: 25px 0 15px; letter-spacing: -0.5px; line-height: 1.3; }
    .d-content h2 { font-size: 1.4em; font-weight: 700; color: #333; margin: 20px 0 10px; border-bottom: 2px solid #f0f0f0; padding-bottom: 5px; }
    .d-content h3 { font-size: 1.15em; font-weight: 700; color: #555; margin: 15px 0 8px; }
    .d-content .md-subtext { font-size: 0.85em; color: #999; margin-top: -5px; margin-bottom: 10px; display: block; }
    .d-content .md-ul-item { padding-left: 20px; position: relative; margin-bottom: 4px; }
    .d-content .md-ul-item::before { content: ""; width: 6px; height: 6px; background: #333; border-radius: 50%; position: absolute; left: 6px; top: 10px; }
    .d-content .md-ol-item { padding-left: 0; margin-bottom: 4px; display: flex; }
    .d-content .md-ol-num { font-weight: bold; color: #333; margin-right: 8px; min-width: 20px; }
    .d-content b { font-weight: bold; color: #000; }
    .d-content i { font-style: italic; color: #666; font-family: Georgia, serif; }
    .d-content u { text-decoration: underline; text-decoration-thickness: 1px; text-underline-offset: 3px; }
    .d-content s { color: #ccc; text-decoration: line-through; }
    .d-content div { min-height: 1.5em; margin-bottom: 6px; }
    
    .d-content.text-mode { font-size: 1.19rem; line-height: 1.8; letter-spacing: 0.5px; text-align: left; padding: 15px; }
    .d-meta { padding: 8px 20px; font-size: 0.81rem; color: #bbb; display: flex; justify-content: space-between; margin-bottom: 15px; }
    .divider { height: 1px; background: #f0f0f0; margin: 0 20px; }
    .comments-section { padding: 15px; background: transparent; }
    .comment-item { display: flex; margin-bottom: 20px; }
    .c-avatar { width: 32px; height: 32px; border-radius: 50%; margin-right: 10px; background: #f0f0f0; }
    .c-right { flex: 1; }
    .c-top { display: flex; justify-content: space-between; margin-bottom: 3px; font-size: 0.89rem; color: #999; }
    .c-text { font-size: 1rem; line-height: 1.5; color: #333; }
    .c-date { font-size: 0.81rem; color: #ccc; margin-top: 4px; }
    
    /* è¯„è®ºè¾“å…¥æ  (åº”ç”¨åº•éƒ¨èƒŒæ™¯) */
    .input-bar { 
        position: fixed; bottom: 0; left: 0; width: 100%; 
        background: var(--bottom-bar-bg); 
        background-size: cover; background-position: center;
        backdrop-filter: blur(10px);
        box-shadow: 0 -1px 3px rgba(0,0,0,0.05); 
        padding: 6px 15px; padding-bottom: calc(6px + var(--safe-bottom)); 
        display: flex; align-items: center; z-index: 3002; 
    }
    .input-bar input { flex: 1; background: rgba(255,255,255,0.7); backdrop-filter: blur(5px); border-radius: 18px; padding: 8px 15px; border: 1px solid rgba(0,0,0,0.1); font-size: 0.96rem; margin-right: 10px; }
    .send-btn { color: #333; font-weight: bold; padding: 5px 10px; cursor: pointer; font-size: 0.96rem; }
    .static-input-bar { margin: 0; background: transparent; padding: 10px 20px; display: flex; align-items: center; }
    .static-input-bar input { flex: 1; background: rgba(255,255,255,0.8); border-radius: 20px; padding: 10px 15px; border: 1px solid rgba(0,0,0,0.1); font-size: 0.96rem; margin-right: 10px; backdrop-filter: blur(5px); }
    
    /* é˜…è¯»å·¥å…·æ  (åº”ç”¨åº•éƒ¨èƒŒæ™¯) */
    .reading-toolbar-bottom { 
        position: fixed; bottom: 0; left: 0; width: 100%; height: calc(50px + var(--safe-bottom)); 
        padding-bottom: var(--safe-bottom); 
        background: var(--bottom-bar-bg); 
        background-size: cover; background-position: center;
        backdrop-filter: blur(10px); 
        border-top: 1px solid #eee; display: none; justify-content: space-between; align-items: center; padding-left: 10px; padding-right: 10px; z-index: 3005; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); 
    }
    .rt-btn { flex: 1; text-align: center; color: #333; font-size: 0.96rem; font-weight: 500; cursor: pointer; padding: 10px; }
    .rt-btn:active { opacity: 0.6; }
    .rt-btn.disabled { color: #ccc; pointer-events: none; }
    
    .dir-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 4000; display: none; flex-direction: column; justify-content: flex-end; }
    .dir-panel { background: #fff; width: 100%; height: 70vh; border-radius: 16px 16px 0 0; display: flex; flex-direction: column; animation: slideUpDir 0.3s ease; padding-bottom: var(--safe-bottom); }
    .dir-header { padding: 12px; text-align: center; font-weight: bold; border-bottom: 1px solid #eee; font-size: 1.11rem; position: relative;}
    .dir-close { position: absolute; right: 15px; top: 12px; color: #999; cursor: pointer; }
    .dir-list { flex: 1; overflow-y: auto; padding: 10px 0; }
    .dir-item { padding: 12px 20px; font-size: 0.96rem; color: #333; border-bottom: 1px solid #f9f9f9; display: flex; justify-content: space-between; }
    .dir-item.active { color: var(--text-main); font-weight: bold; background: #f5f5f5; }
    .dir-item.active::after { content: 'å½“å‰'; font-size: 0.81rem; color: #999; font-weight: normal;}
    @keyframes slideUpDir { from { transform: translateY(100%); } to { transform: translateY(0); } }

    .post-html-preview { width: 100%; padding-top: 100%; height: 0; position: relative; background: #fff; overflow: hidden; }
    .post-html-preview iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; pointer-events: none; background: #fff; }

    .html-fab-add { position: fixed; bottom: calc(70px + var(--safe-bottom)); right: 20px; width: 50px; height: 50px; background: #fff; color: #333; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 2200; cursor: pointer; transition: transform 0.2s; }
    .html-fab-add:active { transform: scale(0.95); }
    .html-fab-add svg { width: 24px; height: 24px; stroke: currentColor; stroke-width: 2; }
    
    /* HTML å…¨å±è¯¦æƒ…é¡µæ ·å¼ */
    #view-html-detail { position: relative; width: 100%; height: 100%; overflow: hidden; background: #fff; }
    #html-iframe-wrapper { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
    #html-detail-iframe { width: 100%; height: 100%; border: none; background: #fff; }
    
    .html-action-bar {
        position: fixed; bottom: calc(20px + var(--safe-bottom)); left: 50%; transform: translateX(-50%);
        background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px);
        padding: 8px 15px; border-radius: 30px;
        display: flex; gap: 15px; align-items: center;
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        z-index: 3100; border: 1px solid rgba(0,0,0,0.05);
    }
    .hab-btn {
        width: 36px; height: 36px; border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        cursor: pointer; color: #333; transition: background 0.2s;
    }
    .hab-btn:active { background: rgba(0,0,0,0.05); }
    .hab-btn svg { width: 20px; height: 20px; stroke: currentColor; stroke-width: 2; fill: none; }

    .html-comment-sheet {
        position: fixed; bottom: 0; left: 0; width: 100%; height: 60vh;
        background: #fff; border-radius: 20px 20px 0 0;
        z-index: 3200; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        display: flex; flex-direction: column; box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
        padding-bottom: var(--safe-bottom);
    }
    .html-comment-sheet.active { transform: translateY(0); }
    .hcs-header { padding: 15px; text-align: center; font-weight: bold; border-bottom: 1px solid #eee; position: relative; color: #333; }
    .hcs-close { position: absolute; right: 15px; top: 15px; color: #999; cursor: pointer; }
    .hcs-body { flex: 1; overflow-y: auto; padding: 15px; }
    .hcs-footer { padding: 10px 15px; border-top: 1px solid #eee; display: flex; align-items: center; gap: 10px; }
    .hcs-input { flex: 1; background: #f5f5f5; border: none; border-radius: 20px; padding: 8px 15px; font-size: 0.96rem; }
    .hcs-send { color: #333; font-weight: bold; padding: 5px 10px; cursor: pointer; font-size: 0.96rem; }
    
    .sheet-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 3150; display: none; opacity: 0; transition: opacity 0.3s; }
    .sheet-overlay.active { display: block; opacity: 1; }

    .col-item { display: flex; padding: 12px; background: #fff; border-radius: 10px; margin: 12px; align-items: center; box-shadow: 0 1px 2px rgba(0,0,0,0.05); cursor: pointer; }
    .col-cover { width: 70px; height: 70px; border-radius: 10px; background: #eee; object-fit: cover; margin-right: 12px; }
    .col-info { flex: 1; }
    .col-title { font-size: 1.11rem; font-weight: bold; color: #333; margin-bottom: 4px; }
    .col-desc { font-size: 0.89rem; color: #999; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .cd-header { position: relative; height: 260px; overflow: hidden; color: #fff; display: flex; flex-direction: column; padding-top: var(--safe-top); }
    .cd-bg-layer { position: absolute; top:0; left:0; width:100%; height:100%; background-size: cover; background-position: center; filter: blur(20px) brightness(0.8); transform: scale(1.2); z-index: 1; }
    .cd-navbar { position: relative; z-index: 10; display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; height: 44px; }
    .cd-info-area { position: relative; z-index: 10; flex: 1; display: flex; flex-direction: column; padding: 0 20px 20px; }
    .cd-info-top { display: flex; gap: 15px; align-items: flex-start; margin-bottom: 15px; }
    .cd-cover { width: 90px; height: 90px; border-radius: 10px; object-fit: cover; background: #fff; flex-shrink: 0; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
    .cd-text { flex: 1; padding-top: 5px; }
    .cd-title { font-size: 1.33rem; font-weight: bold; margin-bottom: 6px; text-shadow: 0 1px 2px rgba(0,0,0,0.3); }
    .cd-meta { font-size: 0.81rem; opacity: 0.9; display: flex; align-items: center; gap: 5px; text-shadow: 0 1px 2px rgba(0,0,0,0.3); }
    .cd-user-avatar { width: 14px; height: 14px; border-radius: 50%; }
    .cd-stats { display: flex; justify-content: space-between; text-align: center; padding: 0 10px; }
    .cd-stat-item { flex: 1; }
    .cd-stat-num { font-size: 1.11rem; font-weight: bold; display: block; outline: 1px dashed transparent; }
    .cd-stat-num:focus { outline: 1px dashed rgba(255,255,255,0.5); background: rgba(0,0,0,0.2); border-radius:4px; }
    .cd-stat-label { font-size: 0.74rem; opacity: 0.7; margin-top: 4px; display: block; }
    .cd-body { position: relative; z-index: 20; background: transparent; border-radius: 16px 16px 0 0; margin-top: -16px; min-height: 500px; padding: 15px 10px 80px 10px; }
    .cd-footer { position: fixed; bottom: 0; left: 0; width: 100%; height: calc(60px + var(--safe-bottom)); padding-bottom: var(--safe-bottom); background: rgba(255,255,255,0.7); backdrop-filter: blur(10px); border-top: 1px solid rgba(255,255,255,0.3); z-index: 100; display: flex; align-items: center; justify-content: center; gap: 12px; padding: 0 20px; }
    .cd-btn { flex: 1; height: 40px; border-radius: 20px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.96rem; }
    .cd-btn-sub { background: #f0f0f0; color: #333; cursor: pointer;}
    .cd-btn-read { background: #333; color: #fff; cursor: pointer; }

    .profile-card { background: transparent; box-shadow: none; margin-top: -30px; border-radius: 16px 16px 0 0; position: relative; z-index: 5; padding-bottom: 20px; min-height: 600px; }
    .header-bg { width: 100%; height: 240px; background-color: #ddd; background-size: cover; background-position: center; }
    .avatar-area { position: relative; height: 50px; display: flex; justify-content: center; }
    .avatar-wrapper { position: absolute; top: -40px; width: 80px; height: 80px; background: #fff; border-radius: 50%; padding: 3px; }
    .avatar-img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
    .user-info { text-align: center; margin-top: 5px; }
    .user-name { font-size: 1.33rem; font-weight: bold; margin-bottom: 4px; outline: 1px dashed transparent; transition: outline 0.2s; }
    .user-name:focus, .editable-span:focus { outline: 1px dashed #333; background: rgba(0,0,0,0.02); }
    .user-meta { font-size: 0.81rem; color: #999; }
    .editable-span { border-bottom: none; }
    .profile-tab-container { display: flex; border-bottom: 1px solid rgba(0,0,0,0.05); background: transparent; margin-top: 10px; }
    .p-tab { flex: 1; text-align: center; padding: 12px 0; font-weight: bold; color: #999; cursor: pointer; transition: color 0.2s; font-size: 1.04rem; }
    .p-tab.active { color: #333; border-bottom: 2px solid #333; }
    .new-col-btn { margin: 15px; padding: 12px; background: #fff; border: 1px solid #eee; border-radius: 8px; text-align: center; color: #666; cursor: pointer; font-weight: bold; font-size: 0.96rem;}

    .theme-page { padding: calc(15px + var(--safe-top)) 15px 15px 15px; background: transparent; min-height: 100vh; }
    .btn-white { display: flex; justify-content: space-between; width: 100%; background: #fff; border: 1px solid #e0e0e0; border-radius: 8px; padding: 12px; margin-bottom: 10px; font-size: 0.96rem; cursor: pointer; }
    .theme-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px; }
    .theme-icon-box { background: #f9f9f9; border: 1px solid #eee; border-radius: 8px; padding: 12px; display: flex; flex-direction: column; align-items: center; cursor: pointer; }
    .theme-icon-box img { width: 28px; height: 28px; margin-bottom: 5px; object-fit: cover; }
    .theme-icon-box span { font-size: 0.81rem; color: #666; }
</style>
</head>
<body>

<div id="global-bg-layer"></div>

<div class="loading-mask" id="loadingMask">
    <div class="loading-spinner"></div>
    <div id="loadingText">å¤„ç†ä¸­...</div>
</div>

<div class="view-container">

    <!-- 1. ä¸»é¡µ -->
    <div id="view-home" class="view active">
        <div class="home-header" id="homeHeader">
            <div class="search-box">
                <svg class="icon" style="width:14px; height:14px; margin-right:5px; color:#666;" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                <input type="text" id="searchInput" placeholder="æœç´¢..." oninput="HomeRenderer.resetAndRender()">
            </div>
            <button style="background:none; border:none; padding:5px; margin-right:5px;" onclick="HomeRenderer.showFilterMenu()">
                <svg class="icon" style="color:#333;" viewBox="0 0 24 24"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>
            </button>
            <button style="background:none; border:none; padding:5px;" onclick="HomeRenderer.toggleLayout()">
                <svg id="layout-icon" class="icon" style="color:#333;" viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
            </button>
        </div>
        <div id="posts-list" class="posts-container mode-grid"></div>
        <div id="timeline-list" class="timeline-wrapper"></div>
        <div id="scroll-sentinel"></div>
        <div id="empty-state" style="text-align:center; padding:50px; color:#999; display:none;">è¿˜æ²¡æœ‰å†…å®¹<br><small>ç‚¹å‡»ä¸‹æ–¹ + å·å‘å¸ƒ</small></div>
    </div>

    <!-- HTML é¦–é¡µ -->
    <div id="view-html-home" class="view">
        <div id="html-posts-list" class="posts-container mode-grid"></div>
        <div id="html-empty-state" style="text-align:center; padding:50px; color:#999; display:none;">è¿™é‡Œç©ºç©ºå¦‚ä¹Ÿ<br><small>ç‚¹å‡»å³ä¸‹è§’ + åˆ›å»ºHTMLä½œå“</small></div>
        <div class="html-fab-add" onclick="Editor.open(null, 'html')"><svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg></div>
    </div>

    <!-- æ‰¹é‡æ“ä½œæ  -->
    <div class="batch-bar" id="batchBar">
        <div style="flex:1; text-align:center; color:#ff4d4f; font-weight:bold; cursor:pointer;" onclick="BatchMgr.deleteSelected()">æ‰¹é‡åˆ é™¤</div>
        <div style="width:1px; height:20px; background:#eee;"></div>
        <div style="flex:1; text-align:center; color:#333; font-weight:bold; cursor:pointer;" onclick="BatchMgr.addToCollection()">åŠ å…¥åˆé›†</div>
        <div style="width:1px; height:20px; background:#eee;"></div>
        <div style="flex:1; text-align:center; color:#666; cursor:pointer;" onclick="BatchMgr.exit()">å–æ¶ˆ</div>
    </div>

    <!-- 2. ç¼–è¾‘å™¨ -->
    <div id="view-editor" class="view">
        <div class="editor-header">
            <div onclick="Router.back()" style="font-size:1.04rem; color:#666;">å–æ¶ˆ</div>
            <div style="font-weight:bold;">å‘å¸ƒå†…å®¹</div>
            <div onclick="Editor.publish()" style="font-size:1.04rem; color:#333; font-weight:bold;">å‘å¸ƒ</div>
        </div>
        <div class="editor-content">
            <div class="editor-gallery" id="editor-gallery">
                <div id="img-upload-btn" class="image-upload-area" onclick="document.getElementById('post-img-input').click()">
                    <svg class="icon" viewBox="0 0 24 24" style="stroke:#ccc;"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
                    <span style="font-size:0.81rem; margin-top:5px;">æ·»åŠ å›¾ç‰‡</span>
                </div>
            </div>
            <input type="file" id="post-img-input" class="hidden-input" accept="image/*" multiple onchange="Editor.handleImages(this)">
            
            <div class="editor-input-group">
                <input type="text" id="post-title" placeholder="åŠ ä¸ªæ ‡é¢˜...">
                <textarea id="post-content" placeholder="è®°å½•è¿™ä¸€åˆ»..." oninput="Editor.updateWordCount()"></textarea>
                <div id="word-count-display" class="word-count-tip">0 å­—</div>
            </div>
        </div>
        <div class="editor-tools-bottom">
            <div class="et-left">
                <div class="col-pill-btn" id="editor-col-btn" onclick="Editor.openColPicker()">
                    <span id="editor-col-text">+ åŠ å…¥åˆé›†</span>
                    <div class="col-pill-remove" style="display:none;" onclick="Editor.removeCollection(event)">Ã—</div>
                </div>
            </div>
            <div class="et-right">
                <div class="bg-tool-btn" id="editor-bg-btn" onclick="document.getElementById('post-bg-file').click()">
                    <svg class="icon" style="width:18px; height:18px;" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
                </div>
                <input type="file" id="post-bg-file" class="hidden-input" accept="image/*" onchange="Editor.handlePostBg(this)">
            </div>
        </div>
    </div>

    <!-- 3. è¯¦æƒ…é¡µ -->
    <div id="view-detail" class="view">
        <div class="detail-nav">
            <div onclick="Router.back()" style="cursor:pointer;"><svg class="icon" viewBox="0 0 24 24"><path d="M15 18l-6-6 6-6"/></svg></div>
            <div class="d-user-info"><img id="d-avatar-img" src="" class="d-avatar"><span id="d-username" style="font-size:0.96rem; font-weight:500;"></span></div>
            <div onclick="ContextMenu.showDetailMenu(event, DetailRenderer.currentPostId)" style="cursor:pointer;">
                <svg class="icon" style="width:18px;" viewBox="0 0 24 24"><circle cx="12" cy="12" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="12" cy="19" r="1"/></svg>
            </div>
        </div>
        <div class="detail-body">
            <div id="d-body-content"></div>
            <div class="d-meta"><span id="d-date"></span></div>
            <div class="divider"></div>
            <div id="d-inline-input-area"></div>
            <div class="comments-section" id="d-comments-list"></div>
        </div>
        <div class="reading-toolbar-bottom" id="reading-toolbar">
            <div class="rt-btn" id="rt-prev" onclick="DetailRenderer.prevPost()">ä¸Šä¸€ç¯‡</div>
            <div class="rt-btn" onclick="DetailRenderer.showDirectory()">ç›®å½•</div>
            <div class="rt-btn" id="rt-next" onclick="DetailRenderer.nextPost()">ä¸‹ä¸€ç¯‡</div>
        </div>
        <div class="input-bar" id="float-input-bar">
            <input type="text" id="comment-input" placeholder="è‡ªè¨€è‡ªè¯­ä¸€ä¸‹...">
            <div class="send-btn" onclick="DetailRenderer.addComment()">å‘é€</div>
        </div>
    </div>

    <!-- ç›®å½• -->
    <div class="dir-overlay" id="dir-overlay" onclick="document.getElementById('dir-overlay').style.display='none'">
        <div class="dir-panel" onclick="event.stopPropagation()">
            <div class="dir-header">åˆé›†ç›®å½•<div class="dir-close" onclick="document.getElementById('dir-overlay').style.display='none'">Ã—</div></div>
            <div class="dir-list" id="dir-list-container"></div>
        </div>
    </div>

    <!-- HTML è¯¦æƒ…é¡µ -->
    <div id="view-html-detail" class="view">
        <div id="html-iframe-wrapper">
            <iframe id="html-detail-iframe" sandbox="allow-scripts allow-same-origin"></iframe>
        </div>
        
        <!-- æ‚¬æµ®æ“ä½œæ  -->
        <div class="html-action-bar">
            <div class="hab-btn" onclick="Router.back()">
                <svg viewBox="0 0 24 24"><path d="M15 18l-6-6 6-6"/></svg>
            </div>
            <div style="width:1px; height:16px; background:#eee;"></div>
            <div class="hab-btn" onclick="DetailRenderer.copyHtml()">
                <svg viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </div>
            <div class="hab-btn" onclick="DetailRenderer.toggleHtmlComments()">
                <svg viewBox="0 0 24 24"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>
            </div>
        </div>

        <!-- è¯„è®ºé¢æ¿é®ç½© -->
        <div class="sheet-overlay" id="html-sheet-overlay" onclick="DetailRenderer.toggleHtmlComments(false)"></div>
        
        <!-- è¯„è®ºé¢æ¿ -->
        <div class="html-comment-sheet" id="html-comment-sheet">
            <div class="hcs-header">
                è¯„è®º
                <div class="hcs-close" onclick="DetailRenderer.toggleHtmlComments(false)">Ã—</div>
            </div>
            <div class="hcs-body" id="html-comments-list-simple"></div>
            <div class="hcs-footer">
                <input type="text" id="html-comment-input" class="hcs-input" placeholder="è¯´ç‚¹ä»€ä¹ˆ...">
                <div class="hcs-send" onclick="DetailRenderer.addHtmlComment()">å‘é€</div>
            </div>
        </div>
    </div>

    <!-- åˆ›å»ºåˆé›† -->
    <div id="view-collection-create" class="view">
        <div class="editor-header">
            <div onclick="Router.back()" style="font-size:1.04rem; color:#666;">å–æ¶ˆ</div>
            <div style="font-weight:bold;">ç¼–è¾‘åˆé›†</div>
            <div onclick="ColMgr.save()" style="font-size:1.04rem; color:#333; font-weight:bold;">å®Œæˆ</div>
        </div>
        <div class="editor-content" style="padding:20px;">
            <div class="col-create-cover" onclick="document.getElementById('col-cover-input').click()">
                <span id="col-cover-tip" style="color:#ccc;">+ å°é¢</span>
                <img id="col-cover-preview">
            </div>
            <input type="file" id="col-cover-input" class="hidden-input" accept="image/*" onchange="ColMgr.handleCover(this)">
            <div class="editor-input-group">
                <input type="text" id="col-title-input" placeholder="åˆé›†åç§°">
                <textarea id="col-desc-input" placeholder="å†™ç‚¹ç®€ä»‹..." style="min-height:100px;"></textarea>
            </div>
        </div>
    </div>

    <!-- åˆé›†è¯¦æƒ… -->
    <div id="view-collection-detail" class="view">
        <div class="cd-header">
            <div class="cd-bg-layer" id="cd-bg"></div>
            <div class="cd-navbar">
                <div onclick="ProfileRenderer.returnToCols()" style="color:#fff; cursor:pointer;"><svg class="icon" viewBox="0 0 24 24"><path d="M15 18l-6-6 6-6"/></svg></div>
                <div style="color:#fff; cursor:pointer;" onclick="ColDetailMgr.showMenu()"><svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="2"/><circle cx="12" cy="5" r="2"/><circle cx="12" cy="19" r="2"/></svg></div>
            </div>
            <div class="cd-info-area">
                <div class="cd-info-top">
                    <img id="cd-cover" class="cd-cover" src="">
                    <div class="cd-text">
                        <div class="cd-title" id="cd-title">åˆé›†æ ‡é¢˜</div>
                        <div class="cd-meta">
                            <img id="cd-avatar" class="cd-user-avatar">
                            <span id="cd-author">åˆ›å»ºè€…</span>
                        </div>
                    </div>
                </div>
                <div class="cd-stats">
                    <div class="cd-stat-item"><span class="cd-stat-num" id="cd-stat-sub" contenteditable="true" onblur="ColDetailMgr.saveStat(this, 'sub')">0</span><span class="cd-stat-label">è®¢é˜…æ•°</span></div>
                    <div class="cd-stat-item"><span class="cd-stat-num" id="cd-stat-hot" contenteditable="true" onblur="ColDetailMgr.saveStat(this, 'hot')">0</span><span class="cd-stat-label">æ€»çƒ­åº¦</span></div>
                    <div class="cd-stat-item"><span class="cd-stat-num" id="cd-stat-view" contenteditable="true" onblur="ColDetailMgr.saveStat(this, 'view')">0</span><span class="cd-stat-label">æµè§ˆæ•°</span></div>
                </div>
            </div>
        </div>
        <div class="cd-body">
            <div id="cd-post-list" class="posts-container mode-grid" style="padding:0; margin-top:15px;"></div>
            <div id="cd-empty" style="text-align:center; padding:50px; color:#ccc; display:none;">
                <svg width="50" height="50" viewBox="0 0 24 24" fill="none" stroke="#ddd" stroke-width="1"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>
                <div style="margin-top:10px; font-size:0.81rem;">ä½œè€…è¿˜åœ¨åŠ æ²¹åˆ›ä½œä¸­</div>
            </div>
        </div>
        <div class="cd-footer">
            <div class="cd-btn cd-btn-sub" onclick="ColDetailMgr.toggleSubscribe(this)">è®¢é˜…åˆé›†</div>
            <div class="cd-btn cd-btn-read" onclick="ColDetailMgr.startReading()">å¼€å§‹é˜…è¯»</div>
        </div>
    </div>

    <!-- ä¸ªäººä¸»é¡µ -->
    <div id="view-profile" class="view">
        <div class="header-bg" id="profileBg" onclick="document.getElementById('bgInput').click()">
            <input type="file" id="bgInput" class="hidden-input" accept="image/*" onchange="updateImage(this, 'profileBg', 'bg')">
        </div>
        <div class="profile-card">
            <div class="avatar-area">
                <div class="avatar-wrapper" onclick="document.getElementById('avatarInput').click()">
                    <img id="avatarImg" src="https://api.dicebear.com/7.x/avataaars/svg?seed=Jiang" class="avatar-img">
                    <input type="file" id="avatarInput" class="hidden-input" accept="image/*" onchange="updateImage(this, 'avatarImg', 'img')">
                </div>
            </div>
            <div class="user-info">
                <div class="user-name" id="userName" contenteditable="true" onblur="saveProfileMeta()">æ±Ÿå¿±</div>
                <div class="user-meta">
                    <span>ID: <span id="userId" class="editable-span" contenteditable="true" onblur="saveProfileMeta()">123456789</span></span>
                    <span style="margin:0 5px;">|</span>
                    <span>IP: <span id="userIp" class="editable-span" contenteditable="true" onblur="saveProfileMeta()">ä¸­å›½å°æ¹¾</span></span>
                </div>
            </div>
            <div class="profile-tab-container">
                <div class="p-tab active" id="ptab-posts" onclick="ProfileRenderer.switchTab('posts')">å¸–å­</div>
                <div class="p-tab" id="ptab-cols" onclick="ProfileRenderer.switchTab('cols')">åˆé›†</div>
            </div>
            <div id="profile-posts-area">
                <div id="profile-posts-list" class="posts-container mode-list" style="padding:0 12px;"></div>
                <div id="profile-empty" style="text-align:center; padding:30px; color:#ddd; display:none;">æš‚æ— å†…å®¹</div>
            </div>
            <div id="profile-cols-area" style="display:none;">
                <div class="new-col-btn" onclick="ColMgr.openCreate()">+ æ–°å»ºåˆé›†</div>
                <div id="col-list-container"></div>
            </div>
        </div>
    </div>

    <!-- è®¾ç½®é¡µ -->
    <div id="view-theme" class="view">
        <div class="theme-page">
            <h2 style="margin-bottom:20px;">è®¾ç½®ä¸å¤‡ä»½</h2>
            
            <div style="font-size:12px; color:#999; margin:20px 0 8px;">æ•°æ®å¯¼å‡º</div>
            <div class="btn-white" onclick="DBMgr.showExportYearMenu()">
                <span>å¤‡ä»½æ•°æ® (æ”¯æŒé€‰æ‹©ä¿å­˜ä½ç½®)</span>
                <span style="color:#999;font-size:0.89rem;">ZIP</span>
            </div>
            <div class="btn-white" onclick="DBMgr.exportTextOnly()">
                <span>ä»…å¯¼å‡ºæ–‡å­— (JSON)</span>
                <span style="color:#999;font-size:0.89rem;">è½»é‡çº§</span>
            </div>

            <div style="font-size:0.89rem; color:#999; margin:20px 0 8px;">æ•°æ®å¯¼å…¥</div>
            <div class="btn-white" style="position:relative;">
                <span>æ¢å¤æ•°æ® (é€‰æ‹© ZIP æˆ– JSON æ–‡ä»¶)</span>
                <input type="file" class="hidden-input" style="display:block; opacity:0; position:absolute; top:0; left:0; width:100%; height:100%;" onchange="DBMgr.importData(this)">
            </div>
            <div class="btn-white" onclick="DBMgr.clearAll()" style="color:red; margin-top:10px;"><span>æ¸…ç©ºæ‰€æœ‰æ•°æ®</span></div>

            <div style="font-size:0.89rem; color:#999; margin:20px 0 8px;">äº‘ç«¯å¤‡ä»½ (GitHub)</div>
            <div class="btn-white" style="display:block; cursor:default;">
                <div onclick="const el=document.getElementById('gh-config-area'); const icon=this.querySelector('.toggle-icon'); if(el.style.display==='none'){el.style.display='block'; icon.style.transform='rotate(180deg)';}else{el.style.display='none'; icon.style.transform='rotate(0deg)';}" style="display:flex; justify-content:space-between; align-items:center; cursor:pointer; padding-bottom:5px;">
                    <div style="display:flex; align-items:center;">
                        <span style="color:#333; font-weight:500;">ğŸ”§ é…ç½®å‚æ•°</span>
                        <div onclick="event.stopPropagation(); document.getElementById('gh-help-overlay').style.display='flex';" style="margin-left:8px; display:flex; align-items:center; padding:2px;">
                            <svg style="width:16px; height:16px; color:#1890ff;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                        </div>
                    </div>
                    <svg class="toggle-icon" style="width:14px; height:14px; color:#999; transition:transform 0.3s;" viewBox="0 0 24 24"><polyline points="6 9 12 15 18 9" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></polyline></svg>
                </div>
                <div id="gh-config-area" style="display:none; margin-top:10px; padding-top:10px; border-top:1px dashed #eee;">
                    <div style="margin-bottom:10px;">
                        <div style="font-size:0.81rem; color:#666; margin-bottom:5px;">GitHub Token</div>
                        <div style="position:relative;">
                            <input type="password" id="gh-token-input" placeholder="ghp_xxxx..." style="width:100%; border:1px solid #eee; padding:8px; padding-right:35px; border-radius:4px; font-size:0.89rem;" onchange="GitHubMgr.saveConfig()">
                            <div onclick="const input=document.getElementById('gh-token-input'); const type=input.getAttribute('type')==='password'?'text':'password'; input.setAttribute('type', type); this.innerHTML=type==='text'?'<svg viewBox=\'0 0 24 24\' width=\'16\' height=\'16\' stroke=\'currentColor\' stroke-width=\'2\' fill=\'none\' stroke-linecap=\'round\' stroke-linejoin=\'round\'><path d=\'M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24\'></path><line x1=\'1\' y1=\'1\' x2=\'23\' y2=\'23\'></line></svg>':'<svg viewBox=\'0 0 24 24\' width=\'16\' height=\'16\' stroke=\'currentColor\' stroke-width=\'2\' fill=\'none\' stroke-linecap=\'round\' stroke-linejoin=\'round\'><path d=\'M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z\'></path><circle cx=\'12\' cy=\'12\' r=\'3\'></circle></svg>';" style="position:absolute; right:10px; top:50%; transform:translateY(-50%); color:#999; cursor:pointer; display:flex;">
                                <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                            </div>
                        </div>
                    </div>
                    <div style="margin-bottom:10px;">
                        <div style="font-size:0.81rem; color:#666; margin-bottom:5px;">ä»“åº“è·¯å¾„ (ç”¨æˆ·å/ä»“åº“å)</div>
                        <input type="text" id="gh-repo-input" placeholder="username/repo" style="width:100%; border:1px solid #eee; padding:8px; border-radius:4px; font-size:0.89rem;" onchange="GitHubMgr.saveConfig()">
                    </div>
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px; border-top:1px solid #f5f5f5; padding-top:10px;">
                    <span>è‡ªåŠ¨å¤‡ä»½å¼€å…³</span>
                    <label class="switch" style="position:relative; display:inline-block; width:40px; height:24px;">
                        <input type="checkbox" id="gh-auto-switch" style="opacity:0; width:0; height:0;" onchange="GitHubMgr.saveConfig()">
                        <span style="position:absolute; cursor:pointer; top:0; left:0; right:0; bottom:0; background-color:#ccc; transition:.4s; border-radius:24px;" id="gh-switch-slider"></span>
                        <style>
                            #gh-auto-switch:checked + #gh-switch-slider { background-color: #333; }
                            #gh-switch-slider:before { position:absolute; content:""; height:16px; width:16px; left:4px; bottom:4px; background-color:white; transition:.4s; border-radius:50%; }
                            #gh-auto-switch:checked + #gh-switch-slider:before { transform: translateX(16px); }
                        </style>
                    </label>
                </div>
                <div id="gh-interval-setting" style="display:none; justify-content:space-between; align-items:center; margin-top:10px;">
                    <span style="font-size:0.89rem; color:#666;">å¤‡ä»½é¢‘ç‡</span>
                    <select id="gh-interval-select" style="border:1px solid #eee; padding:5px; border-radius:4px; font-size:0.89rem; background:#fff;" onchange="GitHubMgr.saveConfig()">
                        <option value="24">æ¯ 24 å°æ—¶</option>
                        <option value="36">æ¯ 36 å°æ—¶</option>
                        <option value="48">æ¯ 48 å°æ—¶</option>
                    </select>
                </div>
                <div style="margin-top:15px; display:flex; gap:10px;">
                    <div style="flex:1; background:#333; color:#fff; text-align:center; padding:8px; border-radius:4px; font-size:0.89rem; cursor:pointer;" onclick="GitHubMgr.testUpload()">ç«‹å³å¤‡ä»½</div>
                    <div style="flex:1; background:#f5f5f5; color:#666; text-align:center; padding:8px; border-radius:4px; font-size:0.89rem; cursor:pointer;" onclick="GitHubMgr.checkStatus()">æ£€æŸ¥çŠ¶æ€</div>
                </div>
                <div id="gh-status-msg" style="margin-top:10px; font-size:0.74rem; color:#999;"></div>
            </div>

            <div style="font-size:0.89rem; color:#999; margin:20px 0 8px;">æ ç›®å¤–è§‚</div>
            <!-- ç§»é™¤äº†é¡¶éƒ¨æ èƒŒæ™¯è®¾ç½®ï¼Œå› ä¸ºå·²ç»å¼ºåˆ¶é€æ˜äº† -->
            <div class="btn-white" onclick="document.getElementById('bottomBarInput').click()"><span>åº•éƒ¨æ èƒŒæ™¯</span><input type="file" id="bottomBarInput" class="hidden-input" accept="image/*" onchange="ThemeMgr.setBarBg('bottom', this)"></div>
            <div class="btn-white" onclick="document.getElementById('globalBgInput').click()"><span>å…¨å±€èƒŒæ™¯å›¾</span><input type="file" id="globalBgInput" class="hidden-input" accept="image/*" onchange="setGlobalBg(this)"></div>
            <div class="btn-white" onclick="document.getElementById('postBgInput').click()"><span>å¸–å­é»˜è®¤åç‰‡èƒŒæ™¯</span><input type="file" id="postBgInput" class="hidden-input" accept="image/*" onchange="ThemeMgr.setPostBg(this)"></div>

            <div style="font-size:0.89rem; color:#999; margin:20px 0 8px;">å­—ä½“è®¾ç½®</div>
            <div class="btn-white" onclick="FontMgr.showMenu()"><span>å­—ä½“ç®¡ç†</span><span id="current-font-name" style="color:#999;font-size:0.89rem;">é»˜è®¤</span></div>
            <div class="btn-white" style="display:block; padding-bottom:5px;">
                <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                    <span>å…¨å±€å­—å·</span>
                    <span id="font-size-val" style="color:#999;font-size:0.89rem;">13.5px</span>
                </div>
                <input type="range" min="10" max="22" step="0.5" value="13.5" id="fontSizeSlider" style="width:100%; height:4px;" oninput="ThemeMgr.setFontSize(this.value)">
            </div>

            <div style="font-size:0.89rem; color:#999; margin:20px 0 8px;">åº•éƒ¨å›¾æ ‡</div>
            <div class="theme-grid">
                <div class="theme-icon-box" onclick="document.getElementById('icon1Input').click()"><img id="icon1Preview" src=""><span style="margin-top:5px;">é¦–é¡µ</span><input type="file" id="icon1Input" class="hidden-input" accept="image/*" onchange="ThemeMgr.setIcon(0, this)"></div>
                <div class="theme-icon-box" onclick="document.getElementById('icon2Input').click()"><img id="icon2Preview" src=""><span style="margin-top:5px;">HTML</span><input type="file" id="icon2Input" class="hidden-input" accept="image/*" onchange="ThemeMgr.setIcon(1, this)"></div>
                <div class="theme-icon-box" onclick="document.getElementById('icon3Input').click()"><img id="icon3Preview" src=""><span style="margin-top:5px;">å‘å¸ƒ</span><input type="file" id="icon3Input" class="hidden-input" accept="image/*" onchange="ThemeMgr.setIcon(2, this)"></div>
                <div class="theme-icon-box" onclick="document.getElementById('icon4Input').click()"><img id="icon4Preview" src=""><span style="margin-top:5px;">æˆ‘çš„</span><input type="file" id="icon4Input" class="hidden-input" accept="image/*" onchange="ThemeMgr.setIcon(3, this)"></div>
                <div class="theme-icon-box" onclick="document.getElementById('icon5Input').click()"><img id="icon5Preview" src=""><span style="margin-top:5px;">è®¾ç½®</span><input type="file" id="icon5Input" class="hidden-input" accept="image/*" onchange="ThemeMgr.setIcon(4, this)"></div>
            </div>
            <div class="btn-white" onclick="ThemeMgr.resetAll()" style="margin-top:20px;"><span>é‡ç½®ç¾åŒ–è®¾ç½®</span></div>
        </div>
    </div>

    <!-- åº•éƒ¨å¯¼èˆª -->
    <div class="bottom-bar" id="bottomBar">
        <div class="nav-item active" onclick="Router.go('home', this)" id="nav-0"><svg class="icon" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg></div>
        <div class="nav-item" onclick="Router.go('html-home', this)" id="nav-1"><svg class="icon" viewBox="0 0 24 24"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg></div>
        <div class="nav-item" id="nav-2">
            <div class="nav-icon-plus" onclick="Editor.open()">
                <svg viewBox="0 0 24 24" id="svg-plus"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            </div>
        </div>
        <div class="nav-item" onclick="Router.go('profile', this)" id="nav-3"><svg class="icon" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></div>
        <div class="nav-item" onclick="Router.go('theme', this)" id="nav-4"><svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg></div>
    </div>
</div>

<div class="image-viewer-overlay" id="imageViewer" onclick="ImageViewer.close()">
    <div class="iv-img-wrapper"><img id="iv-img" src="" onclick="event.stopPropagation()"></div>
    <div class="iv-controls" onclick="event.stopPropagation()">
        <div class="iv-btn" onclick="ImageViewer.download()">
            <svg class="icon" style="width:16px; height:16px;" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>ä¿å­˜å›¾ç‰‡
        </div>
        <div class="iv-btn" onclick="ImageViewer.close()">å…³é—­</div>
    </div>
</div>

<div class="overlay" id="contextOverlay" onclick="ContextMenu.hide()">
    <div class="context-menu" id="contextMenuBody" onclick="event.stopPropagation()"></div>
</div>

<div class="overlay" id="colSelectOverlay" onclick="document.getElementById('colSelectOverlay').style.display='none'">
    <div class="context-menu" id="colSelectMenu" onclick="event.stopPropagation()">
        <div style="padding:15px; font-weight:bold; border-bottom:1px solid #eee;">æ·»åŠ åˆ°åˆé›†</div>
        <div id="colSelectOptions" style="max-height:300px; overflow-y:auto;"></div>
        <div class="menu-item" onclick="document.getElementById('colSelectOverlay').style.display='none'">å–æ¶ˆ</div>
    </div>
</div>

<!-- å¹´ä»½å¯¼å‡ºé€‰æ‹©å¼¹çª— -->
<div class="overlay" id="exportYearOverlay" onclick="document.getElementById('exportYearOverlay').style.display='none'">
    <div class="context-menu" onclick="event.stopPropagation()">
        <div style="padding:15px; font-weight:bold; border-bottom:1px solid #eee; text-align:center;">é€‰æ‹©å¯¼å‡ºå¹´ä»½</div>
        <div id="exportYearOptions" style="max-height:300px; overflow-y:auto;"></div>
        <div class="menu-item" style="color:#666;" onclick="document.getElementById('exportYearOverlay').style.display='none'">å–æ¶ˆ</div>
    </div>
</div>

<!-- å­—ä½“ç®¡ç†å¼¹çª— -->
<div class="overlay" id="fontOverlay" onclick="document.getElementById('fontOverlay').style.display='none'">
    <div class="context-menu" style="height:60vh; display:flex; flex-direction:column;" onclick="event.stopPropagation()">
        <div style="padding:15px; font-weight:bold; border-bottom:1px solid #eee; text-align:center; display:flex; justify-content:space-between; align-items:center;">
            <span>å­—ä½“ç®¡ç†</span>
            <div style="font-size:12px; color:#333; background:#f0f0f0; padding:4px 8px; border-radius:4px; cursor:pointer;" onclick="FontMgr.addFontClick()">+ æ·»åŠ </div>
        </div>
        <div id="font-list-container" style="flex:1; overflow-y:auto;"></div>
        <div class="menu-item" style="color:#666; border-top:1px solid #eee;" onclick="document.getElementById('fontOverlay').style.display='none'">å…³é—­</div>
    </div>
</div>
<!-- æ·»åŠ å­—ä½“å­å¼¹çª— -->
<div class="overlay" id="addFontOverlay" style="z-index: 4100;" onclick="document.getElementById('addFontOverlay').style.display='none'">
    <div class="context-menu" onclick="event.stopPropagation()">
        <div style="padding:15px; font-weight:bold; border-bottom:1px solid #eee; text-align:center;">æ·»åŠ æ–°å­—ä½“</div>
        <div class="menu-item" onclick="document.getElementById('font-file-input').click()">ä¸Šä¼ æœ¬åœ°å­—ä½“æ–‡ä»¶ (.ttf/.otf/.woff)</div>
        <input type="file" id="font-file-input" class="hidden-input" accept=".ttf,.otf,.woff,.woff2" onchange="FontMgr.handleFileSelect(this)">
        <div class="menu-item" onclick="FontMgr.addByUrl()">è¾“å…¥ç½‘ç»œå­—ä½“ URL</div>
        <div class="menu-item" style="color:#666;" onclick="document.getElementById('addFontOverlay').style.display='none'">å–æ¶ˆ</div>
    </div>
</div>

<!-- GitHub å¸®åŠ©å¼¹çª— -->
<div class="overlay" id="gh-help-overlay" onclick="this.style.display='none'" style="z-index:6000;">
    <div class="context-menu" onclick="event.stopPropagation()" style="padding:20px; max-height:80vh; overflow-y:auto; width:85%;">
        <h3 style="margin-bottom:15px; text-align:center; font-size:1.1rem;">GitHub é…ç½®æŒ‡å—</h3>
        
        <h4 style="margin:10px 0 5px; color:#333;">1. è·å– Token</h4>
        <ol style="padding-left:20px; font-size:0.89rem; color:#555; line-height:1.6;">
            <li>ç™»å½• GitHubï¼Œç‚¹å‡»å³ä¸Šè§’å¤´åƒ <br>â†’ <strong>Settings</strong></li>
            <li>å·¦ä¾§èœå•æ»‘åˆ°åº• <br>â†’ <strong>Developer settings</strong></li>
            <li>ç‚¹å‡» <strong>Personal access tokens</strong> <br>â†’ <strong>Tokens (classic)</strong></li>
            <li>ç‚¹å‡» <strong>Generate new token (classic)</strong></li>
            <li>Note éšä¾¿å¡«ï¼ŒExpiration å»ºè®®é€‰ No expiration (æ°¸ä¸è¿‡æœŸ)</li>
            <li><strong>Scopes å¿…é¡»å‹¾é€‰ <code style="background:#eee;padding:2px 4px;border-radius:3px;">repo</code> (åŒ…å«æ‰€æœ‰å­é¡¹)</strong></li>
            <li>ç‚¹å‡»é¡µåº• Generate tokenï¼Œé¡µé¢ä¼šæ˜¾ç¤ºä¸€ä¸²ä»¥ <code>ghp_</code> å¼€å¤´çš„å­—ç¬¦ã€‚<br><strong style="color:#ff4d4f;">ä¸€å®šè¦ç°åœ¨å¤åˆ¶å¹¶ä¿å­˜å¥½ï¼ä¸€æ—¦åˆ·æ–°é¡µé¢ï¼Œä½ å°±å†ä¹Ÿçœ‹ä¸åˆ°å®ƒäº†ã€‚</strong></li>
        </ol>

        <h4 style="margin:15px 0 5px; color:#333;">2. åˆ›å»ºä»“åº“</h4>
        <ol style="padding-left:20px; font-size:0.89rem; color:#555; line-height:1.6;">
            <li>ç‚¹å‡»å³ä¸Šè§’ + å· â†’ <strong>New repository</strong></li>
            <li>Repository name å¡«ä¸ªåå­—ï¼ˆå¦‚ my-backupï¼‰</li>
            <li>å»ºè®®é€‰ <strong>Private</strong> (ç§æœ‰)</li>
            <li>ç‚¹å‡» Create repository</li>
        </ol>

        <h4 style="margin:15px 0 5px; color:#333;">3. å¡«å†™ç¤ºä¾‹</h4>
        <ul style="padding-left:20px; font-size:0.89rem; color:#555; line-height:1.6;">
            <li><strong>Token:</strong> <code>ghp_xxxxxxxxxxxx...</code></li>
            <li><strong>ä»“åº“è·¯å¾„:</strong> <code>ç”¨æˆ·å/ä»“åº“å</code> <br><span style="font-size:0.81rem;color:#999;">(ä¾‹å¦‚: zhangsan/my-backup)</span></li>
        </ul>

        <div class="menu-item" style="margin-top:20px; background:#f5f5f5; border-radius:8px; font-weight:bold;" onclick="document.getElementById('gh-help-overlay').style.display='none'">æˆ‘å­¦ä¼šäº†</div>
    </div>
</div>

<script>
    // Markdoom è§£æå™¨ (è½»é‡çº§ Markdown)
    function parseMarkdoom(text) {
        if (!text) return '';
        const lines = text.split('\n');
        let html = '';
        
        lines.forEach(line => {
            let l = line;
            let rowHtml = '';
            
            // 1. æ ‡é¢˜ (#, ##, ###)
            if (l.match(/^###\s/)) {
                rowHtml = `<h3>${parseInline(l.substring(4))}</h3>`;
            } else if (l.match(/^##\s/)) {
                rowHtml = `<h2>${parseInline(l.substring(3))}</h2>`;
            } else if (l.match(/^#\s/)) {
                rowHtml = `<h1>${parseInline(l.substring(2))}</h1>`;
            }
            // 2. å‰¯æ–‡æœ¬ (-#)
            else if (l.match(/^-#\s/)) {
                rowHtml = `<span class="md-subtext">${parseInline(l.substring(3))}</span>`;
            }
            // 3. æ— åºåˆ—è¡¨ (* æˆ– -)
            else if (l.match(/^[\*\-]\s/)) {
                rowHtml = `<div class="md-ul-item">${parseInline(l.substring(2))}</div>`;
            }
            // 4. æœ‰åºåˆ—è¡¨ (1. )
            else if (l.match(/^\d+\.\s/)) {
                const match = l.match(/^(\d+\.)\s(.*)/);
                if (match) {
                    rowHtml = `<div class="md-ol-item"><span class="md-ol-num">${match[1]}</span><span>${parseInline(match[2])}</span></div>`;
                } else {
                     rowHtml = `<div>${parseInline(l)}</div>`;
                }
            }
            // 5. æ™®é€šæ–‡æœ¬
            else {
                if (l.trim() === '') rowHtml = '<div style="height:10px"></div>';
                else rowHtml = `<div>${parseInline(l)}</div>`;
            }
            html += rowHtml;
        });
        return html;
    }

    function parseInline(str) {
        if (!str) return '';
        let s = str;
        // åŸºç¡€ XSS é˜²æŠ¤
        s = s.replace(/&/g, "&").replace(/</g, "<").replace(/>/g, ">");
        
        // 1. åŠ ç²—æ–œä½“ (***)
        s = s.replace(/\*\*\*(.*?)\*\*\*/g, '<b><i>$1</i></b>');
        // 2. åŠ ç²— (**)
        s = s.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
        // 3. æ–œä½“ (*)
        s = s.replace(/\*([^\s\*].*?)\*/g, '<i>$1</i>');
        // 4. ä¸‹åˆ’çº¿ (__)
        s = s.replace(/__(.*?)__/g, '<u>$1</u>');
        // 5. åˆ é™¤çº¿ (~~)
        s = s.replace(/~~(.*?)~~/g, '<s>$1</s>');
        
        return s;
    }

    // é€šç”¨ä¿å­˜æ–‡ä»¶å‡½æ•° - æ ¸å¿ƒä¿®æ”¹ï¼šä½¿ç”¨ç³»ç»Ÿåˆ†äº«è®©ç”¨æˆ·é€‰æ‹©
    function saveFileUniversal(blob, fileName) {
        if (window.plus) {
            document.getElementById('loadingText').innerText = 'æ­£åœ¨è°ƒèµ·ç³»ç»Ÿä¿å­˜...';
            // 1. å…ˆä¿å­˜åˆ°ç§æœ‰æ–‡æ¡£ç›®å½• (ä¸´æ—¶å­˜æ”¾)
            plus.io.requestFileSystem(plus.io.PRIVATE_DOC, function(fs) {
                fs.root.getFile(fileName, { create: true }, function(fileEntry) {
                    fileEntry.createWriter(function(writer) {
                        writer.onwriteend = function() {
                            document.getElementById('loadingMask').style.display = 'none';
                            // 2. å†™å…¥æˆåŠŸåï¼Œè°ƒç”¨ç³»ç»Ÿåˆ†äº«åŠŸèƒ½
                            // è¿™æ ·ç”¨æˆ·å¯ä»¥é€‰æ‹© "ä¿å­˜åˆ°æ–‡ä»¶"ã€"å‘é€åˆ°å¾®ä¿¡"ã€"å‘é€åˆ°ç½‘ç›˜" ç­‰
                            plus.share.sendWithSystem({
                                type: 'text', // æˆ–è€… 'image' ä½†å¯¹äºzipé€šå¸¸ç”¨é€šç”¨åˆ†äº«
                                content: 'æˆ‘çš„å¤‡ä»½æ•°æ®', 
                                href: fileEntry.toURL(),
                                title: fileName
                            }, function(){
                                console.log('åˆ†äº«æˆåŠŸ');
                            }, function(e){
                                console.log('åˆ†äº«å¤±è´¥: ' + JSON.stringify(e));
                            });
                        };
                        writer.onerror = function(e) { alert('å†™å…¥ä¸´æ—¶æ–‡ä»¶å¤±è´¥: ' + e.message); };
                        writer.write(blob); 
                    }, function(e) { alert('æ— æ³•åˆ›å»ºå†™å…¥å™¨: ' + e.message); });
                }, function(e) { alert('æ— æ³•åˆ›å»ºæ–‡ä»¶: ' + e.message); });
            }, function(e) { alert('æ— æ³•è®¿é—®æ–‡ä»¶ç³»ç»Ÿ: ' + e.message); });
        } else {
            // æµè§ˆå™¨ç¯å¢ƒä¿æŒåŸæ ·
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = fileName;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
            setTimeout(() => URL.revokeObjectURL(url), 10000);
            document.getElementById('loadingMask').style.display = 'none';
        }
    }

    const DBMgr = {
        dbName: 'LofterArchiveDB', dbVersion: 3, db: null,
        init: () => new Promise((resolve, reject) => {
            const request = indexedDB.open(DBMgr.dbName, DBMgr.dbVersion);
            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                if (!db.objectStoreNames.contains('posts')) db.createObjectStore('posts', { keyPath: 'id' });
                if (!db.objectStoreNames.contains('collections')) db.createObjectStore('collections', { keyPath: 'id' });
                if (!db.objectStoreNames.contains('fonts')) db.createObjectStore('fonts', { keyPath: 'id' });
            };
            request.onsuccess = (event) => { DBMgr.db = event.target.result; resolve(DBMgr.db); }; request.onerror = (event) => reject(event);
        }),
        getAllPostMeta: async () => {
            if(!DBMgr.db) await DBMgr.init();
            return new Promise((resolve) => {
                const tx = DBMgr.db.transaction(['posts'], 'readonly');
                const store = tx.objectStore('posts');
                const metaList = [];
                const request = store.openCursor(); 
                request.onsuccess = (event) => {
                    const cursor = event.target.result;
                    if (cursor) {
                        const p = cursor.value;
                        metaList.push({ 
                            id: p.id, date: p.date, isTop: p.isTop, type: p.type, 
                            searchString: (p.title + (p.content ? p.content.slice(0, 50) : '')).toLowerCase(), 
                            hasImage: (p.images && p.images.length > 0) || !!p.image 
                        });
                        cursor.continue();
                    } else { resolve(metaList); }
                };
            });
        },
        getPostsBatch: async (ids) => {
            if(!DBMgr.db) await DBMgr.init();
            return new Promise((resolve) => {
                const tx = DBMgr.db.transaction(['posts'], 'readonly');
                const store = tx.objectStore('posts');
                const results = [];
                let completed = 0;
                if(ids.length === 0) resolve([]);
                ids.forEach(id => {
                    const req = store.get(id);
                    req.onsuccess = (e) => { results.push(e.target.result); completed++; if(completed === ids.length) { const ordered = ids.map(id => results.find(r => r && r.id === id)).filter(x => x); resolve(ordered); } };
                    req.onerror = () => { completed++; if(completed === ids.length) resolve(results); };
                });
            });
        },
        getPost: async (id) => { if(!DBMgr.db) await DBMgr.init(); return new Promise((resolve) => { const request = DBMgr.db.transaction(['posts'], 'readonly').objectStore('posts').get(id); request.onsuccess = () => resolve(request.result); }); },
        savePost: async (post) => { if(!DBMgr.db) await DBMgr.init(); return new Promise((resolve) => { const tx = DBMgr.db.transaction(['posts'], 'readwrite'); tx.objectStore('posts').put(post); tx.oncomplete = () => resolve(true); }); },
        deletePost: async (id) => { if(!DBMgr.db) await DBMgr.init(); return new Promise((resolve) => { const tx = DBMgr.db.transaction(['posts'], 'readwrite'); tx.objectStore('posts').delete(id); tx.oncomplete = () => resolve(true); }); },
        getAllCollections: async () => { if(!DBMgr.db) await DBMgr.init(); return new Promise((resolve) => { const request = DBMgr.db.transaction(['collections'], 'readonly').objectStore('collections').getAll(); request.onsuccess = () => resolve(request.result || []); }); },
        saveCollection: async (col) => { if(!DBMgr.db) await DBMgr.init(); return new Promise((resolve) => { const request = DBMgr.db.transaction(['collections'], 'readwrite').objectStore('collections').put(col); request.onsuccess = () => resolve(true); }); },
        deleteCollection: async (id) => { if(!DBMgr.db) await DBMgr.init(); return new Promise((resolve) => { const tx = DBMgr.db.transaction(['collections'], 'readwrite'); tx.objectStore('collections').delete(id); tx.oncomplete = () => resolve(true); }); },
        saveFont: async (font) => { if(!DBMgr.db) await DBMgr.init(); return new Promise((resolve) => { const tx = DBMgr.db.transaction(['fonts'], 'readwrite'); tx.objectStore('fonts').put(font); tx.oncomplete = () => resolve(true); }); },
        getAllFonts: async () => { if(!DBMgr.db) await DBMgr.init(); return new Promise((resolve) => { const req = DBMgr.db.transaction(['fonts'], 'readonly').objectStore('fonts').getAll(); req.onsuccess = () => resolve(req.result || []); }); },
        deleteFont: async (id) => { if(!DBMgr.db) await DBMgr.init(); return new Promise((resolve) => { const tx = DBMgr.db.transaction(['fonts'], 'readwrite'); tx.objectStore('fonts').delete(id); tx.oncomplete = () => resolve(true); }); },
        showExportYearMenu: async () => {
            const meta = await DBMgr.getAllPostMeta();
            if(meta.length === 0) return alert('æ²¡æœ‰ä»»ä½•æ•°æ®');
            const years = new Set(meta.map(m => new Date(m.date).getFullYear()));
            const sortedYears = Array.from(years).sort((a,b) => b-a);
            let html = '';
            sortedYears.forEach(y => { const count = meta.filter(m => new Date(m.date).getFullYear() === y).length; html += `<div class="menu-item" onclick="DBMgr.exportYear(${y})">${y} å¹´ <span style="font-size:11px;color:#999;margin-left:5px;">(${count}ç¯‡)</span></div>`; });
            html += `<div style="height:1px;background:#eee;margin:5px 0;"></div><div class="menu-item" onclick="DBMgr.exportYear('all')" style="color:#ff4d4f;">å¯¼å‡ºå…¨éƒ¨ (å¯èƒ½å¡é¡¿)</div>`;
            document.getElementById('exportYearOptions').innerHTML = html;
            document.getElementById('exportYearOverlay').style.display = 'flex';
        },
        generateBackupZip: async (year = 'all', onProgress) => {
            if (typeof JSZip === 'undefined') throw new Error('éœ€è¦ç½‘ç»œåŠ è½½JSZipç»„ä»¶');
            if(!onProgress) onProgress = (msg) => { document.getElementById('loadingText').innerText = msg; };
            
            const zip = new JSZip(); const imagesFolder = zip.folder("images");
            const fullConfig = {}; for (let i = 0; i < localStorage.length; i++) { const key = localStorage.key(i); if (key.startsWith('profile_') || key.startsWith('theme_') || key === 'global_bg' || key === 'gh_config') fullConfig[key] = localStorage.getItem(key); }
            
            const tx = DBMgr.db.transaction(['collections'], 'readonly');
            const collections = await new Promise(r => tx.objectStore('collections').getAll().onsuccess = e => r(e.target.result));
            
            const exportPosts = [];
            const postTx = DBMgr.db.transaction(['posts'], 'readonly');
            const store = postTx.objectStore('posts');
            const request = store.openCursor();
            let count = 0;
            
            await new Promise((resolve, reject) => {
                request.onsuccess = (event) => {
                    const cursor = event.target.result;
                    if (cursor) {
                        const p = cursor.value;
                        const pYear = new Date(p.date).getFullYear();
                        if (year === 'all' || pYear == year) { // ä½¿ç”¨ == å…¼å®¹å­—ç¬¦ä¸²å’Œæ•°å­—
                            const pCopy = { ...p, images: [], image: null, postBg: null };
                            if (p.images && p.images.length > 0) { for (let i = 0; i < p.images.length; i++) { const blob = p.images[i]; const ext = blob.type.split('/')[1] || 'jpg'; const fName = `p_${p.id}_${i}.${ext}`; imagesFolder.file(fName, blob); pCopy.images.push(fName); } }
                            if (p.image) { const ext = p.image.type.split('/')[1] || 'jpg'; const fName = `p_${p.id}_cover.${ext}`; imagesFolder.file(fName, p.image); pCopy.image = fName; }
                            if (p.postBg) { const ext = p.postBg.type.split('/')[1] || 'jpg'; const fName = `p_${p.id}_bg.${ext}`; imagesFolder.file(fName, p.postBg); pCopy.postBg = fName; }
                            exportPosts.push(pCopy); count++;
                            if (count % 10 === 0) onProgress(`å¤„ç†ä¸­: ${count} ç¯‡...`);
                        }
                        cursor.continue();
                    } else { resolve(); }
                };
                request.onerror = (e) => reject(e);
            });
            
            const data = { version: 50, timestamp: Date.now(), year: year, posts: exportPosts, collections: collections, localStorage: fullConfig };
            zip.file(`data_${year}.json`, JSON.stringify(data));
            
            onProgress('æ­£åœ¨å‹ç¼©...');
            const content = await zip.generateAsync({type:"blob", compression: "DEFLATE"}, (meta) => { onProgress(`æ‰“åŒ…ä¸­ ${meta.percent.toFixed(0)}%`); });
            return content;
        },
        exportYear: async (year) => {
            document.getElementById('exportYearOverlay').style.display = 'none';
            document.getElementById('loadingMask').style.display = 'flex';
            document.getElementById('loadingText').innerText = 'å‡†å¤‡æ•°æ®...';
            setTimeout(async () => {
                try {
                    const content = await DBMgr.generateBackupZip(year);
                    saveFileUniversal(content, `Backup_${year}_${new Date().toISOString().slice(0,10)}.zip`);
                } catch(e) { console.error(e); alert('å¯¼å‡ºå¤±è´¥: ' + e.message); document.getElementById('loadingMask').style.display = 'none'; }
            }, 100);
        },
        exportTextOnly: async () => {
            document.getElementById('loadingMask').style.display = 'flex';
            document.getElementById('loadingText').innerText = 'æ­£åœ¨å¯¼å‡ºçº¯æ–‡æœ¬...';
            setTimeout(async () => {
                try {
                    const tx = DBMgr.db.transaction(['posts'], 'readonly'); const store = tx.objectStore('posts');
                    const allPosts = await new Promise(r => store.getAll().onsuccess = e => r(e.target.result));
                    const cleanPosts = allPosts.map(p => { const { images, image, postBg, ...rest } = p; return rest; });
                    const blob = new Blob([JSON.stringify(cleanPosts)], {type: "application/json"});
                    saveFileUniversal(blob, `TextOnly_Backup_${new Date().toISOString().slice(0,10)}.json`);
                } catch(e) { alert('å¯¼å‡ºå¤±è´¥: ' + e.message); document.getElementById('loadingMask').style.display = 'none'; }
            }, 50);
        },
        importData: async (input) => {
            const file = input.files[0]; if(!file) return;
            if(!confirm('å¯¼å…¥å°†è¦†ç›–å½“å‰æ•°æ®ï¼Œç¡®å®šï¼Ÿ')) return;
            document.getElementById('loadingMask').style.display = 'flex';
            
            try {
                // 1. æ£€æŸ¥æ˜¯å¦ä¸º ZIP æ–‡ä»¶
                if (file.name.toLowerCase().endsWith('.zip')) {
                    document.getElementById('loadingText').innerText = 'æ­£åœ¨è¯»å–å¤‡ä»½æ–‡ä»¶...';
                    
                    const zip = await new JSZip().loadAsync(file);
                    
                    // æŸ¥æ‰¾ JSON æ•°æ®æ–‡ä»¶
                    const jsonFile = Object.values(zip.files).find(f => f.name.endsWith('.json') && f.name.includes('data'));
                    if (!jsonFile) throw new Error('å‹ç¼©åŒ…å†…æœªæ‰¾åˆ°æ•°æ®æ–‡ä»¶ (data_*.json)');
                    
                    const jsonStr = await jsonFile.async('string');
                    const json = JSON.parse(jsonStr);
                    
                    document.getElementById('loadingText').innerText = 'æ­£åœ¨è§£å‹å›¾ç‰‡èµ„æº...';

                    // --- ç¬¬ä¸€æ­¥ï¼Œå…ˆåœ¨å†…å­˜ä¸­æŠŠæ‰€æœ‰å›¾ç‰‡ Blob å‡†å¤‡å¥½ ---
                    const postsToSave = [];
                    const sourcePosts = json.posts || [];

                    for (let p of sourcePosts) {
                        // 1.1 æ¢å¤å›¾é›†
                        if (Array.isArray(p.images) && p.images.length > 0) {
                            const blobPromises = p.images.map(async (fileName) => {
                                if (typeof fileName === 'string') {
                                    const imgFile = zip.file("images/" + fileName);
                                    if (imgFile) return await imgFile.async('blob');
                                }
                                return null;
                            });
                            // ç­‰å¾…æ‰€æœ‰å›¾ç‰‡è§£å‹å®Œæˆ
                            p.images = (await Promise.all(blobPromises)).filter(b => b);
                        }
                        
                        // 1.2 æ¢å¤å°é¢
                        if (p.image && typeof p.image === 'string') {
                            const imgFile = zip.file("images/" + p.image);
                            if (imgFile) p.image = await imgFile.async('blob');
                            else p.image = null;
                        }
                        
                        // 1.3 æ¢å¤å•è´´èƒŒæ™¯ (postBg)
                        if (p.postBg && typeof p.postBg === 'string') {
                            const imgFile = zip.file("images/" + p.postBg);
                            if (imgFile) p.postBg = await imgFile.async('blob');
                            else p.postBg = null;
                        }
                        
                        postsToSave.push(p);
                    }
                    
                    // --- ç¬¬äºŒæ­¥ï¼Œå¼€å¯äº‹åŠ¡å¹¶åŒæ­¥å†™å…¥ ---
                    document.getElementById('loadingText').innerText = 'æ­£åœ¨å†™å…¥æ•°æ®åº“...';
                    
                    const tx = DBMgr.db.transaction(['posts', 'collections'], 'readwrite');
                    const postStore = tx.objectStore('posts');
                    const colStore = tx.objectStore('collections');
                    
                    // æ¸…ç©ºæ—§æ•°æ®
                    postStore.clear();
                    colStore.clear();
                    
                    // æ¢å¤ LocalStorage
                    if(json.localStorage) {
                        Object.keys(json.localStorage).forEach(key => localStorage.setItem(key, json.localStorage[key]));
                    }
                    
                    // å†™å…¥åˆé›†
                    if(json.collections) {
                        for (let col of json.collections) colStore.put(col);
                    }
                    
                    // å†™å…¥å¸–å­
                    for (let p of postsToSave) {
                        postStore.put(p);
                    }
                    
                    tx.oncomplete = () => { 
                        alert('æ¢å¤æˆåŠŸï¼'); 
                        location.reload(); 
                    };
                    
                    tx.onerror = (e) => {
                        throw new Error('æ•°æ®åº“å†™å…¥å¤±è´¥: ' + e.target.error.message);
                    };

                } else {
                    // åŸæœ‰çš„ JSON å¯¼å…¥é€»è¾‘ (çº¯æ–‡æœ¬)
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        try {
                            const json = JSON.parse(e.target.result);
                            const tx = DBMgr.db.transaction(['posts', 'collections'], 'readwrite');
                            tx.objectStore('posts').clear(); 
                            tx.objectStore('collections').clear();
                            
                            if(json.localStorage) Object.keys(json.localStorage).forEach(key => localStorage.setItem(key, json.localStorage[key]));
                            if(json.collections) for (let col of json.collections) tx.objectStore('collections').put(col);
                            if(json.posts || Array.isArray(json)) { 
                                const posts = json.posts || json; 
                                for (let post of posts) { tx.objectStore('posts').put(post); } 
                            }
                            tx.oncomplete = () => { alert('æ¢å¤æˆåŠŸï¼'); location.reload(); };
                        } catch(err) { 
                            alert('JSON è§£æå¤±è´¥: ' + err.message); 
                        } finally { 
                            document.getElementById('loadingMask').style.display = 'none'; 
                        }
                    };
                    reader.readAsText(file);
                }
            } catch(err) {
                console.error(err);
                alert('å¯¼å…¥å¤±è´¥: ' + err.message);
                document.getElementById('loadingMask').style.display = 'none';
            }
        },
        clearAll: async () => { if(confirm('ç¡®å®šæ¸…ç©ºï¼Ÿ')) { const tx = DBMgr.db.transaction(['posts', 'collections'], 'readwrite'); tx.objectStore('posts').clear(); tx.objectStore('collections').clear(); localStorage.clear(); location.reload(); } }
    };

    const Utils = {
        formatDate: (ts) => { const d = new Date(ts); return { day: d.getDate().toString().padStart(2, '0'), ym: `/ ${d.getMonth()+1} ${d.getFullYear()}`, full: `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2,'0')}-${d.getDate()}` }; },
        getCurrentUser: () => { return { name: localStorage.getItem('profile_name') || 'Lofterç”¨æˆ·', avatar: localStorage.getItem('profile_avatar') || 'https://api.dicebear.com/7.x/avataaars/svg?seed=Jiang' }; },
        getImgSrc: (imgData) => { if (!imgData) return ''; if (typeof imgData === 'string') return imgData; return URL.createObjectURL(imgData); },
        fileToBase64: (file, callback) => { const reader = new FileReader(); reader.onload = (e) => callback(e.target.result); reader.readAsDataURL(file); },
        compressImage: (file, maxWidth = 1280, quality = 0.7) => {
            return new Promise((resolve) => {
                if (!file.type.match(/image.*/)) return resolve(file);
                const reader = new FileReader();
                reader.onload = (readerEvent) => {
                    const image = new Image();
                    image.onload = () => {
                        let canvas = document.createElement('canvas'); let width = image.width; let height = image.height;
                        if (width > maxWidth || height > maxWidth) { if (width > height) { height *= maxWidth / width; width = maxWidth; } else { width *= maxWidth / height; height = maxWidth; } }
                        canvas.width = width; canvas.height = height; canvas.getContext('2d').drawImage(image, 0, 0, width, height);
                        canvas.toBlob((blob) => { resolve(blob); }, 'image/jpeg', quality);
                    };
                    image.src = readerEvent.target.result;
                };
                reader.readAsDataURL(file);
            });
        }
    };

    const Router = { 
        history: ['home'], 
        go: (viewName, navEl) => { 
            if(viewName === 'home') Router.history = ['home']; else Router.history.push(viewName); 
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active')); if(navEl) navEl.classList.add('active'); 
            document.querySelectorAll('.view').forEach(el => el.classList.remove('active')); document.getElementById(`view-${viewName}`).classList.add('active'); 
            document.getElementById('view-detail').style.backgroundImage = ''; 
            if(viewName !== 'html-detail') { document.getElementById('html-detail-iframe').srcdoc = ''; }
            if(viewName === 'home') HomeRenderer.checkAndRender(); 
            if(viewName === 'html-home') HtmlHomeRenderer.render(); 
            if(viewName === 'profile') ProfileRenderer.render(); 
        }, 
        back: () => { 
            if(Router.history.length > 1) { 
                Router.history.pop(); const prev = Router.history[Router.history.length-1]; 
                if (document.getElementById('view-html-detail').classList.contains('active')) { document.getElementById('html-detail-iframe').srcdoc = ''; }
                document.querySelectorAll('.view').forEach(el => el.classList.remove('active')); document.getElementById(`view-${prev}`).classList.add('active'); 
                document.getElementById('view-detail').style.backgroundImage = ''; 
                if(prev === 'home') HomeRenderer.checkAndRender(); 
                if(prev === 'html-home') HtmlHomeRenderer.render(); 
                if(prev === 'profile') ProfileRenderer.render(); 
            } else { Router.go('home'); } 
        } 
    };

    const ImageViewer = { open: (src) => { if (!src) return; document.getElementById('imageViewer').style.display = 'flex'; document.getElementById('iv-img').src = src; }, close: () => { document.getElementById('imageViewer').style.display = 'none'; }, download: () => { const src = document.getElementById('iv-img').src; const a = document.createElement('a'); a.href = src; a.download = `image_${Date.now()}.png`; document.body.appendChild(a); a.click(); document.body.removeChild(a); } };

    const ContextMenu = { 
        targetId: null, 
        show: (e, id) => { 
            e.preventDefault(); 
            ContextMenu.targetId = id; 
            const isCollectionMode = document.getElementById('view-collection-detail').classList.contains('active');
            
            let deleteHtml = `<div class="menu-item danger" onclick="ContextMenu.del()">åˆ é™¤å¸–å­</div>`;
            if (isCollectionMode) {
                deleteHtml = `<div class="menu-item danger" onclick="ContextMenu.removeFromCollection()">ä»åˆé›†ç§»é™¤</div>`;
            }

            const menuHtml = `
                <div class="menu-item" onclick="ContextMenu.toggleTop()">ç½®é¡¶/å–æ¶ˆç½®é¡¶</div>
                <div class="menu-item" onclick="ContextMenu.edit()">ç¼–è¾‘</div>
                <div class="menu-item" onclick="BatchMgr.enter()">æ‰¹é‡ç®¡ç†</div>
                ${deleteHtml}
                <div class="menu-item" onclick="ContextMenu.hide()">å–æ¶ˆ</div>
            `;
            document.getElementById('contextMenuBody').innerHTML = menuHtml; 
            document.getElementById('contextOverlay').style.display = 'flex'; 
        }, 
        showDetailMenu: (e, id) => { 
            e.stopPropagation(); ContextMenu.targetId = id; 
            const menuHtml = `<div class="menu-item" onclick="ContextMenu.edit()">ç¼–è¾‘å¸–å­</div><div class="menu-item" onclick="ContextMenu.addToColSingle(${id})">åŠ å…¥åˆé›†</div><div class="menu-item danger" onclick="ContextMenu.delFromDetail()">åˆ é™¤å¸–å­</div><div class="menu-item" onclick="ContextMenu.hide()">å–æ¶ˆ</div>`; 
            document.getElementById('contextMenuBody').innerHTML = menuHtml; 
            document.getElementById('contextOverlay').style.display = 'flex'; 
        }, 
        hide: () => { document.getElementById('contextOverlay').style.display = 'none'; }, 
        del: async () => { 
            if(confirm('å½»åº•åˆ é™¤è¿™æ¡å†…å®¹?')) { 
                await DBMgr.deletePost(ContextMenu.targetId); 
                HomeRenderer.resetAndRender(); 
                HtmlHomeRenderer.render(); 
                ContextMenu.hide(); 
            } 
        }, 
        removeFromCollection: async () => {
            const colId = ColDetailMgr.currentColId;
            const postId = ContextMenu.targetId;
            if(!colId) return;
            if(confirm('å°†å¸–å­ç§»å‡ºå½“å‰åˆé›†ï¼ˆä¸ä¼šåˆ é™¤åŸå¸–ï¼‰ï¼Ÿ')) {
                const cols = await DBMgr.getAllCollections();
                const target = cols.find(c => c.id === colId);
                if (target && target.postIds) {
                    target.postIds = target.postIds.filter(pid => pid !== postId);
                    await DBMgr.saveCollection(target);
                    await ColMgr.openDetail(colId); // åˆ·æ–°åˆé›†è§†å›¾
                }
                ContextMenu.hide();
            }
        },
        delFromDetail: async () => { if(confirm('åˆ é™¤å½“å‰å¸–å­?')) { await DBMgr.deletePost(ContextMenu.targetId); HomeRenderer.resetAndRender(); HtmlHomeRenderer.render(); ContextMenu.hide(); Router.back(); } }, 
        edit: async () => { const post = await DBMgr.getPost(ContextMenu.targetId); Editor.open(post, post.type || 'normal'); ContextMenu.hide(); }, 
        toggleTop: async () => { const post = await DBMgr.getPost(ContextMenu.targetId); post.isTop = !post.isTop;await DBMgr.savePost(post); HomeRenderer.resetAndRender(); HtmlHomeRenderer.render(); ContextMenu.hide(); }, 
        addToColSingle: (id) => { ContextMenu.showCollectionSelector([id]); }, 
        showCollectionSelector: async (postIds) => { const cols = await DBMgr.getAllCollections(); if(cols.length === 0) { ContextMenu.hide(); return alert('è¯·å…ˆå»â€œåˆé›†â€é¡µåˆ›å»ºä¸€ä¸ªåˆé›†'); } const listEl = document.getElementById('colSelectOptions'); listEl.innerHTML = cols.map(c => `<div class="menu-item" onclick="ContextMenu.executeAdd([${postIds}], ${c.id})">${c.title}</div>`).join(''); document.getElementById('colSelectOverlay').style.display = 'flex'; ContextMenu.hide(); }, 
        executeAdd: async (postIds, colId) => { const col = await DBMgr.getAllCollections(); const target = col.find(c => c.id === colId); if(!target.postIds) target.postIds = []; for(let pid of postIds) { if(!target.postIds.includes(pid)) target.postIds.push(pid); } await DBMgr.saveCollection(target); document.getElementById('colSelectOverlay').style.display = 'none'; alert('å·²åŠ å…¥åˆé›†'); } 
    };

    const ColDetailMgr = { 
        currentColId: null, postIds: [], 
        saveStat: async (el, type) => { const val = el.innerText; const cols = await DBMgr.getAllCollections(); const target = cols.find(c => c.id === ColDetailMgr.currentColId); if(target) { if(type === 'sub') target.subCount = val; if(type === 'hot') target.hotCount = val; if(type === 'view') target.viewCount = val; await DBMgr.saveCollection(target); } },
        startReading: () => { if(!ColDetailMgr.postIds || ColDetailMgr.postIds.length === 0) return alert('åˆé›†æ˜¯ç©ºçš„'); DetailRenderer.open(ColDetailMgr.postIds[0], ColDetailMgr.currentColId); },
        showMenu: () => { const html = `<div class="menu-item" onclick="ColMgr.editFromDetail()">ç¼–è¾‘åˆé›†</div><div class="menu-item danger" onclick="ColDetailMgr.deleteCurrent()">åˆ é™¤åˆé›†</div><div class="menu-item" onclick="ContextMenu.hide()">å–æ¶ˆ</div>`; document.getElementById('contextMenuBody').innerHTML = html; document.getElementById('contextOverlay').style.display = 'flex'; },
        deleteCurrent: async () => { if(confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªåˆé›†å—ï¼Ÿ')) { await DBMgr.deleteCollection(ColDetailMgr.currentColId); ContextMenu.hide(); Router.go('profile'); setTimeout(() => ProfileRenderer.switchTab('cols'), 100); } },
        toggleSubscribe: (btn) => { if(btn.innerText === 'è®¢é˜…åˆé›†') { btn.innerText = 'å·²è®¢é˜…'; btn.style.background = '#ccc'; btn.style.color = '#fff'; } else { btn.innerText = 'è®¢é˜…åˆé›†'; btn.style.background = '#333'; btn.style.color = '#fff'; } }
    };

    const DetailRenderer = {
        currentPostId: null, contextColId: null,
        open: async (id, colId = null) => {
            if (Router.history[Router.history.length - 1] !== 'detail') Router.history.push('detail');
            DetailRenderer.currentPostId = id; DetailRenderer.contextColId = colId;
            const post = await DBMgr.getPost(id); if(!post) return;
            if(post.type === 'html') { DetailRenderer.openHtmlDetail(post); return; }
            const user = Utils.getCurrentUser(); document.getElementById('d-avatar-img').src = user.avatar; document.getElementById('d-username').innerText = user.name;
            const detailView = document.getElementById('view-detail');
            if(post.postBg) {
                detailView.style.backgroundImage = `url(${Utils.getImgSrc(post.postBg)})`;
            } else {
                detailView.style.backgroundImage = ''; 
            }
            const bodyEl = document.getElementById('d-body-content'); let html = ''; const images = post.images || (post.image ? [post.image] : []);
            if(images.length > 0) {
                let sliderItems = images.map(blob => `<div class="d-slider-item"><img src="${Utils.getImgSrc(blob)}" onclick="ImageViewer.open(this.src)"></div>`).join('');
                html += `<div class="d-slider-container"><div class="d-slider">${sliderItems}</div>${images.length > 1 ? `<div class="d-slider-indicator">1 / ${images.length}</div>` : ''}</div>`;
                setTimeout(() => { const slider = document.querySelector('.d-slider'); const indicator = document.querySelector('.d-slider-indicator'); if(slider && indicator) slider.addEventListener('scroll', () => { const index = Math.round(slider.scrollLeft / slider.clientWidth) + 1; indicator.innerText = `${index} / ${images.length}`; }); }, 100);
                if(post.title) html += `<div style="padding:15px 20px 0; font-size:1.33rem; font-weight:bold;">${post.title}</div>`;
                if(post.content) html += `<div class="d-content">${parseMarkdoom(post.content)}</div>`;
            } else {
                if(post.title) html += `<div style="padding:20px 20px 0; font-size:1.33rem; font-weight:bold;">${post.title}</div>`;
                html += `<div class="d-content text-mode">${parseMarkdoom(post.content)}</div>`;
            }
            html += '<div style="height:60px;"></div>';
            bodyEl.innerHTML = html; document.getElementById('d-date').innerText = Utils.formatDate(post.date).full; DetailRenderer.renderComments(post);
            const inputBar = document.getElementById('float-input-bar');
            const toolbar = document.getElementById('reading-toolbar');
            if(colId) { 
                inputBar.style.display = 'none'; toolbar.style.display = 'flex'; 
                document.getElementById('d-inline-input-area').innerHTML = `<div class="static-input-bar"><input type="text" id="inline-comment-input" placeholder="è¯„è®º..."><div class="send-btn" onclick="DetailRenderer.addComment()">å‘é€</div></div>`; 
                const ids = ColDetailMgr.postIds; const idx = ids.indexOf(id); 
                document.getElementById('rt-prev').className = idx <= 0 ? 'rt-btn disabled' : 'rt-btn';
                document.getElementById('rt-next').className = (idx === -1 || idx >= ids.length - 1) ? 'rt-btn disabled' : 'rt-btn';
            } else { 
                inputBar.style.display = 'flex'; toolbar.style.display = 'none'; document.getElementById('d-inline-input-area').innerHTML = ''; 
            }
            document.querySelectorAll('.view').forEach(el => el.classList.remove('active')); document.getElementById('view-detail').classList.add('active');
        },
        openHtmlDetail: (post) => { 
            DetailRenderer.currentPostId = post.id; 
            const container = document.getElementById('view-html-detail');
            const iframe = document.getElementById('html-detail-iframe');
            // å…¨å±æ˜¾ç¤ºï¼Œä¸éœ€è¦é¢å¤–æ ·å¼æ³¨å…¥å»é™åˆ¶ overflow
            iframe.srcdoc = post.content;
            
            const user = Utils.getCurrentUser();
            const comments = post.comments || [];
            let commentsHtml = comments.length === 0 ? '<div style="text-align:center; color:#ccc; font-size:0.89rem; padding:10px;">æš‚æ— è¯„è®º</div>' : comments.map(c => `<div style="margin-bottom:10px; font-size:0.96rem;"><span style="font-weight:bold;">${user.name}:</span> ${c.text}</div>`).join('');
            const listEl = document.getElementById('html-comments-list-simple');
            listEl.innerHTML = commentsHtml;
            document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
            container.classList.add('active');
        },
        toggleHtmlComments: (show) => {
            const sheet = document.getElementById('html-comment-sheet');
            const overlay = document.getElementById('html-sheet-overlay');
            const currentState = sheet.classList.contains('active');
            const shouldShow = show !== undefined ? show : !currentState;
            
            if (shouldShow) {
                sheet.classList.add('active');
                overlay.classList.add('active');
            } else {
                sheet.classList.remove('active');
                overlay.classList.remove('active');
            }
        },
        copyHtml: async () => {
            const post = await DBMgr.getPost(DetailRenderer.currentPostId);
            if (!post || !post.content) return alert('å†…å®¹ä¸ºç©º');
            try {
                // åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„ textarea å…ƒç´ æ¥æ‰§è¡Œå¤åˆ¶
                const textarea = document.createElement('textarea');
                textarea.value = post.content;
                textarea.style.position = 'fixed'; // é¿å…é¡µé¢æ»šåŠ¨
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                alert('HTML ä»£ç å·²å¤åˆ¶');
            } catch (err) {
                console.error('å¤åˆ¶å¤±è´¥:', err);
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
            }
        },
        renderComments: (post) => { const listEl = document.getElementById('d-comments-list'); if(!post.comments || post.comments.length === 0) { listEl.innerHTML = '<div style="text-align:center; color:#eee;">æš‚æ— è¯„è®º</div>'; return; } const user = Utils.getCurrentUser(); listEl.innerHTML = post.comments.map(c => `<div class="comment-item"><img src="${user.avatar}" class="c-avatar"><div class="c-right"><div class="c-top"><span>${user.name}</span></div><div class="c-text">${c.text}</div><div class="c-date">${Utils.formatDate(c.date).full}</div></div></div>`).join(''); },
        addComment: async () => { let text = ''; const floatInput = document.getElementById('comment-input'); const inlineInput = document.getElementById('inline-comment-input'); if (inlineInput && document.body.contains(inlineInput) && inlineInput.offsetParent !== null) { text = inlineInput.value; inlineInput.value = ''; } else if (floatInput && floatInput.value) { text = floatInput.value; floatInput.value = ''; } if(!text) return; const post = await DBMgr.getPost(DetailRenderer.currentPostId); if(!post.comments) post.comments = []; post.comments.push({ text: text, date: Date.now() }); await DBMgr.savePost(post); DetailRenderer.renderComments(post); if(!document.getElementById('d-inline-input-area').innerHTML) { setTimeout(() => { document.getElementById('view-detail').scrollTop = document.getElementById('view-detail').scrollHeight; }, 100); } },
        addHtmlComment: async () => { const input = document.getElementById('html-comment-input'); const text = input.value; if(!text) return; const post = await DBMgr.getPost(DetailRenderer.currentPostId); if(!post.comments) post.comments = []; post.comments.push({ text: text, date: Date.now() }); await DBMgr.savePost(post); input.value = ''; const user = Utils.getCurrentUser(); const listEl = document.getElementById('html-comments-list-simple'); const newCommentHtml = `<div style="margin-bottom:10px; font-size:0.96rem;"><span style="font-weight:bold;">${user.name}:</span> ${text}</div>`; if(post.comments.length === 1) listEl.innerHTML = newCommentHtml; else listEl.insertAdjacentHTML('beforeend', newCommentHtml); },
        nextPost: () => { if(!DetailRenderer.contextColId) return; const ids = ColDetailMgr.postIds; const idx = ids.indexOf(DetailRenderer.currentPostId); if(idx !== -1 && idx < ids.length - 1) DetailRenderer.open(ids[idx+1], DetailRenderer.contextColId); },
        prevPost: () => { if(!DetailRenderer.contextColId) return; const ids = ColDetailMgr.postIds; const idx = ids.indexOf(DetailRenderer.currentPostId); if(idx > 0) DetailRenderer.open(ids[idx-1], DetailRenderer.contextColId); },
        showDirectory: async () => { const listEl = document.getElementById('dir-list-container'); const ids = ColDetailMgr.postIds; let html = ''; const batchPosts = await DBMgr.getPostsBatch(ids); batchPosts.forEach(p => { const isActive = p.id === DetailRenderer.currentPostId; const title = p.title || (p.content ? p.content.substring(0, 20) + '...' : 'æ— æ ‡é¢˜'); html += `<div class="dir-item ${isActive?'active':''}" onclick="DetailRenderer.jumpFromDir(${p.id})"><span>${title}</span></div>`; }); listEl.innerHTML = html; document.getElementById('dir-overlay').style.display = 'flex'; },
        jumpFromDir: (id) => { document.getElementById('dir-overlay').style.display = 'none'; DetailRenderer.open(id, DetailRenderer.contextColId); }
    };
    
    const Editor = {
        currentImages: [], currentId: null, currentType: 'normal', currentPostBg: null, currentColId: null,
        open: async (post, type = 'normal') => { 
            Editor.currentType = type; 
            document.getElementById('post-title').value = ''; 
            document.getElementById('post-content').value = ''; 
            Editor.currentImages = []; Editor.currentId = null; Editor.currentPostBg = null; Editor.currentColId = null;
            document.getElementById('editor-bg-btn').classList.remove('has-bg'); document.getElementById('editor-col-btn').classList.remove('active'); document.getElementById('editor-col-text').innerText = '+ åŠ å…¥åˆé›†';
            const wordCountEl = document.getElementById('word-count-display');
            if(type === 'html') { wordCountEl.style.display = 'none'; } else { wordCountEl.style.display = 'block'; wordCountEl.classList.remove('show'); wordCountEl.innerText = '0 å­—'; }
            if(post) { 
                Editor.currentId = post.id; Editor.currentType = post.type || 'normal'; document.getElementById('post-title').value = post.title || ''; document.getElementById('post-content').value = post.content || ''; 
                if(post.images && post.images.length > 0) Editor.currentImages = [...post.images]; else if(post.image) Editor.currentImages = [post.image];
                if(post.postBg) { Editor.currentPostBg = post.postBg; document.getElementById('editor-bg-btn').classList.add('has-bg'); }
                const cols = await DBMgr.getAllCollections(); const parentCol = cols.find(c => c.postIds && c.postIds.includes(post.id)); if(parentCol) Editor.selectCollection(parentCol.id, parentCol.title);
                if(type !== 'html') Editor.updateWordCount();
            } 
            Editor.renderGallery(); document.querySelectorAll('.view').forEach(el => el.classList.remove('active')); document.getElementById('view-editor').classList.add('active'); 
        },
        updateWordCount: () => { if(Editor.currentType === 'html') return; const content = document.getElementById('post-content').value; const count = content.length; const el = document.getElementById('word-count-display'); el.innerText = count + ' å­—'; if(count > 0) el.classList.add('show'); else el.classList.remove('show'); },
        handleImages: async (input) => { if(input.files && input.files.length > 0) { const files = Array.from(input.files); const btnHtml = document.getElementById('img-upload-btn').innerHTML; document.getElementById('img-upload-btn').innerHTML = '<span style="font-size:0.74rem;">å¤„ç†ä¸­...</span>'; for (let file of files) { const compressed = await Utils.compressImage(file); Editor.currentImages.push(compressed); } document.getElementById('img-upload-btn').innerHTML = btnHtml; Editor.renderGallery(); } },
        handlePostBg: async (input) => { if(input.files && input.files[0]) { const compressed = await Utils.compressImage(input.files[0]); Editor.currentPostBg = compressed; document.getElementById('editor-bg-btn').classList.add('has-bg'); } },
        openColPicker: async () => { const cols = await DBMgr.getAllCollections(); const listEl = document.getElementById('colSelectOptions'); if(cols.length === 0) return alert('è¿˜æ²¡æœ‰åˆ›å»ºè¿‡åˆé›†'); listEl.innerHTML = cols.map(c => `<div class="menu-item" onclick="Editor.selectCollection(${c.id}, '${c.title}')">${c.title}</div>`).join(''); document.getElementById('colSelectOverlay').style.display = 'flex'; },
        selectCollection: (id, title) => { Editor.currentColId = id; document.getElementById('editor-col-btn').classList.add('active'); document.getElementById('editor-col-text').innerText = title; document.getElementById('colSelectOverlay').style.display = 'none'; },
        removeCollection: (e) => { e.stopPropagation(); Editor.currentColId = null; document.getElementById('editor-col-btn').classList.remove('active'); document.getElementById('editor-col-text').innerText = '+ åŠ å…¥åˆé›†'; },
        removeImage: (index) => { Editor.currentImages.splice(index, 1); Editor.renderGallery(); },
        renderGallery: () => { const gallery = document.getElementById('editor-gallery'); const btn = document.getElementById('img-upload-btn'); while(gallery.firstChild && gallery.firstChild !== btn) { gallery.removeChild(gallery.firstChild); } Editor.currentImages.forEach((imgBlob, idx) => { const div = document.createElement('div'); div.className = 'editor-img-item'; const src = Utils.getImgSrc(imgBlob); div.innerHTML = `<img src="${src}"><div class="editor-img-remove" onclick="Editor.removeImage(${idx})">Ã—</div>`; gallery.insertBefore(div, btn); }); },
        publish: async () => { 
            const title = document.getElementById('post-title').value; const content = document.getElementById('post-content').value; 
            if(!content && Editor.currentImages.length === 0 && !title) return alert('å†™ç‚¹ä»€ä¹ˆå§'); 
            let oldPost = null; if (Editor.currentId) oldPost = await DBMgr.getPost(Editor.currentId); const postId = Editor.currentId || Date.now();
            const newPost = { id: postId, type: Editor.currentType, title: title, content: content, images: Editor.currentImages, image: Editor.currentImages.length > 0 ? Editor.currentImages[0] : null, date: oldPost ? oldPost.date : Date.now(), isTop: oldPost ? oldPost.isTop : false, comments: oldPost ? oldPost.comments : [], postBg: Editor.currentPostBg }; 
            await DBMgr.savePost(newPost); 
            const cols = await DBMgr.getAllCollections(); const targetColId = Editor.currentColId; const oldCol = cols.find(c => c.postIds && c.postIds.includes(postId));
            if (oldCol && (!targetColId || oldCol.id !== targetColId)) { oldCol.postIds = oldCol.postIds.filter(id => id !== postId); await DBMgr.saveCollection(oldCol); }
            if (targetColId) { const targetCol = cols.find(c => c.id === targetColId); if (targetCol) { if (!targetCol.postIds) targetCol.postIds = []; if (!targetCol.postIds.includes(postId)) { targetCol.postIds.push(postId); await DBMgr.saveCollection(targetCol); } } }
            if(Editor.currentType === 'html') Router.go('html-home'); else Router.go('home');
        }
    };

    const HomeRenderer = {
        layout: 0, allMeta: [], currentIndex: 0, BATCH_SIZE: 15, observer: null, sortOrder: 'desc', filterType: 'all', isLoading: false,
        layoutIcons: ['<path d="M3 12h18M3 6h18M3 18h18"/>', '<rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>', '<rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect>'],
        toggleLayout: () => { HomeRenderer.layout = (HomeRenderer.layout + 1) % 3; HomeRenderer.updateIcon(); HomeRenderer.resetAndRender(); },
        updateIcon: () => { document.getElementById('layout-icon').innerHTML = HomeRenderer.layoutIcons[HomeRenderer.layout]; },
        showFilterMenu: () => { const html = `<div class="menu-section-title">æ’åºæ–¹å¼</div><div class="menu-item ${HomeRenderer.sortOrder==='desc'?'active':''}" onclick="HomeRenderer.setSort('desc')">æœ€æ–°å‘å¸ƒ</div><div class="menu-item ${HomeRenderer.sortOrder==='asc'?'active':''}" onclick="HomeRenderer.setSort('asc')">æœ€æ—©å‘å¸ƒ</div><div class="menu-section-title">å†…å®¹ç­›é€‰</div><div class="menu-item ${HomeRenderer.filterType==='all'?'active':''}" onclick="HomeRenderer.setFilter('all')">å…¨éƒ¨å†…å®¹</div><div class="menu-item ${HomeRenderer.filterType==='image'?'active':''}" onclick="HomeRenderer.setFilter('image')">ä»…çœ‹å›¾ç‰‡</div><div class="menu-item ${HomeRenderer.filterType==='text'?'active':''}" onclick="HomeRenderer.setFilter('text')">ä»…çœ‹æ–‡å­—</div><div class="menu-item" style="color:#666;margin-top:10px;" onclick="ContextMenu.hide()">å…³é—­</div>`; document.getElementById('contextMenuBody').innerHTML = html; document.getElementById('contextOverlay').style.display = 'flex'; },
        setSort: (order) => { HomeRenderer.sortOrder = order; ContextMenu.hide(); HomeRenderer.resetAndRender(); },
        setFilter: (type) => { HomeRenderer.filterType = type; ContextMenu.hide(); HomeRenderer.resetAndRender(); },
        checkAndRender: () => HomeRenderer.resetAndRender(),
        resetAndRender: async () => {
            if (HomeRenderer.observer) { HomeRenderer.observer.disconnect(); HomeRenderer.observer = null; }
            let meta = await DBMgr.getAllPostMeta();
            meta = meta.filter(p => !p.type || p.type === 'normal');
            const term = document.getElementById('searchInput').value.toLowerCase();
            if(term) meta = meta.filter(p => p.searchString.includes(term));
            if(HomeRenderer.filterType === 'image') meta = meta.filter(p => p.hasImage); else if(HomeRenderer.filterType === 'text') meta = meta.filter(p => !p.hasImage);
            meta.sort((a, b) => { if(a.isTop && !b.isTop) return -1; if(!a.isTop && b.isTop) return 1; if(HomeRenderer.sortOrder === 'asc') return a.date - b.date; else return b.date - a.date; });
            HomeRenderer.allMeta = meta; HomeRenderer.currentIndex = 0; HomeRenderer.isLoading = false;
            const postsContainer = document.getElementById('posts-list'); const timelineContainer = document.getElementById('timeline-list');
            postsContainer.style.display = 'none'; timelineContainer.style.display = 'none'; document.getElementById('empty-state').style.display = (meta.length === 0) ? 'block' : 'none';
            if(meta.length === 0) return;
            
            if(HomeRenderer.layout === 2) {
                // Timeline
                timelineContainer.style.display = 'block'; timelineContainer.innerHTML = ''; 
                const batchMeta = meta.slice(0, 100); const batchPosts = await DBMgr.getPostsBatch(batchMeta.map(m=>m.id));
                HomeRenderer.renderTimelineFull(batchPosts);
            } else if (HomeRenderer.layout === 0) {
                // Grid (Dual Column JS Layout)
                postsContainer.style.display = 'block'; 
                postsContainer.className = 'posts-container mode-grid';
                // Reset to structure
                postsContainer.innerHTML = `<div class="waterfall-container"><div class="waterfall-col" id="wf-col-0"></div><div class="waterfall-col" id="wf-col-1"></div></div>`;
                await HomeRenderer.loadMore(); HomeRenderer.setupObserver();
            } else {
                // List (Single Column)
                postsContainer.style.display = 'block';
                postsContainer.className = 'posts-container mode-list';
                postsContainer.innerHTML = '';
                await HomeRenderer.loadMore(); HomeRenderer.setupObserver();
            }
        },
        loadMore: async () => { 
            if (HomeRenderer.layout === 2) return; if (HomeRenderer.isLoading) return; if (HomeRenderer.currentIndex >= HomeRenderer.allMeta.length) return; 
            HomeRenderer.isLoading = true;
            try {
                const nextIndex = HomeRenderer.currentIndex + HomeRenderer.BATCH_SIZE; 
                const batchMeta = HomeRenderer.allMeta.slice(HomeRenderer.currentIndex, nextIndex);
                const batchPosts = await DBMgr.getPostsBatch(batchMeta.map(m => m.id));
                
                // Rendering Logic
                if (HomeRenderer.layout === 0) {
                    const col0 = document.getElementById('wf-col-0');
                    const col1 = document.getElementById('wf-col-1');
                    batchPosts.forEach((p, idx) => {
                        const html = HomeRenderer.createPostHTML(p);
                        // æ™ºèƒ½åˆ¤æ–­ï¼šæ¯æ¬¡æ·»åŠ æ—¶ï¼ŒæŠŠæ–°å¡ç‰‡åŠ åˆ°å½“å‰æ›´çŸ­çš„é‚£ä¸€åˆ—
                        if (col0.offsetHeight <= col1.offsetHeight) {
                            col0.insertAdjacentHTML('beforeend', html);
                        } else {
                            col1.insertAdjacentHTML('beforeend', html);
                        }
                    });
                } else {
                    const html = batchPosts.map(p => HomeRenderer.createPostHTML(p)).join(''); 
                    document.getElementById('posts-list').insertAdjacentHTML('beforeend', html); 
                }

                HomeRenderer.currentIndex = nextIndex; 
            } finally { HomeRenderer.isLoading = false; }
        },
        setupObserver: () => { if (HomeRenderer.observer) HomeRenderer.observer.disconnect(); const options = { root: document.getElementById('view-home'), rootMargin: '200px', threshold: 0.1 }; HomeRenderer.observer = new IntersectionObserver((entries) => { if (entries[0].isIntersecting) { HomeRenderer.loadMore(); } }, options); HomeRenderer.observer.observe(document.getElementById('scroll-sentinel')); },
        createPostHTML: (p, specificLayout = null) => { 
            if(!p) return '';
            const d = Utils.formatDate(p.date); const user = Utils.getCurrentUser(); const images = p.images || (p.image ? [p.image] : []); let mediaHTML = ''; const targetLayout = (specificLayout !== null) ? specificLayout : HomeRenderer.layout;
            const firstImg = images.length > 0 ? Utils.getImgSrc(images[0]) : '';
            if (images.length > 0) {
                if (targetLayout === 0) { const badge = images.length > 1 ? `<div class="img-count-badge"><svg class="icon" style="width:10px;height:10px;" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg> ${images.length}</div>` : ''; mediaHTML = `<div class="post-img-grid"><img src="${firstImg}" loading="lazy">${badge}</div>`; } 
                else { const displayImgs = images.slice(0, 4); const count = displayImgs.length; const imgs = displayImgs.map(blob => `<div class="post-img-item"><img src="${Utils.getImgSrc(blob)}"></div>`).join(''); mediaHTML = `<div class="post-img-grid cols-${count}">${imgs}</div>`; }
            }
            const contentText = p.content || ''; 
            const bgStyle = p.postBg ? `style="background-image: url(${Utils.getImgSrc(p.postBg)}) !important; background-attachment: scroll !important;"` : '';
            return `<div class="post-card ${p.isTop?'is-top':''}" id="post-${p.id}" ${bgStyle} onclick="handlePostClick(${p.id}, this)" oncontextmenu="ContextMenu.show(event, ${p.id})"><div class="pin-mark"><svg viewBox="0 0 24 24"><line x1="4" y1="4" x2="20" y2="4"/><line x1="12" y1="20" x2="12" y2="8"/><polyline points="6 14 12 8 18 14"/></svg></div><div class="post-header"><div style="display:flex;align-items:center;"><img src="${user.avatar}" style="width:24px;height:24px;border-radius:50%;margin-right:8px; object-fit:cover;"><div class="post-date"><span class="date-day">${d.day}</span><span class="date-info">${d.ym}</span></div></div></div>${mediaHTML}<div class="post-content-wrap">${p.title ? `<div class="post-title">${p.title}</div>` : ''}<div class="post-text">${contentText}</div></div></div>`; 
        },
        renderTimelineFull: (posts) => { const groups = {}; posts.forEach(p => { const d = new Date(p.date); const key = `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2, '0')}`; if(!groups[key]) groups[key] = []; groups[key].push(p); }); let tlHtml = ''; Object.keys(groups).sort((a,b)=> new Date(b)-new Date(a)).forEach(key => { const [year, month] = key.split('-'); const monthPosts = groups[key]; let gridHtml = monthPosts.map(p => { const images = p.images || (p.image ? [p.image] : []); if(images.length > 0) return `<div class="grid-item" onclick="DetailRenderer.open(${p.id})"><img src="${Utils.getImgSrc(images[0])}" loading="lazy"></div>`; else return `<div class="grid-item" onclick="DetailRenderer.open(${p.id})"><div class="text-card"><div class="text-content-sm">${p.title || p.content}</div></div></div>`; }).join(''); tlHtml += `<div class="month-section"><div class="month-header"><div class="month-left"><span class="month-num">${parseInt(month)}æœˆ</span><span class="year-num">${year}</span></div><span class="post-count-badge">${monthPosts.length}ç¯‡</span></div><div class="grid-row">${gridHtml}</div></div>`; }); document.getElementById('timeline-list').innerHTML = tlHtml; }
    };
    
    const ColMgr = { 
        currentCover: null, currentColId: null, 
        renderList: async () => { const cols = await DBMgr.getAllCollections(); const container = document.getElementById('col-list-container'); if(cols.length === 0) { container.innerHTML = '<div style="text-align:center; padding:40px; color:#999;">æš‚æ— åˆé›†ï¼Œç‚¹å‡»å³ä¸Šè§’åˆ›å»º</div>'; return; } container.innerHTML = cols.map(c => `<div class="col-item" onclick="ColMgr.openDetail(${c.id})"><img src="${Utils.getImgSrc(c.cover) || 'https://via.placeholder.com/150'}" class="col-cover"><div class="col-info"><div class="col-title">${c.title}</div><div class="col-desc">${c.desc || 'æ— æè¿°'}</div><div style="font-size:0.89rem; color:#bbb; margin-top:5px;">${c.postIds ? c.postIds.length : 0} ç¯‡</div></div></div>`).join(''); },
        openCreate: () => { ColMgr.currentColId = null; ColMgr.currentCover = null; document.getElementById('col-title-input').value = ''; document.getElementById('col-desc-input').value = ''; document.getElementById('col-cover-preview').style.display = 'none'; document.getElementById('col-cover-tip').style.display = 'block'; document.querySelectorAll('.view').forEach(el => el.classList.remove('active')); document.getElementById('view-collection-create').classList.add('active'); }, 
        handleCover: async (input) => { if(input.files && input.files[0]) { const compressed = await Utils.compressImage(input.files[0]); Utils.fileToBase64(compressed, (base64) => { ColMgr.currentCover = base64; document.getElementById('col-cover-preview').src = base64; document.getElementById('col-cover-preview').style.display = 'block'; document.getElementById('col-cover-tip').style.display = 'none'; }); } }, 
        save: async () => { const title = document.getElementById('col-title-input').value; const desc = document.getElementById('col-desc-input').value; if(!title) return alert('è¯·è¾“å…¥æ ‡é¢˜'); let newCol; if(ColMgr.currentColId) { const cols = await DBMgr.getAllCollections(); const existing = cols.find(c => c.id === ColMgr.currentColId); newCol = { ...existing, title: title, desc: desc, cover: ColMgr.currentCover }; } else { newCol = { id: Date.now(), title: title, desc: desc, cover: ColMgr.currentCover, postIds: [] }; } await DBMgr.saveCollection(newCol); Router.go('profile'); setTimeout(() => ProfileRenderer.switchTab('cols'), 100); }, 
        editFromDetail: async () => { const cols = await DBMgr.getAllCollections(); const target = cols.find(c => c.id === ColDetailMgr.currentColId); if(!target) return; ColMgr.currentColId = target.id; ColMgr.currentCover = target.cover; document.getElementById('col-title-input').value = target.title; document.getElementById('col-desc-input').value = target.desc || ''; if(target.cover) { document.getElementById('col-cover-preview').src = Utils.getImgSrc(target.cover); document.getElementById('col-cover-preview').style.display = 'block'; document.getElementById('col-cover-tip').style.display = 'none'; } else { document.getElementById('col-cover-preview').style.display = 'none'; document.getElementById('col-cover-tip').style.display = 'block'; } ContextMenu.hide(); document.querySelectorAll('.view').forEach(el => el.classList.remove('active')); document.getElementById('view-collection-create').classList.add('active'); },
        openDetail: async (colId) => { 
            const cols = await DBMgr.getAllCollections(); 
            const target = cols.find(c => c.id === colId); 
            if(!target) return; 
            Router.history.push('collection-detail');
            document.querySelectorAll('.view').forEach(el => el.classList.remove('active')); 
            document.getElementById('view-collection-detail').classList.add('active');
            document.getElementById('cd-bg').style.backgroundImage = `url(${Utils.getImgSrc(target.cover) || ''})`; 
            document.getElementById('cd-cover').src = Utils.getImgSrc(target.cover) || 'https://via.placeholder.com/150'; 
            document.getElementById('cd-title').innerText = target.title; 
            const user = Utils.getCurrentUser(); 
            document.getElementById('cd-avatar').src = user.avatar; 
            document.getElementById('cd-author').innerText = `${user.name} Â· åˆ›å»ºäºåˆšåˆš`; 
            document.getElementById('cd-stat-sub').innerText = target.subCount || '0'; 
            document.getElementById('cd-stat-hot').innerText = target.hotCount || '0'; 
            document.getElementById('cd-stat-view').innerText = target.viewCount || '0'; 
            let posts = []; 
            if(target.postIds && target.postIds.length > 0) { posts = await DBMgr.getPostsBatch(target.postIds); } 
            posts.sort((a,b) => b.date - a.date); 
            const listContainer = document.getElementById('cd-post-list'); 
            if(posts.length === 0) { listContainer.innerHTML = ''; document.getElementById('cd-empty').style.display = 'block'; } 
            else { document.getElementById('cd-empty').style.display = 'none'; listContainer.innerHTML = posts.map(p => HomeRenderer.createPostHTML(p, 0)).join(''); } 
            ColDetailMgr.currentColId = colId; 
            ColDetailMgr.postIds = posts.map(p => p.id); 
        } 
    };

    const ProfileRenderer = {
        currentTab: 'posts', render: async () => { document.querySelectorAll('.p-tab').forEach(el => el.classList.remove('active')); document.getElementById(`ptab-${ProfileRenderer.currentTab}`).classList.add('active'); if(ProfileRenderer.currentTab === 'posts') { document.getElementById('profile-posts-area').style.display = 'block'; document.getElementById('profile-cols-area').style.display = 'none'; await ProfileRenderer.renderPosts(); } else { document.getElementById('profile-posts-area').style.display = 'none'; document.getElementById('profile-cols-area').style.display = 'block'; await ColMgr.renderList(); } },
        switchTab: (tabName) => { ProfileRenderer.currentTab = tabName; ProfileRenderer.render(); },
        returnToCols: () => { Router.go('profile'); setTimeout(() => { ProfileRenderer.switchTab('cols'); }, 50); },
        renderPosts: async () => { let meta = await DBMgr.getAllPostMeta(); meta = meta.filter(p => !p.type || p.type === 'normal'); meta.sort((a, b) => { if(a.isTop && !b.isTop) return -1; if(!a.isTop && b.isTop) return 1; return b.date - a.date; }); const batchMeta = meta.slice(0, 50); const posts = await DBMgr.getPostsBatch(batchMeta.map(m=>m.id)); const container = document.getElementById('profile-posts-list'); if (posts.length === 0) { container.innerHTML = ''; document.getElementById('profile-empty').style.display = 'block'; } else { document.getElementById('profile-empty').style.display = 'none'; container.innerHTML = posts.map(p => HomeRenderer.createPostHTML(p, 1)).join(''); } }
    };

    const HtmlHomeRenderer = { 
        render: async () => { 
            let meta = await DBMgr.getAllPostMeta(); 
            meta = meta.filter(p => p.type === 'html'); 
            meta.sort((a, b) => { if(a.isTop && !b.isTop) return -1; if(!a.isTop && b.isTop) return 1; return b.date - a.date; }); 
            const posts = await DBMgr.getPostsBatch(meta.map(m=>m.id)); 
            const container = document.getElementById('html-posts-list'); 
            
            if(posts.length === 0) { 
                container.innerHTML = ''; 
                document.getElementById('html-empty-state').style.display = 'block'; 
            } else { 
                document.getElementById('html-empty-state').style.display = 'none'; 
                container.innerHTML = ''; 
                // HTML é¦–é¡µä¹Ÿä½¿ç”¨åŒåˆ—æ™ºèƒ½é€»è¾‘
                container.className = 'posts-container mode-grid';
                container.innerHTML = `<div class="waterfall-container"><div class="waterfall-col" id="html-wf-col-0"></div><div class="waterfall-col" id="html-wf-col-1"></div></div>`;
                const col0 = document.getElementById('html-wf-col-0');
                const col1 = document.getElementById('html-wf-col-1');

                const user = Utils.getCurrentUser();
                posts.forEach((p, index) => {
                    const d = Utils.formatDate(p.date);
                    const bgStyle = p.postBg ? `style="background-image: url(${Utils.getImgSrc(p.postBg)}) !important; background-attachment: scroll !important;"` : '';
                    let innerHTML = `<div class="post-card ${p.isTop?'is-top':''}" style="${p.postBg ? 'background-image: url('+Utils.getImgSrc(p.postBg)+') !important; background-attachment: scroll !important;' : ''}" onclick="handlePostClick(${p.id}, this)" oncontextmenu="ContextMenu.show(event, ${p.id})"><div class="pin-mark"><svg viewBox="0 0 24 24"><line x1="4" y1="4" x2="20" y2="4"/><line x1="12" y1="20" x2="12" y2="8"/><polyline points="6 14 12 8 18 14"/></svg></div><div class="post-header"><div style="display:flex;align-items:center;"><img src="${user.avatar}" style="width:24px;height:24px;border-radius:50%;margin-right:8px; object-fit:cover;"><div class="post-date"><span class="date-day">${d.day}</span><span class="date-info">${d.ym}</span></div></div></div><div class="post-html-preview"></div><div class="post-content-wrap">${p.title ? `<div class="post-title">${p.title}</div>` : ''}</div></div>`;
                    
                    const template = document.createElement('template');
                    template.innerHTML = innerHTML.trim();
                    const card = template.content.firstChild;
                    
                    const previewContainer = card.querySelector('.post-html-preview');
                    const iframe = document.createElement('iframe');
                    const zoomedContent = p.content + `<style>body { transform: scale(0.4); transform-origin: top left; width: 250%; overflow: hidden; }</style>`;
                    iframe.srcdoc = zoomedContent;
                    iframe.loading = "lazy";
                    previewContainer.appendChild(iframe);

                    if(col0.offsetHeight <= col1.offsetHeight) col0.appendChild(card);
                    else col1.appendChild(card);
                });
            } 
        } 
    };

    const BatchMgr = { 
        active: false, selectedIds: new Set(), 
        enter: () => { BatchMgr.active = true; BatchMgr.selectedIds.clear(); document.body.classList.add('batch-mode'); ContextMenu.hide(); }, 
        exit: () => { BatchMgr.active = false; BatchMgr.selectedIds.clear(); document.body.classList.remove('batch-mode'); document.querySelectorAll('.post-card').forEach(el => el.classList.remove('selected')); }, 
        toggleSelect: (id, cardEl) => { if(BatchMgr.selectedIds.has(id)) { BatchMgr.selectedIds.delete(id); cardEl.classList.remove('selected'); } else { BatchMgr.selectedIds.add(id); cardEl.classList.add('selected'); } }, 
        deleteSelected: async () => { 
            if(BatchMgr.selectedIds.size === 0) return; 
            if(confirm(`ç¡®å®šåˆ é™¤é€‰ä¸­çš„ ${BatchMgr.selectedIds.size} ç¯‡å†…å®¹ï¼Ÿ`)) { 
                for (let id of BatchMgr.selectedIds) { await DBMgr.deletePost(id); } 
                BatchMgr.exit(); 
                HomeRenderer.resetAndRender(); 
                HtmlHomeRenderer.render(); 
            } 
        }, 
        addToCollection: async () => { if(BatchMgr.selectedIds.size === 0) return; ContextMenu.showCollectionSelector(Array.from(BatchMgr.selectedIds)); } 
    };
    
    const ThemeMgr = {
        init: () => {
            const fs = localStorage.getItem('theme_font_size') || '13.5';
            document.documentElement.style.setProperty('--app-font-size', fs + 'px');
            const slider = document.getElementById('fontSizeSlider');
            if(slider) { slider.value = fs; document.getElementById('font-size-val').innerText = fs + 'px'; }

            if(localStorage.getItem('global_bg')) document.getElementById('global-bg-layer').style.backgroundImage = `url(${localStorage.getItem('global_bg')})`;
            // æ³¨æ„ï¼šé¡¶éƒ¨æ ç°åœ¨å¼ºåˆ¶é€æ˜ï¼Œä¸å†è¯»å– theme_top_bg
            if(localStorage.getItem('theme_bottom_bg')) document.documentElement.style.setProperty('--bottom-bar-bg', `url(${localStorage.getItem('theme_bottom_bg')})`); 
            if(localStorage.getItem('theme_post_bg')) document.documentElement.style.setProperty('--post-card-bg', `url(${localStorage.getItem('theme_post_bg')})`); 
            
            const defaultIcons = ['<svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="9 22 9 12 15 12 15 22"/></svg>', '<svg viewBox="0 0 24 24"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>', '<svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>', '<svg viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>', '<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>']; 
            for(let i=0; i<5; i++) { 
                const iconSrc = localStorage.getItem(`theme_icon_${i}`); 
                const preview = document.getElementById(`icon${i+1}Preview`); 
                if(iconSrc) { ThemeMgr.renderIcon(i, iconSrc); if(preview) preview.src = iconSrc; } 
                else if(preview) { const svgString = defaultIcons[i].replace('<svg ', '<svg xmlns="http://www.w3.org/2000/svg" stroke="#999" fill="none" stroke-width="2" '); preview.src = 'data:image/svg+xml;base64,' + btoa(svgString); } 
            } 
        }, 
        renderIcon: (index, src) => { 
            const nav = document.getElementById(`nav-${index}`); if(!nav) return; 
            if(index === 2) { const plusIcon = nav.querySelector('.nav-icon-plus') || nav; plusIcon.innerHTML = `<img src="${src}" style="width:100%; height:100%; object-fit:cover; border-radius:8px;">`; if(plusIcon.classList.contains('nav-icon-plus')) plusIcon.style.background = 'transparent'; } 
            else { nav.innerHTML = `<img src="${src}" class="custom-nav-icon">`; } 
            const preview = document.getElementById(`icon${index+1}Preview`); if(preview) preview.src = src; 
        }, 
        setIcon: (index, input) => { if (input.files && input.files[0]) { Utils.fileToBase64(input.files[0], (base64) => { localStorage.setItem(`theme_icon_${index}`, base64); ThemeMgr.renderIcon(index, base64); }); } }, 
        setBarBg: (type, input) => { if (input.files && input.files[0]) { Utils.fileToBase64(input.files[0], (base64) => { localStorage.setItem(`theme_${type}_bg`, base64); document.documentElement.style.setProperty(`--${type}-bar-bg`, `url(${base64})`); }); } },
        setFontSize: (val) => {
            document.documentElement.style.setProperty('--app-font-size', val + 'px');
            document.getElementById('font-size-val').innerText = val + 'px';
            localStorage.setItem('theme_font_size', val);
        },
        setPostBg: async (input) => {
            if (input.files && input.files[0]) { 
                const compressed = await Utils.compressImage(input.files[0], 1024, 0.7);
                Utils.fileToBase64(compressed, (base64) => { 
                    try {
                        localStorage.setItem('theme_post_bg', base64); 
                        document.documentElement.style.setProperty('--post-card-bg', `url(${base64})`); 
                        alert('å…¨å±€åç‰‡èƒŒæ™¯å·²æ›´æ–°');
                    } catch (e) {
                        alert('å›¾ç‰‡å¤ªå¤§ï¼Œæ— æ³•ä¿å­˜åˆ°é…ç½®ä¸­ï¼Œè¯·æ¢ä¸€å¼ å°å›¾');
                    }
                }); 
                input.value = ''; 
            } 
        }, 
        resetAll: () => { if(confirm('é‡ç½®ç¾åŒ–ï¼Ÿ')) { Object.keys(localStorage).forEach(key => { if(key.startsWith('theme_') || key === 'global_bg') localStorage.removeItem(key); }); location.reload(); } }
    };

    const FontMgr = {
        currentFontId: null,
        init: async () => {
            // åŠ è½½å·²ä¿å­˜çš„å­—ä½“
            const fonts = await DBMgr.getAllFonts();
            for (const font of fonts) {
                await FontMgr.loadFontFace(font);
            }
            // åº”ç”¨ä¸Šæ¬¡é€‰æ‹©çš„å­—ä½“
            const savedId = localStorage.getItem('theme_font_id');
            if (savedId) {
                const target = fonts.find(f => f.id == savedId);
                if (target) FontMgr.applyFont(target, true);
                else FontMgr.resetFont(true);
            }
        },
        loadFontFace: async (font) => {
            try {
                let source;
                if (font.type === 'url') {
                    source = `url(${font.data})`;
                } else {
                    // Blob è½¬æ¢ä¸º URL
                    const blobUrl = URL.createObjectURL(font.data);
                    source = `url(${blobUrl})`;
                }
                const fontFace = new FontFace(font.name, source);
                await fontFace.load();
                document.fonts.add(fontFace);
            } catch (e) {
                console.error('åŠ è½½å­—ä½“å¤±è´¥:', font.name, e);
            }
        },
        showMenu: async () => {
            const fonts = await DBMgr.getAllFonts();
            const currentId = localStorage.getItem('theme_font_id');
            const listEl = document.getElementById('font-list-container');
            
            let html = `<div class="menu-item ${!currentId ? 'active' : ''}" onclick="FontMgr.resetFont()">
                <div style="flex:1; text-align:left;">ç³»ç»Ÿé»˜è®¤</div>
                ${!currentId ? 'âœ“' : ''}
            </div>`;
            
            html += fonts.map(f => {
                const isActive = currentId == f.id;
                return `<div class="menu-item ${isActive ? 'active' : ''}" style="justify-content:space-between;">
                    <div style="flex:1; text-align:left; font-family:'${f.name}'; font-size:1.19rem;" onclick="FontMgr.applyById(${f.id})">${f.name}</div>
                    <div style="display:flex; gap:10px; align-items:center;">
                        ${isActive ? 'âœ“' : ''}
                        <div style="color:#ff4d4f; font-size:1.33rem; padding:0 10px;" onclick="FontMgr.delete(${f.id}, event)">Ã—</div>
                    </div>
                </div>`;
            }).join('');
            
            if (fonts.length === 0) {
                html += `<div style="padding:20px; text-align:center; color:#999; font-size:0.89rem;">æš‚æ— è‡ªå®šä¹‰å­—ä½“</div>`;
            }

            listEl.innerHTML = html;
            document.getElementById('fontOverlay').style.display = 'flex';
        },
        addFontClick: () => {
            document.getElementById('addFontOverlay').style.display = 'flex';
        },
        addByUrl: async () => {
            const url = prompt('è¯·è¾“å…¥å­—ä½“æ–‡ä»¶ URL (ttf/woff/otf):');
            if (!url) return;
            let name = prompt('è¯·è¾“å…¥å­—ä½“åç§°:', 'ç½‘ç»œå­—ä½“');
            if(!name) name = 'Font';
            name += '_' + Date.now(); // URLæ–¹å¼å»ºè®®ä¿ç•™æ—¶é—´æˆ³é¿å…é‡å¤
            // å°è¯•åŠ è½½éªŒè¯
            document.getElementById('loadingMask').style.display = 'flex';
            document.getElementById('loadingText').innerText = 'æ­£åœ¨éªŒè¯å­—ä½“...';
            try {
                const fontFace = new FontFace(name, `url(${url})`);
                await fontFace.load();
                // ä¿å­˜
                const newFont = { id: Date.now(), name: name, type: 'url', data: url };
                await DBMgr.saveFont(newFont);
                await FontMgr.loadFontFace(newFont);
                FontMgr.applyFont(newFont);
                document.getElementById('addFontOverlay').style.display = 'none';
                FontMgr.showMenu();
            } catch(e) {
                alert('å­—ä½“åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥URLæ˜¯å¦æœ‰æ•ˆä¸”å…è®¸è·¨åŸŸ');
            } finally {
                document.getElementById('loadingMask').style.display = 'none';
            }
        },
        handleFileSelect: async (input) => {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                let customName = prompt('ç»™å­—ä½“èµ·ä¸ªåå­— (ç•™ç©ºä½¿ç”¨æ–‡ä»¶å):');
                if (customName === null) { input.value = ''; return; } // å–æ¶ˆ
                
                let name = customName.trim();
                if (!name) name = file.name.split('.')[0];
                
                document.getElementById('loadingMask').style.display = 'flex';
                document.getElementById('loadingText').innerText = 'æ­£åœ¨å¤„ç†å­—ä½“...';
                
                try {
                    // è¯»å–ä¸º Blob ç›´æ¥ä¿å­˜ (æ¯” Base64 çœç©ºé—´ä¸”æ€§èƒ½æ›´å¥½)
                    const newFont = { id: Date.now(), name: name, type: 'blob', data: file };
                    
                    // éªŒè¯
                    const blobUrl = URL.createObjectURL(file);
                    const fontFace = new FontFace(name, `url(${blobUrl})`);
                    await fontFace.load();
                    
                    await DBMgr.saveFont(newFont);
                    await FontMgr.loadFontFace(newFont);
                    FontMgr.applyFont(newFont);
                    
                    document.getElementById('addFontOverlay').style.display = 'none';
                    FontMgr.showMenu();
                } catch(e) {
                    console.error(e);
                    alert('å­—ä½“æ–‡ä»¶è§£æå¤±è´¥');
                } finally {
                    input.value = '';
                    document.getElementById('loadingMask').style.display = 'none';
                }
            }
        },
        applyById: async (id) => {
            const fonts = await DBMgr.getAllFonts();
            const target = fonts.find(f => f.id == id);
            if(target) FontMgr.applyFont(target);
        },
        applyFont: (font, silent = false) => {
            document.documentElement.style.setProperty('--app-font', `"${font.name}", var(--default-font)`);
            localStorage.setItem('theme_font_id', font.id);
            localStorage.setItem('theme_font_name', font.name);
            document.getElementById('current-font-name').innerText = font.name;
            if (!silent) FontMgr.showMenu(); // åˆ·æ–°é€‰ä¸­çŠ¶æ€
        },
        resetFont: (silent = false) => {
            document.documentElement.style.setProperty('--app-font', 'var(--default-font)');
            localStorage.removeItem('theme_font_id');
            localStorage.removeItem('theme_font_name');
            document.getElementById('current-font-name').innerText = 'é»˜è®¤';
            if (!silent) FontMgr.showMenu();
        },
        delete: async (id, e) => {
            e.stopPropagation();
            if(confirm('ç¡®å®šåˆ é™¤æ­¤å­—ä½“ï¼Ÿ')) {
                await DBMgr.deleteFont(id);
                if (localStorage.getItem('theme_font_id') == id) {
                    FontMgr.resetFont();
                }
                FontMgr.showMenu();
            }
        }
    };

    const GitHubMgr = {
        config: { token: '', repo: '', auto: false, interval: 48, lastTime: 0 },
        init: () => {
            const confStr = localStorage.getItem('gh_config');
            if(confStr) GitHubMgr.config = JSON.parse(confStr);
            // å¡«å…… UI
            const tokenInput = document.getElementById('gh-token-input');
            const repoInput = document.getElementById('gh-repo-input');
            const autoSwitch = document.getElementById('gh-auto-switch');
            if(tokenInput) tokenInput.value = GitHubMgr.config.token || '';
            if(repoInput) repoInput.value = GitHubMgr.config.repo || '';
            if(autoSwitch) {
                autoSwitch.checked = GitHubMgr.config.auto || false;
                document.getElementById('gh-interval-setting').style.display = autoSwitch.checked ? 'flex' : 'none';
            }
            if(document.getElementById('gh-interval-select')) {
                document.getElementById('gh-interval-select').value = GitHubMgr.config.interval || 48;
            }
            
            if(GitHubMgr.config.auto) GitHubMgr.checkAndBackup();
            GitHubMgr.updateStatusText();
        },
        saveConfig: () => {
            const token = document.getElementById('gh-token-input').value.trim();
            const repo = document.getElementById('gh-repo-input').value.trim();
            const auto = document.getElementById('gh-auto-switch').checked;
            const interval = parseInt(document.getElementById('gh-interval-select').value);
            
            GitHubMgr.config.token = token;
            GitHubMgr.config.repo = repo;
            GitHubMgr.config.auto = auto;
            GitHubMgr.config.interval = interval;
            
            document.getElementById('gh-interval-setting').style.display = auto ? 'flex' : 'none';
            
            localStorage.setItem('gh_config', JSON.stringify(GitHubMgr.config));
            GitHubMgr.updateStatusText();
        },
        updateStatusText: () => {
            const el = document.getElementById('gh-status-msg');
            if(!el) return;
            if(!GitHubMgr.config.lastTime) el.innerText = 'ä»æœªå¤‡ä»½è¿‡';
            else {
                const date = new Date(GitHubMgr.config.lastTime);
                const nextTime = new Date(GitHubMgr.config.lastTime + (GitHubMgr.config.interval || 48) * 3600000);
                el.innerText = `ä¸Šæ¬¡: ${date.toLocaleString()} (ä¸‹æ¬¡çº¦: ${nextTime.toLocaleString()})`;
            }
        },
        checkAndBackup: async () => {
            if(!GitHubMgr.config.token || !GitHubMgr.config.repo || !GitHubMgr.config.auto) return;
            const now = Date.now();
            const interval = GitHubMgr.config.interval || 48;
            const hours = (now - (GitHubMgr.config.lastTime || 0)) / (1000 * 60 * 60);
            if(hours >= interval) {
                console.log(`è·ç¦»ä¸Šæ¬¡å¤‡ä»½å·²è¿‡ ${hours.toFixed(1)} å°æ—¶ (è®¾å®š:${interval}h)ï¼Œè§¦å‘è‡ªåŠ¨å¤‡ä»½...`);
                // é™é»˜å¤‡ä»½ï¼Œä¸åœ¨å‰å°å¼¹çª—æ‰“æ‰°ï¼Œä½†åœ¨æ§åˆ¶å°è¾“å‡ºï¼Œæˆ–è€…æ˜¾ç¤ºä¸€ä¸ªå°toast
                // ç”±äºç”Ÿæˆzipæ¯”è¾ƒè€—èµ„æºï¼Œè¿™é‡Œè¿˜æ˜¯å»ºè®®æ˜¾ç¤ºä¸€ä¸ªä¸é˜»å¡çš„loadingæˆ–è€…æç¤º
                const toast = document.createElement('div');
                toast.style.cssText = 'position:fixed; top:10px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.7); color:#fff; padding:8px 15px; border-radius:20px; font-size:12px; z-index:9999; pointer-events:none; transition:opacity 0.5s;';
                toast.innerText = 'æ­£åœ¨åå°å‡†å¤‡è‡ªåŠ¨å¤‡ä»½...';
                document.body.appendChild(toast);
                
                try {
                    await GitHubMgr.performUpload((msg) => { toast.innerText = 'è‡ªåŠ¨å¤‡ä»½: ' + msg; });
                    toast.innerText = 'è‡ªåŠ¨å¤‡ä»½æˆåŠŸï¼';
                    setTimeout(() => toast.remove(), 3000);
                } catch(e) {
                    console.error('è‡ªåŠ¨å¤‡ä»½å¤±è´¥', e);
                    toast.innerText = 'è‡ªåŠ¨å¤‡ä»½å¤±è´¥: ' + e.message;
                    setTimeout(() => toast.remove(), 5000);
                }
            }
        },
        testUpload: async () => {
            if(!GitHubMgr.config.token || !GitHubMgr.config.repo) return alert('è¯·å…ˆå¡«å†™ Token å’Œ ä»“åº“è·¯å¾„');
            document.getElementById('loadingMask').style.display = 'flex';
            try {
                await GitHubMgr.performUpload((msg) => { document.getElementById('loadingText').innerText = msg; });
                alert('ä¸Šä¼ æˆåŠŸï¼');
            } catch(e) {
                alert('ä¸Šä¼ å¤±è´¥: ' + e.message);
            } finally {
                document.getElementById('loadingMask').style.display = 'none';
            }
        },
        performUpload: async (onProgress) => {
            // 1. ç”Ÿæˆ ZIP
            onProgress('æ­£åœ¨æ‰“åŒ…æ•°æ®...');
            const zipBlob = await DBMgr.generateBackupZip('all', onProgress);
            
            // 2. è½¬ Base64
            onProgress('æ­£åœ¨ç¼–ç ...');
            const base64Content = await new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => {
                    const res = reader.result;
                    // remove "data:application/zip;base64," header
                    const base64 = res.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsDataURL(zipBlob);
            });

            // 3. ä¸Šä¼  GitHub
            onProgress('æ­£åœ¨ä¸Šä¼ è‡³ GitHub...');
            const dateStr = new Date().toISOString().slice(0, 10);
            const fileName = `AutoBackup_${dateStr}_${Date.now()}.zip`;
            const path = fileName; // æ ¹ç›®å½•
            
            const url = `https://api.github.com/repos/${GitHubMgr.config.repo}/contents/${path}`;
            
            const response = await fetch(url, {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${GitHubMgr.config.token}`,
                    'Content-Type': 'application/json',
                    'Accept': 'application/vnd.github.v3+json'
                },
                body: JSON.stringify({
                    message: `Auto backup ${dateStr}`,
                    content: base64Content
                })
            });

            if(!response.ok) {
                const errJson = await response.json();
                throw new Error(errJson.message || 'GitHub API Error');
            }

            // 4. æ›´æ–°æ—¶é—´
            GitHubMgr.config.lastTime = Date.now();
            localStorage.setItem('gh_config', JSON.stringify(GitHubMgr.config));
            GitHubMgr.updateStatusText();
        },
        checkStatus: async () => {
            if(!GitHubMgr.config.token || !GitHubMgr.config.repo) return alert('æœªé…ç½®');
            const url = `https://api.github.com/repos/${GitHubMgr.config.repo}`;
            try {
                const res = await fetch(url, { headers: { 'Authorization': `token ${GitHubMgr.config.token}` } });
                if(res.ok) {
                    const data = await res.json();
                    alert(`è¿æ¥æˆåŠŸï¼\nä»“åº“: ${data.full_name}\nç§æœ‰: ${data.private}\nè¯´æ˜: é…ç½®æœ‰æ•ˆ`);
                } else {
                    alert('è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ Token æˆ– ä»“åº“è·¯å¾„');
                }
            } catch(e) { alert('ç½‘ç»œé”™è¯¯: ' + e.message); }
        }
    };

    function handlePostClick(id, el) {
        if(BatchMgr.active) { BatchMgr.toggleSelect(id, el); } 
        else { if (document.getElementById('view-collection-detail').classList.contains('active')) { DetailRenderer.open(id, ColDetailMgr.currentColId); } else { DetailRenderer.open(id); } } 
    }

    let touchTimer = null; document.addEventListener('touchstart', (e) => { const card = e.target.closest('.post-card'); if(card && !BatchMgr.active) { touchTimer = setTimeout(() => { const evt = new MouseEvent('contextmenu', { bubbles: true, cancelable: true, view: window }); card.dispatchEvent(evt); }, 600); } }); document.addEventListener('touchend', () => clearTimeout(touchTimer)); document.addEventListener('touchmove', () => clearTimeout(touchTimer));
    function updateImage(input, elemId, type) { if (input.files && input.files[0]) { Utils.fileToBase64(input.files[0], (base64) => { if(type === 'bg') { document.getElementById(elemId).style.backgroundImage = `url(${base64})`; localStorage.setItem('profile_bg', base64); } else { document.getElementById(elemId).src = base64; localStorage.setItem('profile_avatar', base64); } }); } }
    function saveProfileMeta() { localStorage.setItem('profile_name', document.getElementById('userName').innerText); localStorage.setItem('profile_id', document.getElementById('userId').innerText); localStorage.setItem('profile_ip', document.getElementById('userIp').innerText); }
    function setGlobalBg(input) { if(input.files && input.files[0]) { Utils.fileToBase64(input.files[0], (base64) => { document.getElementById('global-bg-layer').style.backgroundImage = `url(${base64})`; localStorage.setItem('global_bg', base64); }); } }

    window.addEventListener('DOMContentLoaded', async () => {
        await DBMgr.init();
        if(localStorage.getItem('profile_bg')) document.getElementById('profileBg').style.backgroundImage = `url(${localStorage.getItem('profile_bg')})`;
        if(localStorage.getItem('profile_avatar')) document.getElementById('avatarImg').src = localStorage.getItem('profile_avatar');
        if(localStorage.getItem('profile_name')) document.getElementById('userName').innerText = localStorage.getItem('profile_name');
        if(localStorage.getItem('profile_id')) document.getElementById('userId').innerText = localStorage.getItem('profile_id');
        if(localStorage.getItem('profile_ip')) document.getElementById('userIp').innerText = localStorage.getItem('profile_ip');
        ThemeMgr.init();
        FontMgr.init(); // åˆå§‹åŒ–å­—ä½“
        GitHubMgr.init(); // åˆå§‹åŒ– GitHub å¤‡ä»½
        HomeRenderer.updateIcon();
        HomeRenderer.resetAndRender();

        document.addEventListener('plusready', function(){
            console.log("APPç¯å¢ƒå°±ç»ªï¼Œè®¾ç½®å…¨å±");
            plus.navigator.setFullscreen(true);
        });
    });
</script>
</body>